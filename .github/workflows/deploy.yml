# Deploy PrimeBalance to Google Cloud Run
#
# Deploys automatically when changes are pushed to main branch.
# Uses Cloud Build (--source) to build, matching deploy.sh approach.
#
# ============================================================================
# SETUP INSTRUCTIONS
# ============================================================================
#
# 1. Enable Google Cloud APIs (run once):
#
#    gcloud services enable \
#      run.googleapis.com \
#      cloudbuild.googleapis.com \
#      sqladmin.googleapis.com \
#      iamcredentials.googleapis.com \
#      iam.googleapis.com
#
# 2. Create Workload Identity Pool and Provider:
#
#    # Create pool
#    gcloud iam workload-identity-pools create "github-pool" \
#      --location="global" \
#      --display-name="GitHub Actions Pool"
#
#    # Create provider (replace YOUR_GITHUB_ORG with your GitHub username or org)
#    gcloud iam workload-identity-pools providers create-oidc "github-provider" \
#      --location="global" \
#      --workload-identity-pool="github-pool" \
#      --display-name="GitHub Provider" \
#      --attribute-mapping="google.subject=assertion.sub,attribute.actor=assertion.actor,attribute.repository=assertion.repository" \
#      --issuer-uri="https://token.actions.githubusercontent.com"
#
# 3. Create a Service Account for GitHub Actions:
#
#    gcloud iam service-accounts create github-actions \
#      --display-name="GitHub Actions"
#
#    # Grant required roles (least-privilege)
#    PROJECT_ID=$(gcloud config get-value project)
#    SA_EMAIL="github-actions@${PROJECT_ID}.iam.gserviceaccount.com"
#
#    # Cloud Run developer: can deploy/update services (not delete or modify IAM)
#    gcloud projects add-iam-policy-binding $PROJECT_ID \
#      --member="serviceAccount:${SA_EMAIL}" \
#      --role="roles/run.developer"
#
#    # Cloud Build builder: sufficient for building images
#    gcloud projects add-iam-policy-binding $PROJECT_ID \
#      --member="serviceAccount:${SA_EMAIL}" \
#      --role="roles/cloudbuild.builds.builder"
#
#    # Service Account User: required to deploy as compute service account
#    gcloud projects add-iam-policy-binding $PROJECT_ID \
#      --member="serviceAccount:${SA_EMAIL}" \
#      --role="roles/iam.serviceAccountUser"
#
#    # Cloud SQL client: for database connections
#    gcloud projects add-iam-policy-binding $PROJECT_ID \
#      --member="serviceAccount:${SA_EMAIL}" \
#      --role="roles/cloudsql.client"
#
#    # Artifact Registry writer: for pushing container images
#    gcloud projects add-iam-policy-binding $PROJECT_ID \
#      --member="serviceAccount:${SA_EMAIL}" \
#      --role="roles/artifactregistry.writer"
#
# 4. Allow GitHub to impersonate the Service Account:
#    (Replace YOUR_GITHUB_ORG/YOUR_REPO with your actual repo)
#
#    gcloud iam service-accounts add-iam-policy-binding $SA_EMAIL \
#      --role="roles/iam.workloadIdentityUser" \
#      --member="principalSet://iam.googleapis.com/projects/${PROJECT_NUMBER}/locations/global/workloadIdentityPools/github-pool/attribute.repository/YOUR_GITHUB_ORG/YOUR_REPO"
#
# 5. Get the Workload Identity Provider path:
#
#    PROJECT_NUMBER=$(gcloud projects describe $PROJECT_ID --format="value(projectNumber)")
#    echo "projects/${PROJECT_NUMBER}/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
#
# 6. Add these GitHub Repository Secrets (Settings > Secrets > Actions):
#
#    Required:
#    - GCP_PROJECT_ID         : Your Google Cloud project ID
#    - GCP_WORKLOAD_IDENTITY_PROVIDER : The full path from step 5
#    - GCP_SERVICE_ACCOUNT    : github-actions@PROJECT_ID.iam.gserviceaccount.com
#    - DB_INSTANCE            : Cloud SQL instance name
#    - DB_NAME                : Database name
#    - DB_USER                : Database user
#    - DB_PASSWORD            : Database password
#    - NEXTAUTH_SECRET        : NextAuth secret key
#
#    Optional (for OAuth):
#    - GOOGLE_CLIENT_ID
#    - GOOGLE_CLIENT_SECRET
#    - APP_GITHUB_ID          : GitHub OAuth App ID (renamed to avoid conflict)
#    - APP_GITHUB_SECRET      : GitHub OAuth App Secret
#
# ============================================================================

name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      region:
        description: 'Deployment region'
        required: true
        default: 'eu'
        type: choice
        options:
          - eu
          - na

env:
  SERVICE: primebalance

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set region
        id: region
        run: |
          if [ "${{ github.event.inputs.region }}" = "na" ]; then
            echo "value=us-central1" >> $GITHUB_OUTPUT
          else
            echo "value=europe-west6" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Build Cloud SQL connection string
        id: db
        run: |
          SQL_CONNECTION="${{ secrets.GCP_PROJECT_ID }}:${{ steps.region.outputs.value }}:${{ secrets.DB_INSTANCE }}"
          DATABASE_URL="postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@localhost/${{ secrets.DB_NAME }}?host=/cloudsql/${SQL_CONNECTION}"
          echo "sql_connection=${SQL_CONNECTION}" >> $GITHUB_OUTPUT
          echo "database_url=${DATABASE_URL}" >> $GITHUB_OUTPUT

      - name: Get current service URL
        id: current-url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE }} \
            --region=${{ steps.region.outputs.value }} \
            --format="value(status.url)" 2>/dev/null || echo "")
          if [ -z "$URL" ]; then
            URL="https://${{ env.SERVICE }}-placeholder.${{ steps.region.outputs.value }}.run.app"
          fi
          echo "url=${URL}" >> $GITHUB_OUTPUT

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          gcloud run deploy ${{ env.SERVICE }} \
            --source . \
            --region "${{ steps.region.outputs.value }}" \
            --platform managed \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --port 8080 \
            --add-cloudsql-instances="${{ steps.db.outputs.sql_connection }}" \
            --set-env-vars="^##^NODE_ENV=production##NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}##NEXTAUTH_URL=${{ steps.current-url.outputs.url }}##GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}##GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}##GITHUB_ID=${{ secrets.APP_GITHUB_ID }}##GITHUB_SECRET=${{ secrets.APP_GITHUB_SECRET }}##DATABASE_URL=${{ steps.db.outputs.database_url }}##CLOUD_SQL_CONNECTION_NAME=${{ steps.db.outputs.sql_connection }}##DB_NAME=${{ secrets.DB_NAME }}##DB_USER=${{ secrets.DB_USER }}##DB_PASSWORD=${{ secrets.DB_PASSWORD }}"

      - name: Get deployed URL and update NEXTAUTH_URL
        id: deployed
        run: |
          ACTUAL_URL=$(gcloud run services describe ${{ env.SERVICE }} \
            --region=${{ steps.region.outputs.value }} \
            --format="value(status.url)")

          echo "url=${ACTUAL_URL}" >> $GITHUB_OUTPUT

          EXPECTED_URL="${{ steps.current-url.outputs.url }}"
          if [ "$ACTUAL_URL" != "$EXPECTED_URL" ]; then
            echo "Updating NEXTAUTH_URL to: $ACTUAL_URL"
            gcloud run services update ${{ env.SERVICE }} \
              --region="${{ steps.region.outputs.value }}" \
              --update-env-vars="NEXTAUTH_URL=${ACTUAL_URL}" \
              --quiet
          fi

      - name: Deployment summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Service URL** | ${{ steps.deployed.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Region** | ${{ steps.region.outputs.value }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Database** | ${{ steps.db.outputs.sql_connection }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
