// prisma/schema.prisma
// CHANGE: Extended with all business models, organization-scoped

// NEW (Prisma 7)
generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// NEXTAUTH MODELS (existing, modified)
// =============================================================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  role          String    @default("member") // owner, admin, member

  // Relations
  accounts          Account[]
  sessions          Session[]
  organizationId    String?
  organization      Organization?     @relation(fields: [organizationId], references: [id])
  orders            Order[]
  settings          UserSettings?
  wallets           Wallet[]
  chatMessages      ChatMessage[]
  aiSuggestions     AISuggestion[]
  savedReports      SavedReport[]
  corporateEntities CorporateEntity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// =============================================================================
// ORGANIZATION
// =============================================================================

model Organization {
  id              String  @id @default(cuid())
  name            String
  slug            String  @unique
  country         String  @default("CH")
  industry        String?
  fiscalYearEnd   String  @default("12-31") // MM-DD
  defaultCurrency String  @default("USD")
  taxId           String?

  // Relations
  users             User[]
  transactions      Transaction[]
  financialAccounts FinancialAccount[]
  receipts          Receipt[]
  chatChannels      ChatChannel[]
  orders            Order[]
  archiveItems      ArchiveItem[]
  liabilities       Liability[]
  inventoryItems    InventoryItem[]
  receivables       Receivable[]

  treasuryAccounts     TreasuryAccount[]
  capitalBuckets       CapitalBucket[]
  creditFacilities     CreditFacility[]
  treasuryDecisions    TreasuryDecision[]
  treasuryScenarios    TreasuryScenario[]
  nettingOpportunities NettingOpportunity[]

  assets         Asset[]
  assetDisposals AssetDisposal[]
  capExBudgets   CapExBudget[]

  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  Invoice                Invoice[]
  Project                Project[]
  CostCenter             CostCenter[]
  timeEntries            TimeEntry[]
  internalChargebacks    InternalChargeback[]
  accountingPeriods      AccountingPeriod[]
  periodAdjustments      PeriodAdjustment[]
  customers              Customer[]
  customerPayments       CustomerPayment[]
  customerCreditEvents   CustomerCreditEvent[]
  suppliers              Supplier[]
  offers                 Offer[]
  tasks                  Task[]
  scenarios              Scenario[]
  kpis                   KPI[]
  fxexposures            FXExposure[]
  fxrates                FXRate[]
  liquidityPositions     LiquidityPosition[]
  fxconversions          FXConversion[]
  offerTemplates         OfferTemplate[]
  revenueForecasts       RevenueForecast[]
  costForecasts          CostForecast[]
  cashForecasts          CashForecast[]
  forecastScenarios      ForecastScenario[]
  forecastAlerts         ForecastAlert[]
  forecastVariances      ForecastVariance[]
  stressTests            StressTest[]
  simulationStates       SimulationState[]
  fxscenarios            FXScenario[]
  fxforecasts            FXForecast[]
  fxcosts                FXCost[]
  fxriskIndicators       FXRiskIndicator[]
  fxauditLogs            FXAuditLog[]
  investorSnapshots      InvestorSnapshot[]
  boardReports           BoardReport[]
  runwayProjections      RunwayProjection[]
  investorAccessLogs     InvestorAccessLog[]
  kpialerts              KPIAlert[]
  nettingAgreements      NettingAgreement[]
  nettingSessions        NettingSession[]
  settlementInstructions SettlementInstruction[]
  offsetEntries          OffsetEntry[]
  cashflowItems          CashflowItem[]
  liquidityScenarios     LiquidityScenario[]
  liquidityGaps          LiquidityGap[]
  liquidityRiskSignals   LiquidityRiskSignal[]
  liquidityAuditLogs     LiquidityAuditLog[]
  taskTags               TaskTag[]
  risks                  Risk[]
  taskNotifications      TaskNotification[]
  savedTaskFilters       SavedTaskFilter[]
}

// =============================================================================
// FINANCIAL ACCOUNTS (Chart of Accounts)
// =============================================================================

model FinancialAccount {
  id            String  @id @default(cuid())
  name          String
  accountNumber String
  type          String // asset, liability, equity, revenue, expense, bank, crypto
  balance       Float   @default(0)
  currency      String  @default("USD")
  isActive      Boolean @default(true)
  description   String?

  // Hierarchy
  parentId String?
  parent   FinancialAccount?  @relation("AccountHierarchy", fields: [parentId], references: [id])
  children FinancialAccount[] @relation("AccountHierarchy")

  // Organization scope
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, accountNumber])
}

// =============================================================================
// TRANSACTIONS
// =============================================================================

model Transaction {
  id          String   @id @default(cuid())
  date        DateTime
  description String
  amount      Float
  currency    String   @default("USD")
  type        String // income, expense, transfer
  category    String?
  status      String   @default("pending") // pending, completed, cancelled
  tags        String[] // PostgreSQL array

  // Blockchain
  tokenized Boolean @default(false)
  txHash    String?

  // Relations
  accountId      String
  account        FinancialAccount @relation(fields: [accountId], references: [id])
  organizationId String
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  receipts       Receipt[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, date])
  @@index([organizationId, type])
  @@index([organizationId, status])
}

// =============================================================================
// RECEIPTS
// =============================================================================

// UPDATE: Add deletedAt, status, category fields to Receipt model

model Receipt {
  id       String @id @default(cuid())
  fileName String
  fileUrl  String
  fileType String // pdf, image, etc.
  fileSize Int

  // OCR/AI extracted data
  vendor        String?
  amount        Float?
  date          DateTime?
  extractedText String?   @db.Text
  confidence    Float? // AI confidence score
  category      String?

  // Status tracking
  status String @default("pending") // pending, matched, unmatched, archived, deleted

  // Soft delete with 12-hour restore window
  deletedAt DateTime?

  // Relations
  transactionId  String?
  transaction    Transaction? @relation(fields: [transactionId], references: [id])
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([deletedAt])
}

// =============================================================================
// TEAM CHAT
// =============================================================================

model ChatChannel {
  id          String  @id @default(cuid())
  name        String
  description String?
  type        String  @default("public") // public, private, direct

  // Organization scope
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  messages ChatMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, name])
}

model ChatMessage {
  id      String @id @default(cuid())
  content String @db.Text

  // Relations
  channelId String
  channel   ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([channelId, createdAt])
}

// =============================================================================
// USER SETTINGS
// =============================================================================

model UserSettings {
  id String @id @default(cuid())

  // Preferences
  language   String @default("en")
  timezone   String @default("Europe/Zurich")
  currency   String @default("USD")
  dateFormat String @default("DD.MM.YYYY")
  theme      String @default("dark")

  // Notifications
  emailNotifications        Boolean @default(true)
  pushNotifications         Boolean @default(true)
  transactionNotifications  Boolean @default(true)
  reportNotifications       Boolean @default(true)
  aiSuggestionNotifications Boolean @default(true)

  // Relations
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =============================================================================
// CRYPTO WALLETS - Enhanced
// =============================================================================

model Wallet {
  id       String  @id @default(cuid())
  name     String
  address  String
  network  String // ethereum, polygon, arbitrum, optimism, base, solana, bitcoin
  provider String? // metamask, walletconnect, coinbase, phantom, ledger, manual

  // Status
  isActive   Boolean @default(true)
  isWatching Boolean @default(false) // Watch-only wallet (not owned)

  // Balances (cached, updated on sync)
  nativeBalance  Decimal   @default(0) @db.Decimal(30, 18) // ETH, SOL, BTC etc.
  nativeSymbol   String    @default("ETH")
  totalValueUsd  Decimal   @default(0) @db.Decimal(15, 2)
  lastSyncAt     DateTime?
  lastSyncStatus String? // success, failed, pending

  // Classification
  walletType String @default("hot") // hot, cold, hardware, multisig, smart_contract
  purpose    String @default("operations") // operations, treasury, payroll, investments, personal

  // Metadata
  ens       String? // ENS name if available
  avatar    String? // Avatar URL
  notes     String?
  tags      String[]
  isDefault Boolean  @default(false)

  // Relations
  userId         String
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String?
  tokens         WalletToken[]
  transactions   WalletTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, address, network])
  @@index([userId])
  @@index([organizationId])
}

model WalletToken {
  id String @id @default(cuid())

  // Token Info
  contractAddress String
  symbol          String
  name            String
  decimals        Int     @default(18)
  logoUrl         String?

  // Balance
  balance        Decimal  @default(0) @db.Decimal(30, 18)
  balanceUsd     Decimal  @default(0) @db.Decimal(15, 2)
  priceUsd       Decimal  @default(0) @db.Decimal(20, 8)
  price24hChange Decimal? @db.Decimal(8, 4)

  // Classification
  tokenType String @default("erc20") // erc20, erc721, erc1155, spl, native

  // Tracking
  isHidden    Boolean   @default(false)
  isSpam      Boolean   @default(false)
  lastPriceAt DateTime?

  // Relations
  walletId String
  wallet   Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([walletId, contractAddress])
  @@index([walletId])
}

model WalletTransaction {
  id String @id @default(cuid())

  // Transaction Info
  hash        String
  blockNumber Int?
  network     String

  // Type
  type   String // send, receive, swap, approve, mint, burn, contract_interaction, bridge
  status String @default("confirmed") // pending, confirmed, failed

  // Parties
  fromAddress String
  toAddress   String?
  isIncoming  Boolean

  // Value
  value        Decimal  @db.Decimal(30, 18)
  valueUsd     Decimal? @db.Decimal(15, 2)
  tokenSymbol  String?
  tokenAddress String?

  // Gas
  gasUsed    Decimal? @db.Decimal(30, 0)
  gasPrice   Decimal? @db.Decimal(30, 0)
  gasCostUsd Decimal? @db.Decimal(15, 2)

  // Timestamps
  timestamp   DateTime
  confirmedAt DateTime?

  // Metadata
  methodName  String? // Contract method called
  description String?
  notes       String?
  tags        String[]

  // Accounting Link
  linkedTransactionId String? // Link to main Transaction if categorized

  // Relations
  walletId String
  wallet   Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([walletId, hash])
  @@index([walletId, timestamp])
  @@index([walletId, type])
}

// =============================================================================
// AI SUGGESTIONS
// =============================================================================

model AISuggestion {
  id          String  @id @default(cuid())
  type        String // tax_optimization, categorization, anomaly, insight
  title       String
  description String  @db.Text
  impact      String?
  priority    String  @default("medium") // low, medium, high
  status      String  @default("pending") // pending, accepted, dismissed
  metadata    Json? // Additional context

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status])
}

// =============================================================================
// SAVED REPORTS
// =============================================================================

// UPDATE: prisma/schema.prisma - SavedReport model
// Add these fields to the existing SavedReport model

model SavedReport {
  id            String    @id @default(cuid())
  name          String
  type          String // PROFIT_LOSS, BALANCE_SHEET, CASH_FLOW, TAX_SUMMARY, EXPENSE_REPORT, INCOME_REPORT, AR_AGING, AP_AGING, etc.
  description   String?   @db.Text
  parameters    Json?
  isScheduled   Boolean   @default(false)
  scheduleFreq  String? // daily, weekly, monthly
  lastGenerated DateTime?

  // Status & Archive
  status     String    @default("active") // active, archived, deleted
  archivedAt DateTime?

  // Generated data cache
  cachedData  Json?
  cacheExpiry DateTime?

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, status])
}

// =============================================================================
// CORPORATE ENTITIES
// =============================================================================

model CorporateEntity {
  id                String    @id @default(cuid())
  name              String
  type              String // corporation, llc, partnership, sole_proprietorship
  jurisdiction      String
  taxId             String?
  incorporationDate DateTime?
  ownershipPercent  Decimal?  @db.Decimal(5, 2)
  revenue           Decimal?  @db.Decimal(15, 2)
  expenses          Decimal?  @db.Decimal(15, 2)
  taxLiability      Decimal?  @db.Decimal(15, 2)
  effectiveTaxRate  Decimal?  @db.Decimal(5, 2)
  isActive          Boolean   @default(true)

  // Hierarchy
  parentId String?
  parent   CorporateEntity?  @relation("EntityHierarchy", fields: [parentId], references: [id])
  children CorporateEntity[] @relation("EntityHierarchy")

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// =============================================================================
// INVOICES
// =============================================================================

// =============================================================================
// INVOICES (ENHANCED - Replace existing Invoice model)
// =============================================================================

model Invoice {
  id            String @id @default(cuid())
  invoiceNumber String
  status        String @default("draft") // draft, confirmed, sent, partially_paid, paid, overdue, cancelled, archived

  // Versioning (Immutability Support)
  version           Int     @default(1)
  isLatest          Boolean @default(true)
  previousVersionId String?

  // Customer Info (denormalized for immutability)
  customerId      String?
  customerName    String?
  customerEmail   String?
  customerTaxId   String?
  customerAddress Json?

  // Parties (stored as JSON for flexibility) - Legacy Support
  sender    Json? // InvoiceParty
  recipient Json? // InvoiceParty

  // Entity Info (our company)
  entityId      String?
  entityName    String?
  entityTaxId   String?
  entityAddress Json?

  // Dates
  invoiceDate        DateTime
  dueDate            DateTime
  serviceDate        DateTime?
  servicePeriodStart DateTime?
  servicePeriodEnd   DateTime?

  // Items & Totals
  items           Json    // InvoiceLineItem[]
  currency        String  @default("EUR")
  subtotal        Decimal @db.Decimal(15, 2)
  taxAmount       Decimal @db.Decimal(15, 2)
  taxableAmount   Decimal @default(0) @db.Decimal(15, 2)
  discountAmount  Decimal @default(0) @db.Decimal(15, 2)
  discountPercent Decimal @default(0) @db.Decimal(5, 2)
  total           Decimal @db.Decimal(15, 2)

  // Payment Tracking
  paidAmount        Decimal @default(0) @db.Decimal(15, 2)
  outstandingAmount Decimal @default(0) @db.Decimal(15, 2)

  // Tax
  applyTax          Boolean  @default(true)
  taxRate           Decimal  @db.Decimal(5, 2)
  taxClassification String? // standard, reduced, zero, exempt, reverse_charge
  taxExemptReason   String? // small_business, reverse_charge, export, other
  taxExemptNote     String?
  taxJurisdiction   String?

  // FX Tracking
  fxRateToBase Decimal? @db.Decimal(15, 6)
  fxRateDate   DateTime?
  baseCurrency String?
  totalInBase  Decimal? @db.Decimal(15, 2)

  // Fiscal Period
  fiscalYear   Int?
  fiscalPeriod String? // M01-M12

  // Payment Terms
  payment      Json?   // Legacy InvoicePayment object
  paymentTerms String? // due_on_receipt, net_7, net_14, net_30, net_45, net_60, net_90
  bankDetails  Json?

  // Lifecycle Timestamps
  confirmedAt DateTime?
  sentAt      DateTime?
  paidAt      DateTime?
  cancelledAt DateTime?
  archivedAt  DateTime?

  // Audit Trail
  createdBy          String?
  createdByName      String?
  confirmedBy        String?
  confirmedByName    String?
  cancelledBy        String?
  cancelledByName    String?
  cancellationReason String?

  // Meta
  notes         String?  @db.Text
  internalNotes String?  @db.Text
  language      String   @default("en")
  reference     String?
  poNumber      String?

  // Recurring
  isRecurring       Boolean   @default(false)
  recurringInterval String? // weekly, monthly, quarterly, yearly
  recurringEndDate  DateTime?
  nextRecurringDate DateTime?
  parentInvoiceId   String?

  // Source References (Inbound Flows)
  orderNumber  String?
  projectId    String?
  costCenterId String?

  // Outbound Links
  receivableId String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Link to order if created from order
  orderId String?
  order   Order?  @relation(fields: [orderId], references: [id])

  // Related Records (New)
  versions         InvoiceVersion[]
  accountingEvents InvoiceAccountingEvent[]
  payments         InvoicePayment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, invoiceNumber])
  @@index([organizationId, status])
  @@index([organizationId, dueDate])
  @@index([organizationId, customerId])
  @@index([organizationId, isLatest])
  @@index([organizationId, fiscalYear])
}

// =============================================================================
// INVOICE VERSION (Audit Trail / Immutability)
// =============================================================================

model InvoiceVersion {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Version Info
  version       Int
  snapshot      Json     // Full invoice state at this version
  changeType    String   // created, updated, confirmed, sent, payment_applied, cancelled, archived
  changeReason  String?
  changedFields String[] // List of fields that changed

  // Audit
  createdBy     String?
  createdByName String?
  createdAt     DateTime @default(now())

  @@index([invoiceId, version])
  @@index([invoiceId, changeType])
}

// =============================================================================
// INVOICE ACCOUNTING EVENT (Double-Entry Ledger Integration)
// =============================================================================

model InvoiceAccountingEvent {
  id        String  @id @default(cuid())
  eventId   String  @unique // Deterministic ID for idempotency
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Event Type
  eventType String // revenue_recognition, receivable_created, tax_liability, payment_received, write_off, reversal, discount_applied

  // Double-Entry Accounts
  debitAccountId    String?
  debitAccountCode  String
  debitAccountName  String
  creditAccountId   String?
  creditAccountCode String
  creditAccountName String

  // Amount
  amount   Decimal @db.Decimal(15, 2)
  currency String  @default("EUR")

  // Fiscal Period
  fiscalYear    Int
  fiscalPeriod  String // M01-M12
  effectiveDate DateTime

  // Status
  status          String    @default("posted") // posted, reversed, pending
  reversedAt      DateTime?
  reversalEventId String?

  // Meta
  description String?
  metadata    Json?

  createdAt DateTime @default(now())

  @@index([invoiceId, eventType])
  @@index([invoiceId, fiscalYear])
  @@index([eventType, status])
}

// =============================================================================
// INVOICE PAYMENT (Payment Application Records)
// =============================================================================

model InvoicePayment {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Payment Amount
  amount   Decimal @db.Decimal(15, 2)
  currency String  @default("EUR")

  // Payment Info
  paymentDate   DateTime
  paymentMethod String // bank_transfer, credit_card, direct_debit, cash, check, paypal, other

  // Bank/Transaction Details
  bankAccount    String?
  transactionRef String?
  transactionId  String?

  // Reference
  reference String?
  notes     String?

  // Status
  status String @default("completed") // pending, completed, failed, reversed

  // Links to other modules
  creditNoteId       String?
  offsetReceivableId String?
  treasuryMovementId String?

  // Audit
  appliedBy     String?
  appliedByName String?

  createdAt DateTime @default(now())

  @@index([invoiceId, paymentDate])
  @@index([invoiceId, status])
}
// =============================================================================
// ORDERS
// =============================================================================

model Order {
  id          String @id @default(cuid())
  orderNumber String
  status      String @default("draft") // draft, confirmed, in_progress, partially_completed, completed, cancelled

  // Customer
  customerId      String?
  customerName    String
  customerEmail   String?
  customerAddress Json? // Address object

  // Dates
  orderDate            DateTime
  expectedDeliveryDate DateTime?
  completedDate        DateTime?

  // Items
  items Json // OrderItem[]

  // Totals
  currency       String  @default("EUR")
  subtotal       Decimal @db.Decimal(15, 2)
  taxAmount      Decimal @db.Decimal(15, 2)
  discountAmount Decimal @default(0) @db.Decimal(15, 2)
  total          Decimal @db.Decimal(15, 2)

  // Tax
  taxRate Decimal @default(0) @db.Decimal(5, 2)

  // Fulfillment tracking
  fulfilledQuantity  Int     @default(0)
  totalQuantity      Int     @default(0)
  fulfillmentPercent Decimal @default(0) @db.Decimal(5, 2)

  // Invoicing tracking
  invoicedAmount Decimal @default(0) @db.Decimal(15, 2)
  paidAmount     Decimal @default(0) @db.Decimal(15, 2)

  // Meta
  notes         String?  @db.Text
  internalNotes String?  @db.Text
  tags          String[]
  priority      String   @default("normal") // low, normal, high, urgent

  // Recurring
  isRecurring       Boolean @default(false)
  recurringInterval String? // weekly, monthly, quarterly, yearly

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Invoices created from this order
  invoices Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User?    @relation(fields: [userId], references: [id])
  userId    String?

  @@unique([organizationId, orderNumber])
  @@index([organizationId, status])
  @@index([organizationId, orderDate])
  @@index([organizationId, customerId])
}

// =============================================================================
// ARCHIVE
// =============================================================================

model ArchiveItem {
  id String @id @default(cuid())

  // Category & Type
  category String // bookings, invoices, bank, services, documents, contracts
  status   String @default("archived") // archived, restored, deleted

  // Original reference
  originalId   String
  originalType String // transaction, invoice, order, contract, document, receipt

  // Content
  title       String
  description String?  @db.Text
  amount      Decimal? @db.Decimal(15, 2)
  currency    String   @default("EUR")

  // Counterparty
  counterparty String?

  // Dates
  itemDate   DateTime // Original item date
  archivedAt DateTime  @default(now())
  restoredAt DateTime?

  // Period tracking
  fiscalYear   Int?
  fiscalPeriod String? // Q1, Q2, Q3, Q4, or month

  // Meta
  tags        String[]
  attachments Json? // Array of attachment references
  metadata    Json? // Additional flexible data from original

  // Audit
  archivedBy    String?
  restoredBy    String?
  archiveReason String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, category])
  @@index([organizationId, fiscalYear])
  @@index([organizationId, status])
  @@index([organizationId, archivedAt])
}

// =============================================================================
// LIABILITIES
// =============================================================================

model Liability {
  id String @id @default(cuid())

  // Type & Status
  type   String // loan, credit_line, overdraft, supplier_credit, deferred_payment, lease, guarantee, other
  status String @default("active") // active, paid_off, defaulted, restructured, cancelled

  // Basic Info
  name        String
  description String? @db.Text
  reference   String? // External reference number

  // Counterparty
  counterpartyId   String?
  counterpartyName String
  counterpartyType String? // bank, supplier, investor, government, other

  // Amounts
  currency          String  @default("EUR")
  principalAmount   Decimal @db.Decimal(15, 2)
  outstandingAmount Decimal @db.Decimal(15, 2)
  paidAmount        Decimal @default(0) @db.Decimal(15, 2)

  // Credit facilities
  creditLimit     Decimal? @db.Decimal(15, 2)
  availableCredit Decimal? @db.Decimal(15, 2)
  utilizationRate Decimal? @db.Decimal(5, 2)

  // Interest
  interestRate    Decimal? @db.Decimal(5, 4)
  interestType    String? // fixed, variable, zero
  interestAccrued Decimal  @default(0) @db.Decimal(15, 2)

  // Dates
  startDate       DateTime
  maturityDate    DateTime?
  nextPaymentDate DateTime?
  lastPaymentDate DateTime?

  // Payment Schedule
  paymentFrequency String? // monthly, quarterly, annually, bullet, custom
  paymentAmount    Decimal? @db.Decimal(15, 2)
  paymentSchedule  Json? // Array of scheduled payments

  // Collateral & Security
  isSecured             Boolean  @default(false)
  collateralDescription String?
  collateralValue       Decimal? @db.Decimal(15, 2)

  // Covenants & Conditions
  covenants Json? // Array of covenant objects

  // Risk & Alerts
  riskLevel      String   @default("low") // low, medium, high, critical
  alertThreshold Decimal? @db.Decimal(5, 2) // % of limit for alerts

  // Meta
  tags        String[]
  notes       String?  @db.Text
  attachments Json?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Payment history
  payments LiabilityPayment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, type])
  @@index([organizationId, status])
  @@index([organizationId, maturityDate])
  @@index([organizationId, counterpartyId])
}

model LiabilityPayment {
  id String @id @default(cuid())

  // Payment details
  amount          Decimal @db.Decimal(15, 2)
  principalAmount Decimal @db.Decimal(15, 2)
  interestAmount  Decimal @default(0) @db.Decimal(15, 2)
  feesAmount      Decimal @default(0) @db.Decimal(15, 2)

  currency    String    @default("EUR")
  paymentDate DateTime
  dueDate     DateTime?

  // Status
  status String @default("completed") // scheduled, completed, missed, partial

  // Reference
  reference     String?
  transactionId String? // Link to Transaction if applicable

  // Meta
  notes String?

  // Relations
  liabilityId String
  liability   Liability @relation(fields: [liabilityId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([liabilityId, paymentDate])
}

// =============================================================================
// INVENTORY
// =============================================================================

model InventoryItem {
  id String @id @default(cuid())

  // Type & Status
  type   String // raw_material, work_in_progress, finished_goods, merchandise, consumables, packaging, spare_parts, other
  status String @default("active") // active, discontinued, out_of_stock, on_hold

  // Identification
  sku         String
  name        String
  description String? @db.Text
  barcode     String?

  // Category
  category    String?
  subcategory String?

  // Quantities
  quantityOnHand    Decimal @default(0) @db.Decimal(15, 4)
  quantityReserved  Decimal @default(0) @db.Decimal(15, 4)
  quantityAvailable Decimal @default(0) @db.Decimal(15, 4)
  quantityOnOrder   Decimal @default(0) @db.Decimal(15, 4)

  // Units
  unitOfMeasure String @default("pcs") // pcs, kg, m, l, etc.

  // Thresholds
  minimumStock    Decimal  @default(0) @db.Decimal(15, 4)
  maximumStock    Decimal? @db.Decimal(15, 4)
  reorderPoint    Decimal  @default(0) @db.Decimal(15, 4)
  reorderQuantity Decimal? @db.Decimal(15, 4)

  // Valuation
  currency         String   @default("EUR")
  unitCost         Decimal  @default(0) @db.Decimal(15, 4)
  averageCost      Decimal  @default(0) @db.Decimal(15, 4)
  lastPurchaseCost Decimal? @db.Decimal(15, 4)
  sellingPrice     Decimal? @db.Decimal(15, 4)
  totalValue       Decimal  @default(0) @db.Decimal(15, 2)

  // Costing method
  costingMethod String @default("average") // fifo, lifo, average, specific

  // Location
  warehouseId   String?
  warehouseName String?
  location      String? // Bin/shelf location
  zone          String?

  // Ownership
  ownershipType String  @default("owned") // owned, consignment, third_party
  supplierId    String?
  supplierName  String?

  // Tracking
  isSerialTracked Boolean @default(false)
  isBatchTracked  Boolean @default(false)
  isExpiryTracked Boolean @default(false)

  // Lead times
  leadTimeDays Int?

  // Dimensions (for shipping)
  weight        Decimal? @db.Decimal(10, 4)
  weightUnit    String? // kg, lb
  length        Decimal? @db.Decimal(10, 4)
  width         Decimal? @db.Decimal(10, 4)
  height        Decimal? @db.Decimal(10, 4)
  dimensionUnit String? // cm, in

  // Meta
  tags     String[]
  notes    String?  @db.Text
  imageUrl String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Movements
  movements InventoryMovement[]
  batches   InventoryBatch[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, sku])
  @@index([organizationId, type])
  @@index([organizationId, status])
  @@index([organizationId, category])
  @@index([organizationId, warehouseId])
}

model InventoryMovement {
  id String @id @default(cuid())

  // Movement type
  type String // receipt, issue, transfer, adjustment, return, scrap, count

  // Quantities
  quantity         Decimal @db.Decimal(15, 4)
  previousQuantity Decimal @db.Decimal(15, 4)
  newQuantity      Decimal @db.Decimal(15, 4)

  // Valuation
  unitCost  Decimal? @db.Decimal(15, 4)
  totalCost Decimal? @db.Decimal(15, 2)

  // Reference
  referenceType   String? // purchase_order, sales_order, transfer_order, adjustment
  referenceId     String?
  referenceNumber String?

  // Location
  fromWarehouseId String?
  fromLocation    String?
  toWarehouseId   String?
  toLocation      String?

  // Batch/Serial
  batchId      String?
  batch        InventoryBatch? @relation(fields: [batchId], references: [id])
  serialNumber String?

  // Meta
  reason      String?
  notes       String?
  performedBy String?

  // Dates
  movementDate DateTime @default(now())

  // Relations
  inventoryItemId String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([inventoryItemId, movementDate])
  @@index([inventoryItemId, type])
}

model InventoryBatch {
  id String @id @default(cuid())

  // Batch info
  batchNumber String
  lotNumber   String?

  // Quantities
  initialQuantity  Decimal @db.Decimal(15, 4)
  currentQuantity  Decimal @db.Decimal(15, 4)
  reservedQuantity Decimal @default(0) @db.Decimal(15, 4)

  // Valuation
  unitCost Decimal @db.Decimal(15, 4)

  // Dates
  manufacturingDate DateTime?
  expiryDate        DateTime?
  receivedDate      DateTime  @default(now())

  // Status
  status String @default("available") // available, quarantine, expired, consumed

  // Supplier
  supplierId       String?
  supplierBatchRef String?

  // Quality
  qualityStatus String? // passed, failed, pending
  qualityNotes  String?

  // Location
  warehouseId String?
  location    String?

  // Relations
  inventoryItemId String
  inventoryItem   InventoryItem       @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  movements       InventoryMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([inventoryItemId, batchNumber])
  @@index([inventoryItemId, status])
  @@index([inventoryItemId, expiryDate])
}

// =============================================================================
// RECEIVABLES
// =============================================================================

model Receivable {
  id String @id @default(cuid())

  // Origin
  originType        String // invoice, order, contract, manual
  originReferenceId String?

  // Parties
  creditorEntityId String? // Our entity
  debtorId         String?
  debtorName       String
  debtorEmail      String?
  debtorPhone      String?
  debtorAddress    Json?

  // Amounts
  currency          String  @default("EUR")
  originalAmount    Decimal @db.Decimal(15, 2)
  outstandingAmount Decimal @db.Decimal(15, 2)
  paidAmount        Decimal @default(0) @db.Decimal(15, 2)
  disputedAmount    Decimal @default(0) @db.Decimal(15, 2)
  writtenOffAmount  Decimal @default(0) @db.Decimal(15, 2)

  // Dates
  issueDate           DateTime
  dueDate             DateTime
  expectedPaymentDate DateTime?
  lastActivityDate    DateTime?

  // Status & Risk
  status    String @default("open") // open, due, overdue, partially_paid, paid, disputed, in_collection, written_off, settled_via_offset
  riskLevel String @default("low") // low, medium, high, critical

  // Aging (calculated)
  daysOutstanding Int    @default(0)
  agingBucket     String @default("current") // current, 1-30, 31-60, 61-90, 90+

  // Dispute
  isDisputed        Boolean   @default(false)
  disputeReason     String?   @db.Text
  disputeOpenedAt   DateTime?
  disputeResolvedAt DateTime?

  // Collection
  collectionStage     String? // reminder_1, reminder_2, final_notice, external_collection
  collectionStartedAt DateTime?
  collectionAgency    String?

  // Automation
  autoRemindersEnabled Boolean   @default(true)
  nextReminderDate     DateTime?
  reminderCount        Int       @default(0)

  // Reference
  reference     String?
  description   String?  @db.Text
  notes         String?  @db.Text
  internalNotes String?  @db.Text
  tags          String[]

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Payment applications
  paymentApplications ReceivablePayment[]

  // Activity history
  events ReceivableEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, status])
  @@index([organizationId, dueDate])
  @@index([organizationId, debtorId])
  @@index([organizationId, agingBucket])
  @@index([organizationId, riskLevel])
}

model ReceivablePayment {
  id String @id @default(cuid())

  // Payment details
  amount    Decimal  @db.Decimal(15, 2)
  currency  String   @default("EUR")
  appliedAt DateTime @default(now())

  // Type
  type String // payment, credit_note, offset, write_off

  // Reference
  reference     String?
  transactionId String? // Link to Transaction

  // Meta
  notes     String?
  appliedBy String?

  // Relations
  receivableId String
  receivable   Receivable @relation(fields: [receivableId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([receivableId, appliedAt])
}

model ReceivableEvent {
  id String @id @default(cuid())

  // Event type
  type String // receivable_created, payment_applied, partial_payment_applied, credit_note_applied, offset_applied, dispute_opened, dispute_resolved, due_date_changed, collection_action_started, reminder_sent, write_off_applied, status_changed

  // Details
  description   String
  previousValue String?
  newValue      String?
  amount        Decimal? @db.Decimal(15, 2)

  // Meta
  performedBy String?
  notes       String?
  metadata    Json?

  // Relations
  receivableId String
  receivable   Receivable @relation(fields: [receivableId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([receivableId, createdAt])
}

// =============================================================================
// TREASURY
// =============================================================================

model TreasuryAccount {
  id String @id @default(cuid())

  // Account Info
  name          String
  accountNumber String?
  type          String // operating, reserve, restricted, investment, escrow

  // Bank details
  bankName String?
  bankCode String? // BIC/SWIFT
  iban     String?

  // Classification
  cashClassification String @default("unrestricted") // unrestricted, restricted, committed, reserved

  // Balances
  currency         String  @default("EUR")
  currentBalance   Decimal @default(0) @db.Decimal(15, 2)
  availableBalance Decimal @default(0) @db.Decimal(15, 2)
  pendingInflows   Decimal @default(0) @db.Decimal(15, 2)
  pendingOutflows  Decimal @default(0) @db.Decimal(15, 2)

  // Limits
  minimumBalance Decimal? @db.Decimal(15, 2)
  targetBalance  Decimal? @db.Decimal(15, 2)

  // Status
  status        String  @default("active") // active, inactive, frozen, closing
  isMainAccount Boolean @default(false)

  // Sweeping/Pooling
  participatesInPooling Boolean @default(false)
  poolingRole           String? // master, participant
  masterAccountId       String?

  // Meta
  entityId String? // Corporate entity if multi-entity
  notes    String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Transactions
  cashMovements TreasuryCashMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, type])
  @@index([organizationId, status])
  @@index([organizationId, cashClassification])
}

model CapitalBucket {
  id String @id @default(cuid())

  // Bucket info
  name        String
  type        String // operating, payroll, tax_reserve, debt_service, capex, emergency, growth, other
  description String?

  // Amounts
  currency      String  @default("EUR")
  targetAmount  Decimal @db.Decimal(15, 2)
  currentAmount Decimal @default(0) @db.Decimal(15, 2)
  minimumAmount Decimal @default(0) @db.Decimal(15, 2)

  // Status
  fundingStatus  String  @default("underfunded") // underfunded, funded, overfunded
  fundingPercent Decimal @default(0) @db.Decimal(5, 2)

  // Priority
  priority   Int     @default(5) // 1-10, lower = higher priority
  isRequired Boolean @default(false)

  // Funding rules
  autoFund               Boolean @default(false)
  fundingSourceAccountId String?

  // Time horizon
  timeHorizon String? // immediate, short_term, medium_term, long_term
  targetDate  DateTime?

  // Meta
  notes String?
  tags  String[]

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, type])
  @@index([organizationId, fundingStatus])
}

model CreditFacility {
  id String @id @default(cuid())

  // Facility info
  name   String
  type   String // revolving, term, overdraft, letter_of_credit, guarantee, factoring
  status String @default("active") // active, frozen, expired, cancelled

  // Lender
  lenderName String
  lenderId   String?

  // Amounts
  currency         String  @default("EUR")
  facilityLimit    Decimal @db.Decimal(15, 2)
  drawnAmount      Decimal @default(0) @db.Decimal(15, 2)
  availableAmount  Decimal @db.Decimal(15, 2)
  pendingDrawdowns Decimal @default(0) @db.Decimal(15, 2)

  // Utilization
  utilizationRate  Decimal  @default(0) @db.Decimal(5, 2)
  utilizationAlert Decimal? @db.Decimal(5, 2) // Alert threshold %

  // Interest
  interestRate Decimal? @db.Decimal(5, 4)
  interestType String? // fixed, variable, prime_plus
  spreadBps    Int? // Basis points over base rate

  // Fees
  commitmentFeeBps Int?
  arrangementFee   Decimal? @db.Decimal(15, 2)

  // Dates
  startDate      DateTime
  maturityDate   DateTime
  nextReviewDate DateTime?

  // Covenants
  covenants      Json? // Array of covenant objects
  covenantStatus String @default("compliant") // compliant, warning, breach

  // Security
  isSecured           Boolean @default(false)
  securityDescription String?

  // Meta
  reference String?
  notes     String? @db.Text
  documents Json?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Drawdowns
  drawdowns FacilityDrawdown[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, type])
  @@index([organizationId, status])
  @@index([organizationId, maturityDate])
}

model FacilityDrawdown {
  id String @id @default(cuid())

  // Drawdown details
  amount       Decimal  @db.Decimal(15, 2)
  currency     String   @default("EUR")
  drawdownDate DateTime

  // Repayment
  repaidAmount      Decimal @default(0) @db.Decimal(15, 2)
  outstandingAmount Decimal @db.Decimal(15, 2)

  // Status
  status String @default("active") // pending, active, repaid

  // Interest
  interestRate    Decimal? @db.Decimal(5, 4)
  accruedInterest Decimal  @default(0) @db.Decimal(15, 2)

  // Dates
  maturityDate DateTime?

  // Reference
  reference String?
  purpose   String?
  notes     String?

  // Relations
  facilityId String
  facility   CreditFacility @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([facilityId, status])
}

model TreasuryDecision {
  id String @id @default(cuid())

  // Decision info
  type        String // rebalance, drawdown, repayment, investment, transfer, fx_hedge, reserve_allocation
  title       String
  description String? @db.Text

  // Status
  status   String @default("pending") // pending, approved, rejected, executed, cancelled, expired
  priority String @default("normal") // low, normal, high, urgent

  // Amounts
  currency String  @default("EUR")
  amount   Decimal @db.Decimal(15, 2)

  // Impact
  riskDelta Json? // Risk impact assessment

  // Approval
  requiresApproval  Boolean   @default(true)
  approvalThreshold Decimal?  @db.Decimal(15, 2)
  approvedBy        String?
  approvedAt        DateTime?
  rejectedBy        String?
  rejectedAt        DateTime?
  rejectionReason   String?

  // Execution
  executionMode  String    @default("manual") // manual, scheduled, auto
  scheduledDate  DateTime?
  executedAt     DateTime?
  executedBy     String?
  executionNotes String?

  // Expiry
  expiresAt DateTime?

  // Linked entities
  sourceAccountId String?
  targetAccountId String?
  facilityId      String?
  bucketId        String?

  // Alternatives
  alternatives Json? // Alternative options considered

  // Meta
  notes    String? @db.Text
  metadata Json?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, status])
  @@index([organizationId, type])
  @@index([organizationId, priority])
}

model TreasuryScenario {
  id String @id @default(cuid())

  // Scenario info
  name        String
  type        String // baseline, best_case, worst_case, stress_test, custom
  description String? @db.Text

  // Status
  isActive   Boolean @default(true)
  isBaseline Boolean @default(false)

  // Assumptions
  assumptions Json // Key assumptions

  // Time horizon
  horizonDays Int      @default(90)
  startDate   DateTime @default(now())
  endDate     DateTime

  // Results
  results            Json? // Calculated results
  cashFlowProjection Json? // Day-by-day projection

  // Key metrics
  minimumCashDate   DateTime?
  minimumCashAmount Decimal?  @db.Decimal(15, 2)
  endingCashAmount  Decimal?  @db.Decimal(15, 2)

  // Risk
  probabilityWeight Decimal? @db.Decimal(5, 2) // For weighted scenarios
  riskScore         Decimal? @db.Decimal(5, 2)

  // Meta
  createdBy String?
  notes     String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, type])
  @@index([organizationId, isActive])
}

model TreasuryCashMovement {
  id String @id @default(cuid())

  // Movement info
  type     String // inflow, outflow, transfer_in, transfer_out, interest, fee
  category String? // operating, financing, investing

  // Amounts
  amount   Decimal @db.Decimal(15, 2)
  currency String  @default("EUR")

  // Balances
  balanceBefore Decimal @db.Decimal(15, 2)
  balanceAfter  Decimal @db.Decimal(15, 2)

  // Dates
  movementDate DateTime  @default(now())
  valueDate    DateTime?

  // Reference
  description  String
  reference    String?
  counterparty String?

  // Status
  status String @default("completed") // pending, completed, failed, reversed

  // Linked entities
  transactionId String?
  decisionId    String?

  // Relations
  accountId String
  account   TreasuryAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([accountId, movementDate])
  @@index([accountId, type])
}

model NettingOpportunity {
  id String @id @default(cuid())

  // Parties
  entityAId   String
  entityAName String
  entityBId   String
  entityBName String

  // Amounts
  currency     String  @default("EUR")
  amountAToB   Decimal @db.Decimal(15, 2)
  amountBToA   Decimal @db.Decimal(15, 2)
  netAmount    Decimal @db.Decimal(15, 2)
  netDirection String // a_to_b, b_to_a

  // Savings
  grossAmount    Decimal @db.Decimal(15, 2)
  savingsAmount  Decimal @db.Decimal(15, 2)
  savingsPercent Decimal @db.Decimal(5, 2)

  // Status
  status String @default("identified") // identified, approved, executed, expired

  // Execution
  executedAt DateTime?
  executedBy String?

  // Validity
  validUntil DateTime

  // Meta
  notes String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, status])
}

// =============================================================================
// ASSETS
// =============================================================================

model Asset {
  id String @id @default(cuid())

  // Identification
  assetNumber String
  name        String
  description String? @db.Text

  // Classification
  category    String // property_plant_equipment, intangible, financial, right_of_use, investment_property, biological, other
  subcategory String?
  assetClass  String? // buildings, machinery, vehicles, furniture, software, patents, etc.

  // Status
  status String @default("active") // draft, active, fully_depreciated, impaired, disposed, written_off

  // Acquisition
  acquisitionDate DateTime
  acquisitionType String   @default("purchase") // purchase, lease, construction, donation, transfer, merger
  acquisitionCost Decimal  @db.Decimal(15, 2)
  currency        String   @default("EUR")

  // Vendor/Source
  vendorId         String?
  vendorName       String?
  purchaseOrderRef String?
  invoiceRef       String?

  // Current Values
  currentBookValue Decimal  @db.Decimal(15, 2)
  fairValue        Decimal? @db.Decimal(15, 2)
  residualValue    Decimal  @default(0) @db.Decimal(15, 2)

  // Depreciation
  isDepreciable      Boolean  @default(true)
  depreciationMethod String   @default("straight_line") // straight_line, declining_balance, units_of_production, sum_of_years
  usefulLifeMonths   Int?
  usefulLifeUnits    Int? // For units of production
  depreciationRate   Decimal? @db.Decimal(5, 2) // For declining balance %

  // Accumulated values
  accumulatedDepreciation Decimal @default(0) @db.Decimal(15, 2)
  accumulatedImpairment   Decimal @default(0) @db.Decimal(15, 2)

  // Depreciation tracking
  depreciationStartDate DateTime?
  lastDepreciationDate  DateTime?
  nextDepreciationDate  DateTime?
  monthlyDepreciation   Decimal?  @db.Decimal(15, 2)

  // Location & Responsibility
  locationId         String?
  locationName       String?
  locationAddress    String?
  costCenterId       String?
  costCenterName     String?
  responsibleParty   String?
  responsiblePartyId String?

  // Entity ownership
  entityId   String?
  entityName String?

  // Physical attributes
  serialNumber String?
  modelNumber  String?
  manufacturer String?
  barcode      String?

  // Quantity (for group assets)
  quantity      Int    @default(1)
  unitOfMeasure String @default("pcs")

  // Insurance
  isInsured       Boolean   @default(false)
  insurancePolicy String?
  insuredValue    Decimal?  @db.Decimal(15, 2)
  insuranceExpiry DateTime?

  // Warranty
  warrantyExpiry DateTime?
  warrantyTerms  String?

  // Maintenance
  requiresMaintenance Boolean   @default(false)
  maintenanceSchedule String? // monthly, quarterly, annually
  lastMaintenanceDate DateTime?
  nextMaintenanceDate DateTime?

  // Disposal planning
  plannedDisposalDate DateTime?
  disposalMethod      String? // sale, scrap, donation, trade_in

  // Revaluation
  lastRevaluationDate DateTime?
  revaluationSurplus  Decimal   @default(0) @db.Decimal(15, 2)

  // Component accounting
  isComponent   Boolean @default(false)
  parentAssetId String?
  parentAsset   Asset?  @relation("AssetComponents", fields: [parentAssetId], references: [id])
  components    Asset[] @relation("AssetComponents")

  // Meta
  tags         String[]
  notes        String?  @db.Text
  attachments  Json? // Document references
  customFields Json? // Flexible additional fields

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Related records
  depreciationEntries AssetDepreciation[]
  events              AssetEvent[]
  transfers           AssetTransfer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, assetNumber])
  @@index([organizationId, status])
  @@index([organizationId, category])
  @@index([organizationId, entityId])
  @@index([organizationId, costCenterId])
  @@index([organizationId, locationId])
}

model AssetDepreciation {
  id String @id @default(cuid())

  // Period
  periodStart  DateTime
  periodEnd    DateTime
  fiscalYear   Int
  fiscalPeriod String? // M01-M12 or Q1-Q4

  // Amounts
  depreciationAmount      Decimal @db.Decimal(15, 2)
  accumulatedDepreciation Decimal @db.Decimal(15, 2)
  openingBookValue        Decimal @db.Decimal(15, 2)
  closingBookValue        Decimal @db.Decimal(15, 2)

  // Method used
  method String
  rate   Decimal? @db.Decimal(5, 2)

  // Status
  status String @default("calculated") // calculated, posted, reversed

  // Ledger reference
  journalEntryId String?
  postedAt       DateTime?
  postedBy       String?

  // Book type (for multi-book)
  bookType String @default("statutory") // statutory, tax, management, ifrs

  // Meta
  notes String?

  // Relations
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([assetId, periodStart])
  @@index([assetId, bookType])
  @@index([assetId, status])
}

model AssetEvent {
  id String @id @default(cuid())

  // Event type
  type String // acquisition, depreciation, impairment, revaluation, transfer, disposal, maintenance, insurance_update, write_off, component_added, component_removed

  // Details
  description String

  // Financial impact
  amount        Decimal? @db.Decimal(15, 2)
  previousValue Decimal? @db.Decimal(15, 2)
  newValue      Decimal? @db.Decimal(15, 2)

  // Date
  eventDate     DateTime  @default(now())
  effectiveDate DateTime?

  // Reference
  referenceType String? // journal_entry, invoice, transfer_order, disposal_order
  referenceId   String?

  // Approval
  requiresApproval Boolean   @default(false)
  approvedBy       String?
  approvedAt       DateTime?

  // Meta
  performedBy String?
  notes       String?
  metadata    Json?

  // Relations
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([assetId, eventDate])
  @@index([assetId, type])
}

model AssetTransfer {
  id String @id @default(cuid())

  // Transfer details
  transferDate  DateTime
  effectiveDate DateTime
  transferType  String // location, cost_center, entity, responsibility

  // From
  fromEntityId         String?
  fromEntityName       String?
  fromCostCenterId     String?
  fromCostCenterName   String?
  fromLocationId       String?
  fromLocationName     String?
  fromResponsibleParty String?

  // To
  toEntityId         String?
  toEntityName       String?
  toCostCenterId     String?
  toCostCenterName   String?
  toLocationId       String?
  toLocationName     String?
  toResponsibleParty String?

  // Values at transfer
  bookValueAtTransfer      Decimal @db.Decimal(15, 2)
  accumulatedDepAtTransfer Decimal @db.Decimal(15, 2)

  // Status
  status String @default("completed") // pending, approved, completed, cancelled

  // Approval
  requestedBy String?
  requestedAt DateTime  @default(now())
  approvedBy  String?
  approvedAt  DateTime?

  // Reason
  reason String?
  notes  String?

  // Relations
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([assetId, transferDate])
}

model AssetDisposal {
  id String @id @default(cuid())

  // Disposal info
  disposalDate DateTime
  disposalType String // sale, scrap, donation, theft, destruction, trade_in, write_off, other

  // Values
  carryingAmount          Decimal @db.Decimal(15, 2)
  accumulatedDepreciation Decimal @db.Decimal(15, 2)

  // Sale details
  salePrice      Decimal? @db.Decimal(15, 2)
  saleCurrency   String   @default("EUR")
  buyerName      String?
  buyerReference String?
  invoiceId      String?

  // Gain/Loss
  gainOrLoss Decimal @db.Decimal(15, 2)
  isGain     Boolean @default(false)

  // Costs
  disposalCosts Decimal @default(0) @db.Decimal(15, 2)

  // Tax
  taxAmount    Decimal? @db.Decimal(15, 2)
  taxTreatment String?

  // Status
  status String @default("completed") // pending, approved, completed, reversed

  // Approval
  reason     String
  approvedBy String?
  approvedAt DateTime?

  // Ledger
  journalEntryId String?

  // Meta
  notes       String? @db.Text
  attachments Json?

  // Relations
  assetId        String       @unique
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, disposalDate])
  @@index([organizationId, disposalType])
}

model CapExBudget {
  id String @id @default(cuid())

  // Budget info
  name        String
  fiscalYear  String
  description String?

  // Scope
  entityId     String?
  entityName   String?
  projectId    String?
  projectName  String?
  costCenterId String?

  // Amounts
  currency        String  @default("EUR")
  budgetAmount    Decimal @db.Decimal(15, 2)
  committedAmount Decimal @default(0) @db.Decimal(15, 2)
  spentAmount     Decimal @default(0) @db.Decimal(15, 2)
  remainingAmount Decimal @db.Decimal(15, 2)

  // Status
  status             String  @default("active") // draft, active, closed, overspent
  utilizationPercent Decimal @default(0) @db.Decimal(5, 2)

  // Approval
  approvedBy String?
  approvedAt DateTime?

  // Meta
  notes String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Items
  items CapExItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, fiscalYear])
  @@index([organizationId, status])
}

model CapExItem {
  id String @id @default(cuid())

  // Item info
  description String
  category    String?

  // Amounts
  estimatedAmount Decimal  @db.Decimal(15, 2)
  actualAmount    Decimal? @db.Decimal(15, 2)
  variance        Decimal? @db.Decimal(15, 2)

  // Status
  status String @default("planned") // planned, approved, committed, spent, cancelled

  // Classification
  classification       String  @default("capex") // capex, opex, borderline
  classificationReason String?

  // Linked asset
  assetId String?

  // Approval
  approvedBy String?
  approvedAt DateTime?

  // Timing
  plannedDate DateTime?
  actualDate  DateTime?

  // Meta
  notes String?

  // Relations
  budgetId String
  budget   CapExBudget @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([budgetId, status])
}

// =============================================================================
// PROJECTS & COST CENTERS
// =============================================================================
// ADD THIS TO: prisma/schema.prisma (append before closing)
// THEN RUN: npx prisma migrate dev --name add_projects_module

model CostCenter {
  id String @id @default(cuid())

  // Identification
  code        String
  name        String
  description String? @db.Text

  // Hierarchy
  parentId String?
  parent   CostCenter?  @relation("CostCenterHierarchy", fields: [parentId], references: [id])
  children CostCenter[] @relation("CostCenterHierarchy")
  level    Int          @default(0)
  path     String? // e.g., "CC001/CC001-A/CC001-A-1"

  // Manager
  managerId   String?
  managerName String?

  // Budget
  annualBudget      Decimal @default(0) @db.Decimal(15, 2)
  budgetSpent       Decimal @default(0) @db.Decimal(15, 2)
  budgetRemaining   Decimal @default(0) @db.Decimal(15, 2)
  budgetUtilization Decimal @default(0) @db.Decimal(5, 2)
  currency          String  @default("EUR")

  // Allocation
  allocationMethod String  @default("direct") // direct, percentage, hours, headcount, revenue, custom
  allocationBasis  String?

  // Status
  isActive      Boolean   @default(true)
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  // Meta
  tags String[]

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Related
  projects        Project[]
  timeEntries     TimeEntry[]
  chargebacksFrom InternalChargeback[] @relation("ChargebackFrom")
  chargebacksTo   InternalChargeback[] @relation("ChargebackTo")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, code])
  @@index([organizationId, isActive])
  @@index([organizationId, parentId])
}

model Project {
  id String @id @default(cuid())

  // Identification
  code        String
  name        String
  description String? @db.Text

  // Classification
  type     String @default("internal") // internal, client, rd, capex, opex, maintenance
  status   String @default("planning") // planning, active, on_hold, completed, cancelled, archived
  priority String @default("medium") // low, medium, high, critical

  // Ownership
  ownerId        String?
  ownerName      String?
  costCenterId   String?
  costCenter     CostCenter? @relation(fields: [costCenterId], references: [id])
  costCenterCode String?
  departmentId   String?
  clientId       String?
  clientName     String?

  // Timeline
  plannedStartDate DateTime
  plannedEndDate   DateTime
  actualStartDate  DateTime?
  actualEndDate    DateTime?

  // Budget & Financials
  budgetType        String  @default("fixed") // fixed, time_materials, retainer, milestone
  budgetAmount      Decimal @default(0) @db.Decimal(15, 2)
  budgetSpent       Decimal @default(0) @db.Decimal(15, 2)
  budgetRemaining   Decimal @default(0) @db.Decimal(15, 2)
  budgetVariance    Decimal @default(0) @db.Decimal(15, 2)
  budgetUtilization Decimal @default(0) @db.Decimal(5, 2)
  currency          String  @default("EUR")

  // Revenue (for client projects)
  contractValue   Decimal? @db.Decimal(15, 2)
  billedAmount    Decimal  @default(0) @db.Decimal(15, 2)
  collectedAmount Decimal  @default(0) @db.Decimal(15, 2)
  unbilledAmount  Decimal  @default(0) @db.Decimal(15, 2)

  // Profitability
  totalRevenue Decimal @default(0) @db.Decimal(15, 2)
  totalCosts   Decimal @default(0) @db.Decimal(15, 2)
  grossProfit  Decimal @default(0) @db.Decimal(15, 2)
  grossMargin  Decimal @default(0) @db.Decimal(5, 2)
  netProfit    Decimal @default(0) @db.Decimal(15, 2)
  netMargin    Decimal @default(0) @db.Decimal(5, 2)

  // Resources
  allocatedHours Decimal  @default(0) @db.Decimal(10, 2)
  actualHours    Decimal  @default(0) @db.Decimal(10, 2)
  remainingHours Decimal  @default(0) @db.Decimal(10, 2)
  hourlyRate     Decimal? @db.Decimal(10, 2)

  // Progress
  percentComplete     Decimal @default(0) @db.Decimal(5, 2)
  milestoneCount      Int     @default(0)
  milestonesCompleted Int     @default(0)

  // Billing
  isBillable    Boolean  @default(false)
  billingRate   Decimal? @db.Decimal(10, 2)
  billingMethod String? // hourly, fixed, milestone, retainer

  // Meta
  tags String[]

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Related
  milestones  ProjectMilestone[]
  timeEntries TimeEntry[]
  chargebacks InternalChargeback[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, code])
  @@index([organizationId, status])
  @@index([organizationId, type])
  @@index([organizationId, costCenterId])
}

model ProjectMilestone {
  id String @id @default(cuid())

  // Details
  name        String
  description String? @db.Text

  // Timeline
  plannedDate DateTime
  actualDate  DateTime?

  // Status
  status          String  @default("pending") // pending, in_progress, completed, delayed, cancelled
  percentComplete Decimal @default(0) @db.Decimal(5, 2)

  // Billing
  isBillable    Boolean   @default(false)
  billingAmount Decimal?  @db.Decimal(15, 2)
  billedAt      DateTime?

  // Dependencies
  dependsOn String[] // milestone IDs

  // Relations
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId, status])
  @@index([projectId, plannedDate])
}

model TimeEntry {
  id String @id @default(cuid())

  // User
  userId   String
  userName String?

  // Project/Task
  projectId    String
  project      Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectCode  String?
  taskId       String?
  taskName     String?
  costCenterId String?
  costCenter   CostCenter? @relation(fields: [costCenterId], references: [id])

  // Time
  date      DateTime
  hours     Decimal  @db.Decimal(5, 2)
  startTime String?
  endTime   String?

  // Description
  description String
  category    String?

  // Billing
  isBillable     Boolean  @default(false)
  hourlyRate     Decimal? @db.Decimal(10, 2)
  billableAmount Decimal? @db.Decimal(15, 2)

  // Cost
  costRate   Decimal? @db.Decimal(10, 2)
  costAmount Decimal? @db.Decimal(15, 2)

  // Status
  status          String    @default("draft") // draft, submitted, approved, rejected, billed
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, userId])
  @@index([organizationId, projectId])
  @@index([organizationId, date])
  @@index([organizationId, status])
}

model InternalChargeback {
  id               String @id @default(cuid())
  chargebackNumber String

  // From/To Cost Centers
  fromCostCenterId   String
  fromCostCenter     CostCenter @relation("ChargebackFrom", fields: [fromCostCenterId], references: [id])
  fromCostCenterCode String?
  toCostCenterId     String
  toCostCenter       CostCenter @relation("ChargebackTo", fields: [toCostCenterId], references: [id])
  toCostCenterCode   String?

  // Project (optional)
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id])
  projectCode String?

  // Details
  date        DateTime
  description String
  category    String

  // Amount
  amount   Decimal @db.Decimal(15, 2)
  currency String  @default("EUR")

  // Basis
  allocationMethod String   @default("direct") // direct, percentage, hours, headcount, revenue, custom
  allocationBasis  String?
  quantity         Decimal? @db.Decimal(15, 4)
  unitRate         Decimal? @db.Decimal(15, 4)

  // Period
  periodStart DateTime
  periodEnd   DateTime

  // Status
  status          String    @default("pending") // pending, approved, rejected, billed, paid
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?

  // References
  invoiceId      String?
  journalEntryId String?

  // Meta
  notes     String? @db.Text
  createdBy String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, chargebackNumber])
  @@index([organizationId, status])
  @@index([organizationId, fromCostCenterId])
  @@index([organizationId, toCostCenterId])
  @@index([organizationId, date])
}

// =============================================================================
// PERIOD CLOSE MODULE
// =============================================================================
// ADD TO: prisma/schema.prisma (append at end)
// ADD TO Organization model relations:
//   accountingPeriods    AccountingPeriod[]
//   periodAdjustments    PeriodAdjustment[]
// THEN RUN: npx prisma migrate dev --name add_period_close_module

model AccountingPeriod {
  id   String @id @default(cuid())
  name String
  code String // e.g., "2024-01", "2024-Q1", "2024"

  // Type & Dates
  type          String   @default("monthly") // monthly, quarterly, yearly, custom
  startDate     DateTime
  endDate       DateTime
  fiscalYear    Int
  fiscalQuarter Int?
  fiscalMonth   Int?

  // Status
  status       String    @default("open") // open, closing, closed, locked, reopened
  closedAt     DateTime?
  closedBy     String?
  reopenedAt   DateTime?
  reopenedBy   String?
  reopenReason String?   @db.Text

  // Checklist Progress
  checklistTotal     Int     @default(0)
  checklistCompleted Int     @default(0)
  checklistProgress  Decimal @default(0) @db.Decimal(5, 2)

  // Flags
  hasUnreconciledItems     Boolean @default(false)
  hasPendingTransactions   Boolean @default(false)
  hasMissingDocuments      Boolean @default(false)
  hasUnapprovedAdjustments Boolean @default(false)

  // Financials (snapshot at close)
  totalRevenue     Decimal? @db.Decimal(15, 2)
  totalExpenses    Decimal? @db.Decimal(15, 2)
  netIncome        Decimal? @db.Decimal(15, 2)
  totalAssets      Decimal? @db.Decimal(15, 2)
  totalLiabilities Decimal? @db.Decimal(15, 2)

  // Meta
  notes String? @db.Text

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  checklistItems CloseChecklistItem[]
  missingItems   PeriodMissingItem[]
  adjustments    PeriodAdjustment[]
  auditEntries   PeriodAuditEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, code])
  @@index([organizationId, status])
  @@index([organizationId, fiscalYear])
}

model CloseChecklistItem {
  id       String           @id @default(cuid())
  periodId String
  period   AccountingPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  // Item Details
  name        String
  description String? @db.Text
  category    String // reconciliation, review, adjustment, approval, documentation, system
  orderIndex  Int     @default(0)

  // Status
  status      String    @default("pending") // pending, in_progress, completed, skipped, blocked
  completedAt DateTime?
  completedBy String?

  // Requirements
  isRequired Boolean  @default(true)
  isCritical Boolean  @default(false)
  dependsOn  String[] // other checklist item IDs

  // Automation
  isAutomated     Boolean   @default(false)
  automationRule  String?
  lastAutoCheck   DateTime?
  autoCheckResult String? // pass, fail, warning

  // Evidence
  attachments String[]
  notes       String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([periodId, status])
  @@index([periodId, category])
}

model PeriodMissingItem {
  id       String           @id @default(cuid())
  periodId String
  period   AccountingPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  // Item Type
  type     String // document, reconciliation, approval, transaction, entry
  severity String @default("medium") // low, medium, high, critical

  // Details
  title             String
  description       String  @db.Text
  reference         String?
  relatedEntityType String?
  relatedEntityId   String?

  // Assignment
  assignedTo     String?
  assignedToName String?
  dueDate        DateTime?

  // Resolution
  status       String    @default("open") // open, in_progress, resolved, waived
  resolvedAt   DateTime?
  resolvedBy   String?
  resolution   String?   @db.Text
  waivedReason String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([periodId, status])
  @@index([periodId, severity])
}

model PeriodAdjustment {
  id               String           @id @default(cuid())
  adjustmentNumber String
  periodId         String
  period           AccountingPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  // Type
  type   String @default("accrual") // accrual, deferral, reclassification, correction, reversal, provision
  status String @default("draft") // draft, pending_approval, approved, posted, rejected

  // Details
  description String
  reason      String @db.Text

  // Amounts
  debitAccountId    String?
  debitAccountName  String?
  creditAccountId   String?
  creditAccountName String?
  amount            Decimal @db.Decimal(15, 2)
  currency          String  @default("EUR")

  // Effective Date
  effectiveDate DateTime

  // Reversal (for accruals)
  isReversing          Boolean   @default(false)
  reversalDate         DateTime?
  reversalPeriodId     String?
  originalAdjustmentId String?

  // Approval
  requestedBy     String?
  requestedByName String?
  approvedBy      String?
  approvedByName  String?
  approvedAt      DateTime?
  rejectedBy      String?
  rejectionReason String?   @db.Text

  // Posting
  postedAt       DateTime?
  journalEntryId String?

  // Documentation
  supportingDocuments String[]
  notes               String?  @db.Text

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, adjustmentNumber])
  @@index([periodId, status])
  @@index([periodId, type])
  @@index([organizationId, status])
}

model PeriodAuditEntry {
  id       String           @id @default(cuid())
  periodId String
  period   AccountingPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  // Action
  action      String // created, opened, checklist_updated, adjustment_posted, closing_started, closed, reopened, locked
  description String

  // User
  userId   String
  userName String?

  // Details
  previousStatus String?
  newStatus      String?
  metadata       Json?

  // IP/Session
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([periodId, createdAt])
  @@index([periodId, action])
}

// =============================================================================
// CUSTOMERS MODULE - Updated to match TypeScript types
// =============================================================================

model Customer {
  id             String @id @default(cuid())
  customerNumber String

  // Basic Info
  name      String
  legalName String?
  type      String  @default("business") // individual, business, enterprise, government
  status    String  @default("active") // active, inactive, prospect, churned, suspended
  industry  String?

  // Contact
  email   String?
  phone   String?
  website String?
  address Json? // { street, city, state, postalCode, country }

  // Business Info
  taxId              String?
  vatNumber          String?
  registrationNumber String?
  classification     String?
  employeeCount      Int?
  annualRevenue      Decimal? @db.Decimal(15, 2)

  // Account Info
  accountManagerId   String?
  accountManagerName String?
  segment            String?
  tags               String[]

  // Credit Management
  creditLimit     Decimal @default(0) @db.Decimal(15, 2)
  creditUsed      Decimal @default(0) @db.Decimal(15, 2)
  creditAvailable Decimal @default(0) @db.Decimal(15, 2)
  creditStatus    String  @default("approved") // approved, pending, under_review, rejected, suspended, good, warning, hold, blocked
  paymentTerms    String  @default("Net 30")

  // Payment Behavior
  paymentBehavior      String   @default("good") // excellent, good, fair, poor, delinquent
  averageDaysToPayment Int?
  onTimePaymentRate    Decimal? @db.Decimal(5, 2)
  latePaymentCount     Int      @default(0)

  // Risk Assessment
  riskLevel String @default("low") // low, medium, high, critical
  riskScore Int    @default(0) // 0-100

  // Financial Summary
  totalRevenue       Decimal @default(0) @db.Decimal(15, 2)
  totalOrders        Int     @default(0)
  averageOrderValue  Decimal @default(0) @db.Decimal(15, 2)
  outstandingBalance Decimal @default(0) @db.Decimal(15, 2)
  overdueAmount      Decimal @default(0) @db.Decimal(15, 2)
  currency           String  @default("EUR")

  // Relationship Dates
  customerSince    DateTime  @default(now())
  lastActivityDate DateTime?
  lastPurchaseDate DateTime?
  lastOrderDate    DateTime?
  lastPaymentDate  DateTime?
  lastContactDate  DateTime?

  // Preferences
  preferredPaymentMethod String?
  preferredLanguage      String  @default("en")
  invoiceDelivery        String  @default("email") // email, mail, portal

  // Notes
  notes String? @db.Text

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  contacts       CustomerContact[]
  payments       CustomerPayment[]
  creditEvents   CustomerCreditEvent[]
  revenueRecords CustomerRevenue[]
  riskIndicators CustomerRiskIndicator[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, customerNumber])
  @@index([organizationId, status])
  @@index([organizationId, type])
  @@index([organizationId, riskLevel])
  @@index([organizationId, creditStatus])
  @@index([organizationId, paymentBehavior])
}

model CustomerContact {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  name      String
  title     String?
  email     String
  phone     String?
  isPrimary Boolean @default(false)
  role      String  @default("general") // billing, technical, executive, purchasing, general

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
}

model CustomerPayment {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Reference
  invoiceId     String?
  invoiceNumber String?

  // Amount
  amount   Decimal @db.Decimal(15, 2)
  currency String  @default("EUR")

  // Dates
  invoiceDate DateTime
  dueDate     DateTime
  paymentDate DateTime?

  // Status
  status        String @default("pending") // pending, paid, partial, overdue, written_off
  daysToPayment Int?
  daysOverdue   Int?

  // Payment Details
  paymentMethod   String?
  referenceNumber String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([customerId, status])
  @@index([customerId, paymentDate])
  @@index([organizationId, status])
}

model CustomerCreditEvent {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Event Type
  type String // limit_increase, limit_decrease, status_change, review, terms_change

  // Details
  previousValue String?
  newValue      String
  reason        String

  // User
  changedBy     String?
  changedByName String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([customerId, createdAt])
}

model CustomerRevenue {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Period
  period     String // e.g., "2024-01", "2024-Q1"
  periodType String // monthly, quarterly, yearly

  // Amounts
  revenue Decimal  @db.Decimal(15, 2)
  cost    Decimal? @db.Decimal(15, 2)
  profit  Decimal? @db.Decimal(15, 2)
  margin  Decimal? @db.Decimal(5, 2)

  // Breakdown
  productRevenue Decimal? @db.Decimal(15, 2)
  serviceRevenue Decimal? @db.Decimal(15, 2)
  otherRevenue   Decimal? @db.Decimal(15, 2)

  // Orders
  orderCount        Int
  averageOrderValue Decimal @db.Decimal(15, 2)

  createdAt DateTime @default(now())

  @@unique([customerId, period, periodType])
  @@index([customerId, periodType])
}

model CustomerRiskIndicator {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Indicator
  category    String // payment, credit, activity, financial, external
  indicator   String
  description String

  // Severity
  severity String @default("medium") // low, medium, high, critical
  score    Int    @default(0)

  // Status
  status     String    @default("active") // active, resolved, monitoring
  detectedAt DateTime  @default(now())
  resolvedAt DateTime?

  // Actions
  recommendedAction String?
  actionTaken       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId, status])
  @@index([customerId, severity])
}

// =============================================================================
// SUPPLIERS MODULE - Updated to match TypeScript types
// =============================================================================

model Supplier {
  id             String @id @default(cuid())
  supplierNumber String

  // Basic Info
  name      String
  legalName String?
  status    String  @default("active") // active, inactive, pending, blocked, preferred
  category  String  @default("goods") // goods, services, raw_materials, equipment, utilities, logistics, professional, other

  // Contact
  email   String
  phone   String?
  website String?
  address Json? // { street, city, state, postalCode, country }

  // Business Info
  taxId              String?
  registrationNumber String?
  founded            Int? // Year founded
  employeeCount      Int?

  // Account Info
  accountManagerId   String?
  accountManagerName String?
  tags               String[]

  // Dates
  supplierSince      DateTime  @default(now())
  lastOrderDate      DateTime?
  lastPaymentDate    DateTime?
  contractExpiryDate DateTime?

  // Financial Summary
  totalSpend         Decimal @default(0) @db.Decimal(15, 2)
  totalOrders        Int     @default(0)
  averageOrderValue  Decimal @default(0) @db.Decimal(15, 2)
  outstandingBalance Decimal @default(0) @db.Decimal(15, 2)
  currency           String  @default("EUR")

  // Payment Terms
  paymentTerms           String   @default("Net 30")
  preferredPaymentMethod String   @default("wire") // wire, ach, check, card, cash, other
  earlyPaymentDiscount   Decimal? @db.Decimal(5, 2) // percentage
  bankDetails            Json? // { bankName, iban, swift, accountNumber }

  // Reliability Metrics
  reliabilityRating  String  @default("good") // excellent, good, fair, poor, critical
  reliabilityScore   Int     @default(80) // 0-100
  onTimeDeliveryRate Decimal @default(90) @db.Decimal(5, 2) // percentage
  qualityScore       Int     @default(80) // 0-100
  defectRate         Decimal @default(0) @db.Decimal(5, 2) // percentage
  avgLeadTime        Int     @default(14) // days

  // Dependency Metrics
  dependencyLevel      String  @default("low") // low, medium, high, critical
  dependencyScore      Int     @default(0) // 0-100
  spendPercentage      Decimal @default(0) @db.Decimal(5, 2) // percentage of total procurement
  alternativeSuppliers Int     @default(0)
  criticalItems        Int     @default(0)

  // Notes
  notes String? @db.Text

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  contacts    SupplierContact[]
  balance     SupplierBalance?
  payments    SupplierPayment[]
  reliability SupplierReliability[]
  spend       SupplierSpend[]
  risks       SupplierRisk[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, supplierNumber])
  @@index([organizationId, status])
  @@index([organizationId, category])
  @@index([organizationId, reliabilityRating])
  @@index([organizationId, dependencyLevel])
}

model SupplierContact {
  id         String   @id @default(cuid())
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  name      String
  title     String?
  email     String
  phone     String?
  isPrimary Boolean @default(false)
  role      String  @default("general") // sales, account, support, billing, executive, general

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([supplierId])
}

model SupplierBalance {
  id         String   @id @default(cuid())
  supplierId String   @unique
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  // Outstanding Amounts
  totalOutstanding Decimal @default(0) @db.Decimal(15, 2)
  currentDue       Decimal @default(0) @db.Decimal(15, 2)
  overdue30        Decimal @default(0) @db.Decimal(15, 2)
  overdue60        Decimal @default(0) @db.Decimal(15, 2)
  overdue90Plus    Decimal @default(0) @db.Decimal(15, 2)

  // Credits
  availableCredits Decimal @default(0) @db.Decimal(15, 2)
  pendingCredits   Decimal @default(0) @db.Decimal(15, 2)

  // Last Payment
  lastPaymentAmount Decimal?  @db.Decimal(15, 2)
  lastPaymentDate   DateTime?

  // Next Payment
  nextPaymentDue    DateTime?
  nextPaymentAmount Decimal?  @db.Decimal(15, 2)

  // YTD Totals
  ytdPayments  Decimal @default(0) @db.Decimal(15, 2)
  ytdPurchases Decimal @default(0) @db.Decimal(15, 2)

  updatedAt DateTime @updatedAt
}

model SupplierPayment {
  id         String   @id @default(cuid())
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  // Payment Info
  paymentNumber String
  invoiceIds    Json    @default("[]") // String[] stored as JSON
  amount        Decimal @db.Decimal(15, 2)
  currency      String  @default("EUR")

  // Dates
  paymentDate DateTime
  dueDate     DateTime?

  // Method
  paymentMethod   String // wire, ach, check, card, cash, other
  referenceNumber String?
  bankAccount     String?

  // Status
  status String @default("pending") // scheduled, pending, processing, completed, failed, cancelled

  // Discounts
  discountTaken Decimal? @db.Decimal(15, 2)
  discountType  String? // early_payment, volume, promotional

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now())

  @@index([supplierId, paymentDate])
  @@index([supplierId, status])
}

model SupplierReliability {
  id         String   @id @default(cuid())
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  // Order Info
  orderId     String
  orderNumber String
  orderDate   DateTime

  // Delivery
  expectedDeliveryDate DateTime
  actualDeliveryDate   DateTime?
  daysVariance         Int       @default(0) // negative = early, positive = late

  // Quality
  itemsOrdered   Int
  itemsReceived  Int
  itemsDefective Int @default(0)
  qualityScore   Int @default(100) // 0-100

  // Issues
  hasIssues        Boolean @default(false)
  issueType        String? // late_delivery, partial_delivery, quality_issue, wrong_items, damaged, documentation
  issueDescription String? @db.Text
  issueResolved    Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([supplierId, orderDate])
  @@index([supplierId, hasIssues])
}

model SupplierSpend {
  id         String   @id @default(cuid())
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  // Period
  period     String // e.g., "2024-01", "2024-Q1", "2024"
  periodType String // monthly, quarterly, yearly

  // Amounts
  totalSpend    Decimal @db.Decimal(15, 2)
  directSpend   Decimal @default(0) @db.Decimal(15, 2)
  indirectSpend Decimal @default(0) @db.Decimal(15, 2)

  // Breakdown
  goodsSpend    Decimal? @db.Decimal(15, 2)
  servicesSpend Decimal? @db.Decimal(15, 2)

  // Orders
  orderCount        Int
  averageOrderValue Decimal @db.Decimal(15, 2)

  // Comparison
  previousPeriodSpend Decimal? @db.Decimal(15, 2)
  changePercentage    Decimal? @db.Decimal(5, 2)
  budgetAmount        Decimal? @db.Decimal(15, 2)
  budgetVariance      Decimal? @db.Decimal(15, 2)

  createdAt DateTime @default(now())

  @@unique([supplierId, period, periodType])
  @@index([supplierId, periodType])
}

model SupplierRisk {
  id         String   @id @default(cuid())
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  // Risk Type
  riskType String // single_source, high_spend, critical_component, geographic, financial, operational, compliance

  // Details
  title       String
  description String @db.Text
  severity    String @default("medium") // low, medium, high, critical

  // Impact Assessment
  impactScore      Int @default(5) // 1-10
  probabilityScore Int @default(5) // 1-10
  overallRiskScore Int @default(25) // impact * probability

  // Mitigation
  mitigationPlan   String? @db.Text
  mitigationStatus String  @default("not_started") // not_started, in_progress, completed, monitoring

  // Status
  status       String    @default("identified") // identified, assessed, mitigating, resolved, accepted
  identifiedAt DateTime  @default(now())
  resolvedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([supplierId, status])
  @@index([supplierId, severity])
}

// =============================================================================
// NETTING MODULE - Comprehensive Netting System
// =============================================================================

// Netting Agreement (framework for netting between parties)
model NettingAgreement {
  id              String @id @default(cuid())
  agreementNumber String

  // Basic Info
  name   String
  type   String @default("counterparty") // counterparty, intercompany, multilateral
  status String @default("active") // active, inactive, expired

  // Terms
  nettingFrequency String @default("monthly") // daily, weekly, biweekly, monthly, quarterly
  settlementDays   Int    @default(5) // Days after netting date for settlement
  baseCurrency     String @default("EUR")

  // Thresholds
  minimumNettingAmount Decimal? @db.Decimal(15, 2)
  maximumNettingAmount Decimal? @db.Decimal(15, 2)

  // Dates
  effectiveDate   DateTime
  expiryDate      DateTime?
  lastNettingDate DateTime?
  nextNettingDate DateTime?

  // Meta
  notes String? @db.Text

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  parties  NettingParty[]
  sessions NettingSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, agreementNumber])
  @@index([organizationId, status])
  @@index([organizationId, type])
}

// Netting Party (participants in a netting agreement)
model NettingParty {
  id String @id @default(cuid())

  // Party Reference
  partyId   String // External reference (customer/supplier/subsidiary ID)
  partyName String
  partyType String @default("supplier") // customer, supplier, subsidiary, affiliate, joint_venture

  // Account Info
  accountNumber String?
  bankName      String?
  bankDetails   Json? // { iban, swift, accountHolder, bankAddress }

  // Role
  isNettingCenter Boolean @default(false)

  // Relations
  agreementId String
  agreement   NettingAgreement @relation(fields: [agreementId], references: [id], onDelete: Cascade)

  positions NettingPosition[]

  createdAt DateTime @default(now())

  @@index([agreementId])
  @@index([partyId])
}

// Netting Session (a single netting cycle)
model NettingSession {
  id            String @id @default(cuid())
  sessionNumber String

  // Type & Status
  type   String @default("counterparty") // counterparty, intercompany, multilateral
  status String @default("draft") // draft, pending_approval, approved, settled, cancelled, rejected

  // Period
  periodStart    DateTime
  periodEnd      DateTime
  nettingDate    DateTime
  settlementDate DateTime

  // Currency
  baseCurrency String @default("EUR")

  // Totals
  totalReceivables  Decimal @default(0) @db.Decimal(15, 2)
  totalPayables     Decimal @default(0) @db.Decimal(15, 2)
  grossAmount       Decimal @default(0) @db.Decimal(15, 2)
  netAmount         Decimal @default(0) @db.Decimal(15, 2)
  savingsAmount     Decimal @default(0) @db.Decimal(15, 2)
  savingsPercentage Decimal @default(0) @db.Decimal(5, 2)

  // Approval Workflow
  createdById    String?
  createdByName  String?
  approvedBy     String?
  approvedByName String?
  approvedAt     DateTime?
  rejectedBy     String?
  rejectedByName String?
  rejectedAt     DateTime?
  rejectedReason String?

  // Meta
  notes String? @db.Text

  // Relations
  agreementId    String
  agreement      NettingAgreement @relation(fields: [agreementId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  positions   NettingPosition[]
  settlements SettlementInstruction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, sessionNumber])
  @@index([organizationId, status])
  @@index([organizationId, nettingDate])
  @@index([agreementId])
}

// Netting Position (per-party position within a session)
model NettingPosition {
  id String @id @default(cuid())

  // Party
  partyId   String
  partyName String
  partyType String @default("supplier")

  // Amounts
  receivables   Decimal @default(0) @db.Decimal(15, 2)
  payables      Decimal @default(0) @db.Decimal(15, 2)
  grossPosition Decimal @default(0) @db.Decimal(15, 2) // receivables - payables
  netPosition   Decimal @default(0) @db.Decimal(15, 2) // after netting

  // Counts
  receivableCount Int @default(0)
  payableCount    Int @default(0)

  // Settlement
  settlementDirection String  @default("none") // receive, pay, none
  settlementAmount    Decimal @default(0) @db.Decimal(15, 2)

  // Relations
  sessionId      String
  session        NettingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  nettingPartyId String?
  nettingParty   NettingParty?  @relation(fields: [nettingPartyId], references: [id])

  transactions NettingTransaction[]

  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([partyId])
}

// Netting Transaction (individual documents included in netting)
model NettingTransaction {
  id String @id @default(cuid())

  // Reference Document
  documentType   String // invoice, credit_note, debit_note, payment, advance
  documentNumber String
  documentDate   DateTime
  dueDate        DateTime

  // Counterparty
  counterpartyId   String
  counterpartyName String

  // Amount
  originalCurrency   String  @default("EUR")
  originalAmount     Decimal @db.Decimal(15, 2)
  baseCurrencyAmount Decimal @db.Decimal(15, 2)
  exchangeRate       Decimal @default(1) @db.Decimal(12, 6)

  // Direction
  direction String // receivable, payable

  // Inclusion
  included       Boolean @default(true)
  excludedReason String?

  // Relations
  positionId String
  position   NettingPosition @relation(fields: [positionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([positionId])
  @@index([documentNumber])
}

// Settlement Instruction (payment instructions from netting)
model SettlementInstruction {
  id                String @id @default(cuid())
  instructionNumber String

  // Payer
  payerId   String
  payerName String

  // Receiver
  receiverId   String
  receiverName String

  // Amount
  amount   Decimal @db.Decimal(15, 2)
  currency String  @default("EUR")

  // Method
  settlementMethod String @default("wire") // wire, ach, internal_transfer, netting_center, other

  // Bank Details
  payerBankAccount    String?
  receiverBankAccount String?

  // Status
  status String @default("pending") // pending, processing, completed, failed

  // Dates
  valueDate   DateTime
  processedAt DateTime?

  // Reference
  paymentReference String?

  // Relations
  sessionId      String
  session        NettingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([organizationId, instructionNumber])
  @@index([sessionId])
  @@index([organizationId, status])
}

// Offset Entry (AR/AP offsets outside netting sessions)
model OffsetEntry {
  id           String @id @default(cuid())
  offsetNumber String

  // Type
  type   String @default("ar_ap") // ar_ap, intercompany, advance, credit_application
  status String @default("draft") // draft, pending, approved, applied, reversed

  // Party
  partyId   String
  partyName String
  partyType String @default("customer") // customer, supplier, subsidiary, affiliate, joint_venture

  // Source Document (credit)
  sourceDocumentType   String
  sourceDocumentNumber String
  sourceAmount         Decimal @db.Decimal(15, 2)

  // Target Document (debit)
  targetDocumentType   String
  targetDocumentNumber String
  targetAmount         Decimal @db.Decimal(15, 2)

  // Offset
  offsetAmount Decimal @db.Decimal(15, 2)
  currency     String  @default("EUR")

  // Dates
  offsetDate    DateTime
  effectiveDate DateTime

  // Approval
  approvedBy   String?
  approvedAt   DateTime?
  approverName String?

  // Reversal
  reversedAt     DateTime?
  reversedBy     String?
  reversalReason String?

  // Meta
  notes String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, offsetNumber])
  @@index([organizationId, status])
  @@index([organizationId, partyId])
}

// Keep existing NettingOpportunity for simple bilateral netting
// (already exists in schema)

// =============================================================================
// OFFERS MODULE - Updated to match TypeScript types
// =============================================================================

model Offer {
  id          String @id @default(cuid())
  offerNumber String
  version     Int    @default(1)

  // Status
  status String @default("draft") // draft, sent, revised, accepted, rejected, expired, converted

  // Counterparty (stored as JSON for flexibility)
  counterparty Json // OfferCounterparty { id, name, email, phone, company, address, city, country, taxId, contactPerson }

  // For querying - denormalized
  customerId   String?
  customerName String

  // Dates
  offerDate    DateTime
  validityDays Int       @default(30)
  expiryDate   DateTime
  sentAt       DateTime?
  acceptedAt   DateTime?
  rejectedAt   DateTime?
  convertedAt  DateTime?

  // Terms
  currency      String  @default("EUR")
  paymentTerms  String  @default("net_30")
  deliveryTerms String?

  // Line Items (stored as JSON array)
  lineItems Json @default("[]") // OfferLineItem[]

  // Totals
  subtotal      Decimal @db.Decimal(15, 2)
  totalDiscount Decimal @default(0) @db.Decimal(15, 2)
  taxTotal      Decimal @db.Decimal(15, 2)
  grandTotal    Decimal @db.Decimal(15, 2)
  taxRate       Decimal @default(0) @db.Decimal(5, 2)

  // Margin Preview (internal)
  totalCost          Decimal? @db.Decimal(15, 2)
  grossMargin        Decimal? @db.Decimal(15, 2)
  grossMarginPercent Decimal? @db.Decimal(5, 2)

  // Notes & Terms
  internalNotes      String? @db.Text
  customerNotes      String? @db.Text
  termsAndConditions String? @db.Text
  disclaimer         String? @db.Text

  // Acceptance/Rejection
  acceptanceMethod String? // email, signature, click, verbal, written
  rejectionReason  String? @db.Text

  // Conversion
  convertedOrderId     String?
  convertedOrderNumber String?

  // Template
  templateId   String?
  templateName String?

  // Version History
  previousVersionId String?

  // Audit
  createdBy  String?
  updatedBy  String?
  sentBy     String?
  approvedBy String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  versions  OfferVersion[]
  auditLogs OfferAuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, offerNumber])
  @@index([organizationId, status])
  @@index([organizationId, customerId])
  @@index([organizationId, expiryDate])
}

model OfferVersion {
  id      String @id @default(cuid())
  offerId String
  offer   Offer  @relation(fields: [offerId], references: [id], onDelete: Cascade)

  version       Int
  changes       Json    @default("[]") // String[] of change descriptions
  revisionNotes String? @db.Text
  snapshotData  Json // Partial<Offer> snapshot

  createdBy String
  createdAt DateTime @default(now())

  @@unique([offerId, version])
  @@index([offerId])
}

model OfferAuditLog {
  id      String @id @default(cuid())
  offerId String
  offer   Offer  @relation(fields: [offerId], references: [id], onDelete: Cascade)

  offerNumber String
  action      String // created, edited, sent, revised, accepted, rejected, expired, converted, viewed

  details        String
  previousStatus String?
  newStatus      String?

  userId    String
  userName  String
  userRole  String?
  ipAddress String?
  metadata  Json?

  timestamp DateTime @default(now())

  @@index([offerId, timestamp])
  @@index([offerId, action])
}

model OfferTemplate {
  id          String  @id @default(cuid())
  name        String
  description String?
  category    String?

  // Default Values
  defaultCurrency           String  @default("EUR")
  defaultValidityDays       Int     @default(30)
  defaultPaymentTerms       String  @default("net_30")
  defaultDeliveryTerms      String?
  defaultTermsAndConditions String? @db.Text
  defaultDisclaimer         String  @db.Text

  // Default Line Items
  defaultLineItems Json @default("[]") // Partial<OfferLineItem>[]

  // Branding
  headerText String?
  footerText String?

  // Usage Stats
  usageCount Int       @default(0)
  lastUsedAt DateTime?

  // Meta
  isActive  Boolean @default(true)
  createdBy String

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, isActive])
  @@index([organizationId, category])
}

// =============================================================================
// TASK CENTER MODULE - Comprehensive Task & Risk Management
// =============================================================================

// Enhanced Task model
model Task {
  id String @id @default(cuid())

  // Basic Info
  title       String
  description String? @db.Text

  // Status & Priority
  status   String @default("open") // open, in_progress, blocked, awaiting_review, completed, cancelled, snoozed
  priority String @default("medium") // low, medium, high, critical

  // Type & Category
  type     String  @default("general") // general, approval, review, deadline, reminder, reconciliation, compliance
  category String? // finance, tax, compliance, operations, hr, other

  // Dates
  dueDate      DateTime?
  dueTime      String? // HH:MM for working hours awareness
  startDate    DateTime?
  completedAt  DateTime?
  snoozedUntil DateTime?
  reminderDate DateTime?

  // Assignment
  ownerId          String?
  ownerName        String?
  createdById      String?
  createdByName    String?
  assignmentReason String  @default("direct_assignment") // direct_assignment, rule_based, escalation, subscription, ownership

  // Source & Relations
  sourceSystem     String  @default("manual") // invoices, orders, receivables, liabilities, treasury, inventory, assets, tax, manual
  sourceEntityId   String?
  sourceEntityType String?

  // SLA
  slaDeadline DateTime?
  slaBreach   Boolean   @default(false)
  slaWarning  Boolean   @default(false)

  // Dependencies
  isBlocked Boolean @default(false)

  // Progress
  progress       Int      @default(0) // 0-100
  estimatedHours Decimal? @db.Decimal(5, 2)
  actualHours    Decimal? @db.Decimal(5, 2)

  // Flags
  hasUnreadUpdates Boolean @default(false)
  hasMentions      Boolean @default(false)

  // Recurrence
  isRecurring       Boolean @default(false)
  recurringInterval String? // daily, weekly, monthly, quarterly, yearly

  // Meta
  metadata Json? // Custom fields

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Subtasks
  parentId String?
  parent   Task?   @relation("TaskSubtasks", fields: [parentId], references: [id])
  subtasks Task[]  @relation("TaskSubtasks")

  // Related entities
  assignees     TaskAssignee[]
  watchers      TaskWatcher[]
  tags          TaskTagLink[]
  comments      TaskComment[]
  activities    TaskActivity[]
  attachments   TaskAttachment[]
  dependencies  TaskDependency[]   @relation("DependentTask")
  dependents    TaskDependency[]   @relation("BlockingTask")
  linkedRisks   TaskRiskLink[]
  notifications TaskNotification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, status])
  @@index([organizationId, priority])
  @@index([organizationId, ownerId])
  @@index([organizationId, dueDate])
  @@index([organizationId, sourceSystem])
  @@index([organizationId, slaBreach])
}

// Task Assignees (many-to-many)
model TaskAssignee {
  id String @id @default(cuid())

  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  userId   String
  userName String?
  email    String?
  avatar   String?

  assignedAt DateTime @default(now())
  assignedBy String?

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
}

// Task Watchers
model TaskWatcher {
  id String @id @default(cuid())

  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  userId   String
  userName String?

  watchingSince DateTime @default(now())

  @@unique([taskId, userId])
  @@index([taskId])
}

// Task Tags
model TaskTag {
  id String @id @default(cuid())

  name  String
  color String @default("gray")

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  tasks TaskTagLink[]

  createdAt DateTime @default(now())

  @@unique([organizationId, name])
  @@index([organizationId])
}

model TaskTagLink {
  id String @id @default(cuid())

  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  tagId String
  tag   TaskTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([taskId, tagId])
}

// Task Dependencies (blockers)
model TaskDependency {
  id String @id @default(cuid())

  // The task that is blocked
  dependentTaskId String
  dependentTask   Task   @relation("DependentTask", fields: [dependentTaskId], references: [id], onDelete: Cascade)

  // The task that is blocking
  blockingTaskId String
  blockingTask   Task   @relation("BlockingTask", fields: [blockingTaskId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([dependentTaskId, blockingTaskId])
  @@index([dependentTaskId])
  @@index([blockingTaskId])
}

// Task Comments
model TaskComment {
  id String @id @default(cuid())

  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // Content
  content String @db.Text

  // Author
  authorId   String
  authorName String

  // Threading
  parentId String?
  parent   TaskComment?  @relation("CommentThread", fields: [parentId], references: [id])
  replies  TaskComment[] @relation("CommentThread")

  // Mentions & Reactions
  mentions  String[] // User IDs mentioned
  reactions Json? // { emoji: [userId, ...] }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId])
  @@index([parentId])
}

// Task Activity (audit trail)
model TaskActivity {
  id String @id @default(cuid())

  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // Activity Type
  type String // created, updated, status_changed, assigned, commented, attachment_added, escalated, snoozed

  // Actor
  actorId   String
  actorName String

  // Details
  details       Json?
  previousValue String?
  newValue      String?

  timestamp DateTime @default(now())

  @@index([taskId, timestamp])
}

// Task Attachments
model TaskAttachment {
  id String @id @default(cuid())

  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // File Info
  name     String
  url      String
  fileType String
  size     Int // bytes

  // Upload Info
  uploadedBy     String
  uploadedByName String?

  uploadedAt DateTime @default(now())

  @@index([taskId])
}

// =============================================================================
// RISK MANAGEMENT
// =============================================================================

model Risk {
  id String @id @default(cuid())

  // Basic Info
  title       String
  description String? @db.Text

  // Classification
  severity    String @default("medium") // low, medium, high, critical
  likelihood  String @default("possible") // rare, unlikely, possible, likely, almost_certain
  impactScore Int    @default(0) // 1-25 (calculated: severity * likelihood)

  // Status
  status String @default("identified") // identified, assessing, mitigating, monitoring, resolved, accepted, escalated

  // Dates
  identifiedAt         DateTime  @default(now())
  targetMitigationDate DateTime?
  resolvedAt           DateTime?
  lastUpdatedAt        DateTime  @default(now())

  // Ownership
  ownerId         String?
  ownerName       String?
  escalatedTo     String?
  escalatedToName String?

  // Impact
  impactAreas         String[] // finance, operations, compliance, reputation, etc.
  affectedSystemId    String?
  affectedSystemName  String?
  affectedProjectId   String?
  affectedProjectName String?
  blastRadius         String   @default("isolated") // isolated, team, department, organization

  // Mitigation
  mitigationPlan     String? @db.Text
  mitigationProgress Int     @default(0) // 0-100

  // Source
  sourceSystem   String? // Same as task source systems
  sourceEntityId String?

  // Flags
  isNewlyEscalated    Boolean @default(false)
  isStale             Boolean @default(false) // No update in X days
  isMitigationOverdue Boolean @default(false)

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  mitigationSteps RiskMitigationStep[]
  linkedTasks     TaskRiskLink[]
  comments        RiskComment[]
  activities      RiskActivity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, status])
  @@index([organizationId, severity])
  @@index([organizationId, ownerId])
}

// Risk Mitigation Steps
model RiskMitigationStep {
  id String @id @default(cuid())

  riskId String
  risk   Risk   @relation(fields: [riskId], references: [id], onDelete: Cascade)

  // Step Details
  description String
  orderIndex  Int    @default(0)

  // Assignment
  ownerId   String?
  ownerName String?
  deadline  DateTime?

  // Status
  status      String    @default("pending") // pending, in_progress, completed, skipped
  completedAt DateTime?

  createdAt DateTime @default(now())

  @@index([riskId])
}

// Task-Risk Links
model TaskRiskLink {
  id String @id @default(cuid())

  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  riskId String
  risk   Risk   @relation(fields: [riskId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([taskId, riskId])
}

// Risk Comments
model RiskComment {
  id String @id @default(cuid())

  riskId String
  risk   Risk   @relation(fields: [riskId], references: [id], onDelete: Cascade)

  content    String @db.Text
  authorId   String
  authorName String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([riskId])
}

// Risk Activity
model RiskActivity {
  id String @id @default(cuid())

  riskId String
  risk   Risk   @relation(fields: [riskId], references: [id], onDelete: Cascade)

  type          String // created, updated, status_changed, escalated, mitigated, etc.
  actorId       String
  actorName     String
  details       Json?
  previousValue String?
  newValue      String?

  timestamp DateTime @default(now())

  @@index([riskId, timestamp])
}

// =============================================================================
// NOTIFICATIONS & SAVED FILTERS
// =============================================================================

model TaskNotification {
  id String @id @default(cuid())

  // Type
  type String // assignment, mention, escalation, sla_breach, comment, status_change, due_soon, overdue

  // Content
  title   String
  message String

  // Reference
  taskId String?
  task   Task?   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  riskId String?

  // Actor
  actorId   String?
  actorName String?

  // Recipient
  recipientId String

  // Status
  isRead Boolean   @default(false)
  readAt DateTime?

  timestamp DateTime @default(now())

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([recipientId, isRead])
  @@index([organizationId, recipientId])
}

model SavedTaskFilter {
  id String @id @default(cuid())

  name    String
  icon    String?
  filters Json // TaskFilter object

  // Sharing
  isDefault Boolean @default(false)
  isShared  Boolean @default(false)
  createdBy String

  orderIndex Int @default(0)

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, createdBy])
}

// =============================================================================
// FORECAST MODULE - Updated to match TypeScript types
// =============================================================================

// Revenue Forecast
model RevenueForecast {
  id         String  @id @default(cuid())
  version    String  @default("latest") // baseline, latest, locked, scenario
  scenarioId String?

  // Time Settings
  timeHorizon String @default("quarter") // month, quarter, year
  granularity String @default("monthly") // weekly, monthly, quarterly
  currency    String @default("EUR")

  // Summary Totals
  totalExpected    Decimal @default(0) @db.Decimal(15, 2)
  totalBestCase    Decimal @default(0) @db.Decimal(15, 2)
  totalWorstCase   Decimal @default(0) @db.Decimal(15, 2)
  committedRevenue Decimal @default(0) @db.Decimal(15, 2)
  projectedRevenue Decimal @default(0) @db.Decimal(15, 2)
  atRiskRevenue    Decimal @default(0) @db.Decimal(15, 2)

  // By Dimension (JSON for flexibility)
  byProduct Json @default("{}")
  bySegment Json @default("{}")
  byRegion  Json @default("{}")
  byType    Json @default("{}") // contract, usage_based, one_time, recurring

  // Meta
  dataSource    String?
  confidence    String  @default("medium") // low, medium, high
  lastUpdatedBy String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  lineItems   RevenueLineItem[]
  annotations ForecastAnnotation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, version])
  @@index([organizationId, scenarioId])
}

model RevenueLineItem {
  id   String @id @default(cuid())
  name String

  // Classification
  category     String  @default("product") // product, service, subscription, other
  revenueType  String  @default("recurring") // contract, usage_based, one_time, recurring
  segment      String?
  region       String?
  customerId   String?
  customerName String?

  // Period Values (JSON: { "period-0": { expected, bestCase, worstCase, confidence, confidenceScore } })
  periods Json @default("{}")

  // Flags
  isCommitted     Boolean @default(false)
  isAtRisk        Boolean @default(false)
  isRenewal       Boolean @default(false)
  hasUpsell       Boolean @default(false)
  hasDownsell     Boolean @default(false)
  highUncertainty Boolean @default(false)

  // Drivers & Notes
  drivers String[] // Array of driver descriptions

  // Confidence
  confidence      String @default("medium") // low, medium, high
  confidenceScore Int    @default(50) // 0-100

  // Relations
  revenueForecastId String
  revenueForecast   RevenueForecast @relation(fields: [revenueForecastId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([revenueForecastId])
  @@index([revenueForecastId, category])
}

// Cost Forecast
model CostForecast {
  id         String  @id @default(cuid())
  version    String  @default("latest") // baseline, latest, locked, scenario
  scenarioId String?

  // Time Settings
  timeHorizon String @default("quarter") // month, quarter, year
  granularity String @default("monthly") // weekly, monthly, quarterly
  currency    String @default("EUR")

  // Summary Totals
  totalExpected  Decimal @default(0) @db.Decimal(15, 2)
  totalBestCase  Decimal @default(0) @db.Decimal(15, 2)
  totalWorstCase Decimal @default(0) @db.Decimal(15, 2)
  committedCosts Decimal @default(0) @db.Decimal(15, 2)
  estimatedCosts Decimal @default(0) @db.Decimal(15, 2)

  // By Dimension (JSON for flexibility)
  byCategory   Json @default("{}") // fixed, variable, discretionary, one_time
  byDepartment Json @default("{}")
  byVendor     Json @default("{}")
  byProject    Json @default("{}")

  // Alerts
  overrunCount        Int     @default(0)
  unplannedSpendTotal Decimal @default(0) @db.Decimal(15, 2)

  // Meta
  dataSource    String?
  confidence    String  @default("medium") // low, medium, high
  lastUpdatedBy String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  lineItems   CostLineItem[]
  annotations ForecastAnnotation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, version])
  @@index([organizationId, scenarioId])
}

model CostLineItem {
  id   String @id @default(cuid())
  name String

  // Classification
  category    String  @default("fixed") // fixed, variable, discretionary, one_time
  department  String?
  costCenter  String?
  vendorId    String?
  vendorName  String?
  projectId   String?
  projectName String?

  // Period Values (JSON: { "period-0": { expected, bestCase, worstCase, confidence, confidenceScore } })
  periods Json @default("{}")

  // Flags
  isCommitted           Boolean @default(false)
  isContractual         Boolean @default(false)
  hasStepChange         Boolean @default(false)
  stepChangeDescription String?
  isOverrun             Boolean @default(false)
  isUnplanned           Boolean @default(false)

  // Drivers & Notes
  drivers        String[] // Array of driver descriptions
  scenarioImpact String? // e.g., "+10% volume growth impact"

  // Confidence
  confidence      String @default("medium") // low, medium, high
  confidenceScore Int    @default(50) // 0-100

  // Relations
  costForecastId String
  costForecast   CostForecast @relation(fields: [costForecastId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([costForecastId])
  @@index([costForecastId, category])
}

// Cash Forecast
model CashForecast {
  id         String  @id @default(cuid())
  version    String  @default("latest") // baseline, latest, locked, scenario
  scenarioId String?

  // Time Settings
  timeHorizon String @default("quarter") // month, quarter, year
  granularity String @default("monthly") // weekly, monthly, quarterly
  currency    String @default("EUR")

  // Current Position
  currentCashBalance Decimal @default(0) @db.Decimal(15, 2)

  // Key Metrics
  minimumCashRunway       Int       @default(0) // days
  covenantThreshold       Decimal   @default(0) @db.Decimal(15, 2)
  projectedMinimumBalance Decimal   @default(0) @db.Decimal(15, 2)
  projectedMinimumDate    DateTime?

  // Drivers
  avgCollectionDays  Int     @default(30)
  avgPaymentTerms    Int     @default(30)
  delayedReceivables Decimal @default(0) @db.Decimal(15, 2)

  // Flags
  hasNegativePeriods Boolean @default(false)
  hasCriticalPeriods Boolean @default(false)
  covenantAtRisk     Boolean @default(false)

  // Stress Scenarios (JSON array)
  stressScenarios Json @default("[]")

  // Meta
  dataSource    String?
  confidence    String  @default("medium") // low, medium, high
  lastUpdatedBy String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  periods     CashForecastPeriod[]
  annotations ForecastAnnotation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, version])
  @@index([organizationId, scenarioId])
}

model CashForecastPeriod {
  id          String   @id @default(cuid())
  periodId    String // Internal reference
  periodLabel String // e.g., "Jan 2025", "Q1 2025"
  startDate   DateTime
  endDate     DateTime

  // Balances
  openingBalance Decimal @db.Decimal(15, 2)
  closingBalance Decimal @db.Decimal(15, 2)
  netCashFlow    Decimal @db.Decimal(15, 2)

  // Cash In (JSON: { expected, bestCase, worstCase, confidence, confidenceScore })
  cashIn          Json @default("{}")
  cashInBreakdown Json @default("{}") // { collections, otherReceipts, financing }

  // Cash Out (JSON: { expected, bestCase, worstCase, confidence, confidenceScore })
  cashOut          Json @default("{}")
  cashOutBreakdown Json @default("{}") // { payroll, vendors, taxes, debtService, capex, other }

  // Flags
  isNegative       Boolean @default(false)
  isCritical       Boolean @default(false)
  breachesMinimum  Boolean @default(false)
  breachesCovenant Boolean @default(false)

  // Confidence
  confidence String @default("medium") // low, medium, high

  // Relations
  cashForecastId String
  cashForecast   CashForecast @relation(fields: [cashForecastId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cashForecastId, periodId])
  @@index([cashForecastId])
}

// Forecast Scenario (enhanced from existing Scenario model)
model ForecastScenario {
  id          String  @id @default(cuid())
  name        String
  type        String  @default("base") // base, optimistic, pessimistic, custom
  description String? @db.Text

  // Linked Forecast IDs
  revenueForecastId String?
  costForecastId    String?
  cashForecastId    String?

  // Summary Deltas vs Base
  revenueVsBase Decimal @default(0) @db.Decimal(15, 2)
  costVsBase    Decimal @default(0) @db.Decimal(15, 2)
  cashVsBase    Decimal @default(0) @db.Decimal(15, 2)
  netVsBase     Decimal @default(0) @db.Decimal(15, 2)

  // Status
  isLocked Boolean @default(false)
  isActive Boolean @default(true)

  // Meta
  createdBy     String?
  lastUpdatedBy String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  assumptions ForecastAssumption[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, type])
  @@index([organizationId, isActive])
}

model ForecastAssumption {
  id       String @id @default(cuid())
  name     String
  category String @default("other") // growth, churn, inflation, fx, payment, volume, pricing, other

  // Value
  value Decimal @db.Decimal(15, 4)
  unit  String  @default("percentage") // percentage, amount, days, multiplier

  // Details
  description       String?
  impactedForecasts String[] // Array of: revenue, cost, cash

  // Editability
  isEditable    Boolean @default(true)
  lastUpdatedBy String?

  // Relations
  scenarioId String
  scenario   ForecastScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([scenarioId])
  @@index([scenarioId, category])
}

model ForecastAlert {
  id       String @id @default(cuid())
  type     String // revenue_shortfall, cost_overrun, cash_runway_breach, covenant_breach, negative_cash, material_variance, stale_assumption, missing_input, confidence_low
  severity String @default("medium") // low, medium, high, critical

  // Content
  title   String
  message String @db.Text

  // Context
  forecastType String // revenue, cost, cash, all
  periodId     String?
  lineItemId   String?

  // Threshold
  threshold    Decimal? @db.Decimal(15, 2)
  currentValue Decimal? @db.Decimal(15, 2)

  // Status
  isRead      Boolean @default(false)
  isDismissed Boolean @default(false)

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([organizationId, isRead])
  @@index([organizationId, severity])
  @@index([organizationId, forecastType])
}

model ForecastAnnotation {
  id      String @id @default(cuid())
  content String @db.Text

  // Author
  authorId   String
  authorName String

  // Context
  lineItemId String?
  periodId   String?

  // Relations - can belong to any forecast type
  revenueForecastId String?
  revenueForecast   RevenueForecast? @relation(fields: [revenueForecastId], references: [id], onDelete: Cascade)

  costForecastId String?
  costForecast   CostForecast? @relation(fields: [costForecastId], references: [id], onDelete: Cascade)

  cashForecastId String?
  cashForecast   CashForecast? @relation(fields: [cashForecastId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([revenueForecastId])
  @@index([costForecastId])
  @@index([cashForecastId])
}

model ForecastVariance {
  id          String @id @default(cuid())
  periodId    String
  periodLabel String

  // Revenue Variance
  revenueForecast    Decimal @db.Decimal(15, 2)
  revenueActual      Decimal @db.Decimal(15, 2)
  revenueVariance    Decimal @db.Decimal(15, 2)
  revenueVariancePct Decimal @db.Decimal(5, 2)

  // Cost Variance
  costForecast    Decimal @db.Decimal(15, 2)
  costActual      Decimal @db.Decimal(15, 2)
  costVariance    Decimal @db.Decimal(15, 2)
  costVariancePct Decimal @db.Decimal(5, 2)

  // Cash Variance
  cashForecast    Decimal @db.Decimal(15, 2)
  cashActual      Decimal @db.Decimal(15, 2)
  cashVariance    Decimal @db.Decimal(15, 2)
  cashVariancePct Decimal @db.Decimal(5, 2)

  // Net Variance
  netForecast    Decimal @db.Decimal(15, 2)
  netActual      Decimal @db.Decimal(15, 2)
  netVariance    Decimal @db.Decimal(15, 2)
  netVariancePct Decimal @db.Decimal(5, 2)

  // Attribution (JSON array)
  revenueAttribution Json @default("[]")
  costAttribution    Json @default("[]")
  cashAttribution    Json @default("[]")

  // Flags
  hasMaterialVariance       Boolean @default(false)
  varianceThresholdBreached Boolean @default(false)

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, periodId])
  @@index([organizationId])
}

// =============================================================================
// SCENARIO MODULE - Updated to match TypeScript types
// =============================================================================

model Scenario {
  id          String  @id @default(cuid())
  name        String
  description String? @db.Text

  // Classification
  caseType   String @default("custom") // best_case, expected_case, worst_case, custom
  status     String @default("draft") // draft, reviewed, approved, locked, archived
  visibility String @default("personal") // personal, team, org_wide

  // Calculated Metrics (JSON for complex structure)
  metrics Json @default("{}") // ScenarioMetrics

  // Confidence
  confidenceLevel     String   @default("medium") // low, medium, high
  confidenceScore     Int      @default(50) // 0-100
  uncertaintyBandLow  Decimal? @db.Decimal(15, 2)
  uncertaintyBandHigh Decimal? @db.Decimal(15, 2)

  // Lineage
  derivedFromId   String?
  derivedFromName String?

  // Ownership
  ownerId         String
  ownerName       String
  sharedWithTeams String[] // Array of team IDs

  // Versioning
  version           Int     @default(1)
  previousVersionId String?

  // Tags
  tags String[]

  // Audit
  createdBy      String
  lastModifiedBy String?
  lockedAt       DateTime?
  lockedBy       String?
  approvedAt     DateTime?
  approvedBy     String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  assumptions  ScenarioAssumption[]
  comments     ScenarioComment[]
  decisions    ScenarioDecision[]
  changeEvents ScenarioChangeEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, status])
  @@index([organizationId, caseType])
  @@index([organizationId, ownerId])
  @@index([organizationId, visibility])
}

model ScenarioAssumption {
  id       String @id @default(cuid())
  name     String
  category String @default("other") // growth, pricing, volume, churn, cost_inflation, fx, payment_terms, headcount, capex, other

  // Values
  baseValue    Decimal @db.Decimal(15, 4)
  currentValue Decimal @db.Decimal(15, 4)
  unit         String  @default("percentage") // percentage, amount, days, multiplier, count

  // Configuration
  description     String?
  isProtected     Boolean  @default(false) // Cannot be edited in predefined scenarios
  isOverridden    Boolean  @default(false)
  minValue        Decimal? @db.Decimal(15, 4)
  maxValue        Decimal? @db.Decimal(15, 4)
  step            Decimal? @db.Decimal(15, 4)
  impactedMetrics String[] // Array of: revenue, cost, cash, net

  // Audit
  lastModifiedAt DateTime?
  lastModifiedBy String?

  // Relations
  scenarioId String
  scenario   Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([scenarioId])
  @@index([scenarioId, category])
}

model StressTest {
  id          String  @id @default(cuid())
  name        String
  description String? @db.Text
  type        String  @default("combined") // revenue_shock, demand_drop, cost_spike, delayed_collections, fx_shock, combined
  isTemplate  Boolean @default(false)

  // Parameters (JSON array)
  parameters Json @default("[]") // StressTestParameter[]

  // Intensity
  intensity String @default("moderate") // mild, moderate, severe, extreme

  // Results
  result        String @default("pass") // pass, warning, fail
  resultMetrics Json   @default("{}") // ScenarioMetrics

  // Threshold Analysis (JSON array)
  thresholds Json @default("[]") // StressTestThreshold[]

  // Critical Points
  cashShortfallPoint  DateTime?
  covenantBreachPoint DateTime?
  marginCollapsePoint DateTime?

  // For templates
  defaultIntensities Json? // number[] for templates

  // Meta
  lastRunAt DateTime?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, type])
  @@index([organizationId, isTemplate])
  @@index([organizationId, result])
}

model SimulationState {
  id   String  @id @default(cuid())
  name String?

  // Drivers (JSON array of SimulationDriver)
  drivers Json @default("[]")

  // Result Metrics
  resultMetrics Json @default("{}")

  // Comparison
  comparisonBaselineId String

  // Pinning
  isPinned           Boolean @default(false)
  pinnedAsScenarioId String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  userId String // User who owns this simulation state

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, userId])
  @@index([organizationId, isPinned])
}

model ScenarioComment {
  id         String   @id @default(cuid())
  scenarioId String
  scenario   Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  content    String @db.Text
  authorId   String
  authorName String

  // Threading
  parentId String? // For threaded comments

  // Resolution
  isResolved Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([scenarioId])
  @@index([scenarioId, isResolved])
}

model ScenarioDecision {
  id         String   @id @default(cuid())
  scenarioId String
  scenario   Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  type      String // reviewed, approved, rejected, deferred
  decision  String
  rationale String? @db.Text

  // Decision maker
  decidedBy     String
  decidedByName String
  decidedAt     DateTime @default(now())

  createdAt DateTime @default(now())

  @@index([scenarioId])
  @@index([scenarioId, type])
}

model ScenarioChangeEvent {
  id         String   @id @default(cuid())
  scenarioId String
  scenario   Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  // Change details
  changeType String // created, assumption_changed, status_changed, locked, approved, cloned, archived

  // For assumption changes
  assumptionId   String?
  assumptionName String?
  previousValue  Decimal? @db.Decimal(15, 4)
  newValue       Decimal? @db.Decimal(15, 4)

  // For status changes
  previousStatus String?
  newStatus      String?

  description String

  // Actor
  userId   String
  userName String

  timestamp DateTime @default(now())

  @@index([scenarioId, timestamp])
  @@index([scenarioId, changeType])
}

// =============================================================================
// KPI MODULE - Enhanced schema
// =============================================================================

// Enhanced KPI model
model KPI {
  id String @id @default(cuid())

  // Basic Info
  code        String
  name        String
  shortName   String?
  description String? @db.Text
  category    String // margins, burn_runway, cash_conversion, unit_economics, growth, efficiency

  // Configuration
  calculationType String   @default("formula") // formula, manual, derived, aggregated
  formula         String? // e.g., "(revenue - cogs) / revenue * 100"
  dataSource      String? // Where data comes from
  dataSources     String[] // Multiple source references
  unit            String   @default("number") // number, percentage, currency, days, ratio, months

  // Display Format
  format         String  @default("0.0") // Format pattern for display
  higherIsBetter Boolean @default(true) // For determining trend direction

  // Current Value
  currentValue  Decimal? @db.Decimal(15, 4)
  previousValue Decimal? @db.Decimal(15, 4)
  targetValue   Decimal? @db.Decimal(15, 4)
  baselineValue Decimal? @db.Decimal(15, 4)

  // Rolling Averages
  rollingAvg3M  Decimal? @db.Decimal(15, 4)
  rollingAvg6M  Decimal? @db.Decimal(15, 4)
  rollingAvg12M Decimal? @db.Decimal(15, 4)

  // Variance
  deltaVsPrior         Decimal? @db.Decimal(15, 4)
  deltaVsPriorPercent  Decimal? @db.Decimal(8, 4)
  deltaVsTarget        Decimal? @db.Decimal(15, 4)
  deltaVsTargetPercent Decimal? @db.Decimal(8, 4)

  // Status & Trend
  status        String @default("on_track") // on_track, watch, off_track
  trend         String @default("stable") // improving, stable, deteriorating
  trendMomentum String @default("steady") // accelerating, steady, decelerating

  // Data Quality
  dataFreshness    String   @default("fresh") // fresh, stale, outdated
  lastCalculatedAt DateTime @default(now())

  // Thresholds
  thresholds Json? // { softMin, softMax, hardMin, hardMax, targetMin, targetMax }

  // Seasonality & Anomaly
  seasonalityFactor Decimal? @db.Decimal(8, 4)
  volatility        Decimal? @db.Decimal(8, 4) // Standard deviation
  isAnomaly         Boolean  @default(false)

  // Display
  displayOrder Int     @default(0)
  isVisible    Boolean @default(true)
  isPinned     Boolean @default(false)

  // Meta
  tags  String[]
  notes String?  @db.Text

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  history    KPIHistory[]
  alerts     KPIAlert[]
  targets    KPITarget[]
  benchmarks KPIBenchmark[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, code])
  @@index([organizationId, category])
  @@index([organizationId, status])
  @@index([organizationId, isPinned])
}

// Enhanced KPIHistory
model KPIHistory {
  id String @id @default(cuid())

  // Period
  periodType  String // daily, weekly, monthly, quarterly, yearly
  periodStart DateTime
  periodEnd   DateTime
  periodLabel String // e.g., "2025-01", "Q1 2025"

  // Values
  value         Decimal  @db.Decimal(15, 4)
  targetValue   Decimal? @db.Decimal(15, 4)
  previousValue Decimal? @db.Decimal(15, 4)

  // Variance
  vsTarget   Decimal? @db.Decimal(15, 4)
  vsPrevious Decimal? @db.Decimal(15, 4)

  // Status at time
  status String?
  trend  String?

  // Annotations
  isAnomaly  Boolean @default(false)
  annotation String?

  // Relations
  kpiId String
  kpi   KPI    @relation(fields: [kpiId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([kpiId, periodStart])
  @@index([kpiId, periodType])
}

// KPI Alerts
model KPIAlert {
  id String @id @default(cuid())

  // Alert Type
  type     String // margin_compression, runway_low, burn_acceleration, ccc_deterioration, unit_economics_negative, threshold_breach, trend_break, target_divergence
  severity String @default("warning") // info, warning, critical

  // Context
  title   String
  message String @db.Text

  // Values
  currentValue Decimal  @db.Decimal(15, 4)
  threshold    Decimal? @db.Decimal(15, 4)
  deviation    Decimal? @db.Decimal(15, 4)

  // Suggested Action
  suggestedAction String? @db.Text

  // Status
  isRead      Boolean   @default(false)
  isDismissed Boolean   @default(false)
  readAt      DateTime?
  dismissedAt DateTime?
  dismissedBy String?

  // Trigger
  triggeredAt DateTime @default(now())

  // Relations
  kpiId          String
  kpi            KPI          @relation(fields: [kpiId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, isDismissed])
  @@index([organizationId, severity])
  @@index([kpiId, triggeredAt])
}

// KPI Targets (period-specific)
model KPITarget {
  id String @id @default(cuid())

  // Period
  periodType  String // monthly, quarterly, yearly
  periodStart DateTime
  periodEnd   DateTime
  periodLabel String

  // Target Values
  targetValue  Decimal  @db.Decimal(15, 4)
  stretchValue Decimal? @db.Decimal(15, 4) // Stretch goal
  minimumValue Decimal? @db.Decimal(15, 4) // Floor

  // Status
  status String @default("active") // active, achieved, missed, in_progress

  // Achievement
  actualValue        Decimal? @db.Decimal(15, 4)
  achievementPercent Decimal? @db.Decimal(8, 4)

  // Notes
  notes String?

  // Relations
  kpiId String
  kpi   KPI    @relation(fields: [kpiId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([kpiId, periodLabel])
  @@index([kpiId, periodStart])
}

// KPI Benchmarks
model KPIBenchmark {
  id String @id @default(cuid())

  // Benchmark Source
  source     String // industry, peer_group, internal, external
  sourceName String // e.g., "SaaS Industry Average", "Top Quartile"

  // Values
  value      Decimal  @db.Decimal(15, 4)
  percentile Decimal? @db.Decimal(5, 2) // If applicable
  rangeMin   Decimal? @db.Decimal(15, 4)
  rangeMax   Decimal? @db.Decimal(15, 4)

  // Validity
  validFrom DateTime
  validTo   DateTime?
  isActive  Boolean   @default(true)

  // Meta
  notes String?

  // Relations
  kpiId String
  kpi   KPI    @relation(fields: [kpiId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([kpiId, isActive])
}

// =============================================================================
// FX MODULE - Updated to match TypeScript types
// =============================================================================

// Enhanced FXRate model
model FXRate {
  id String @id @default(cuid())

  // Currency Pair
  baseCurrency  String
  quoteCurrency String

  // Rates
  rate        Decimal @db.Decimal(12, 6)
  inverseRate Decimal @db.Decimal(12, 6)

  // Source & Timing
  source     String    @default("manual") // manual, ecb, fed, bank, provider, internal, market
  timestamp  DateTime  @default(now())
  validUntil DateTime?

  // Spread
  spread Decimal? @db.Decimal(8, 6)

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([organizationId, baseCurrency, quoteCurrency, timestamp])
  @@index([organizationId, baseCurrency, quoteCurrency])
  @@index([organizationId, timestamp])
}

// Enhanced FXExposure to support aggregated CurrencyExposure view
model FXExposure {
  id String @id @default(cuid())

  // Currency Pair
  baseCurrency  String // e.g., "EUR"
  quoteCurrency String // e.g., "USD"

  // Exposure Type & Classification
  type        String @default("transactional") // transactional, cash, operational, structural
  direction   String @default("inflow") // inflow, outflow, both
  timeHorizon String @default("short_term") // short_term, medium_term, long_term
  status      String @default("open") // open, hedged, partial_hedged, closed

  // Amounts
  grossExposure   Decimal @db.Decimal(15, 2)
  netExposure     Decimal @db.Decimal(15, 2)
  hedgedAmount    Decimal @default(0) @db.Decimal(15, 2)
  unhedgedAmount  Decimal @db.Decimal(15, 2)
  hedgePercentage Decimal @default(0) @db.Decimal(5, 2)

  // Breakdown
  receivables         Decimal @default(0) @db.Decimal(15, 2)
  payables            Decimal @default(0) @db.Decimal(15, 2)
  cashBalance         Decimal @default(0) @db.Decimal(15, 2)
  operationalInflows  Decimal @default(0) @db.Decimal(15, 2)
  operationalOutflows Decimal @default(0) @db.Decimal(15, 2)
  structuralPositions Decimal @default(0) @db.Decimal(15, 2)

  // Entity (for multi-entity)
  entityId   String?
  entityName String?

  // Rates
  spotRate    Decimal  @db.Decimal(12, 6)
  bookingRate Decimal? @db.Decimal(12, 6)
  currentRate Decimal? @db.Decimal(12, 6)
  targetRate  Decimal? @db.Decimal(12, 6)

  // Valuation
  baseCurrencyValue Decimal  @db.Decimal(15, 2)
  valuationDate     DateTime @default(now())

  // Risk
  riskLevel     String   @default("low") // low, moderate, elevated, high, critical
  volatility30d Decimal? @db.Decimal(8, 4)
  var95         Decimal? @db.Decimal(15, 2) // Value at Risk 95%

  // Gain/Loss
  unrealizedGainLoss Decimal @default(0) @db.Decimal(15, 2)
  realizedGainLoss   Decimal @default(0) @db.Decimal(15, 2)

  // Dates
  exposureDate   DateTime
  settlementDate DateTime?
  maturityDate   DateTime?

  // Reference
  referenceType String? // invoice, order, contract, forecast
  referenceId   String?
  counterparty  String?

  // Data Quality
  dataQuality String @default("complete") // complete, partial, estimated

  // Meta
  notes String? @db.Text

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, baseCurrency, quoteCurrency])
  @@index([organizationId, status])
  @@index([organizationId, type])
  @@index([organizationId, maturityDate])
  @@index([organizationId, riskLevel])
}

// FX Conversion (currency exchanges)
model FXConversion {
  id               String @id @default(cuid())
  conversionNumber String

  // Currencies
  sourceCurrency String
  targetCurrency String

  // Amounts
  sourceAmount Decimal @db.Decimal(15, 2)
  targetAmount Decimal @db.Decimal(15, 2)

  // Rate
  appliedRate   Decimal  @db.Decimal(12, 6)
  referenceRate Decimal? @db.Decimal(12, 6)
  rateDeviation Decimal? @db.Decimal(8, 4) // Percentage deviation from reference
  rateSource    String   @default("bank") // ecb, fed, bank, provider, internal, market

  // Costs
  spreadCost    Decimal @default(0) @db.Decimal(15, 2)
  feeCost       Decimal @default(0) @db.Decimal(15, 2)
  totalCost     Decimal @default(0) @db.Decimal(15, 2)
  effectiveRate Decimal @db.Decimal(12, 6)

  // Execution
  executionChannel String? // online, phone, branch, api
  counterparty     String?

  // Dates
  conversionDate DateTime
  valueDate      DateTime
  settlementDate DateTime?

  // Status
  status String @default("pending") // pending, completed, failed, cancelled

  // Reference
  purpose          String?
  relatedDocuments String[] // Array of document references

  // Audit
  initiatedBy String?
  approvedBy  String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, conversionNumber])
  @@index([organizationId, status])
  @@index([organizationId, conversionDate])
  @@index([organizationId, sourceCurrency, targetCurrency])
}

// FX Scenario (what-if analysis)
model FXScenario {
  id           String  @id @default(cuid())
  name         String
  description  String? @db.Text
  baseCurrency String  @default("EUR")

  // Rate Assumptions (JSON: { currency: { currentRate, scenarioRate, changePercent } })
  rateAssumptions Json @default("[]")

  // Impact
  totalExposureImpact Decimal @default(0) @db.Decimal(15, 2)
  revenueImpact       Decimal @default(0) @db.Decimal(15, 2)
  costImpact          Decimal @default(0) @db.Decimal(15, 2)
  cashImpact          Decimal @default(0) @db.Decimal(15, 2)

  // Classification
  scenarioType String   @default("sensitivity") // stress_test, sensitivity, budget, custom
  severity     String   @default("moderate") // mild, moderate, severe
  probability  Decimal? @db.Decimal(5, 2) // 0-100%

  // Status
  isActive Boolean @default(true)

  // Meta (always hypothetical)
  isHypothetical Boolean @default(true)

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, isActive])
  @@index([organizationId, scenarioType])
}

// FX Forecast
model FXForecast {
  id            String @id @default(cuid())
  name          String
  baseCurrency  String @default("EUR")
  horizonMonths Int    @default(12)

  // Projected Exposures (JSON array)
  projectedExposures Json @default("[]")

  // Assumptions
  assumptions String[] // Array of assumption descriptions

  // Status
  status String @default("draft") // draft, active, archived

  // Meta
  isHypothetical Boolean @default(true)

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, status])
}

// FX Cost tracking
model FXCost {
  id           String @id @default(cuid())
  period       String // e.g., "2025-01", "2025-Q1"
  baseCurrency String @default("EUR")

  // Explicit Costs
  spreadCosts        Decimal @default(0) @db.Decimal(15, 2)
  transactionFees    Decimal @default(0) @db.Decimal(15, 2)
  bankCharges        Decimal @default(0) @db.Decimal(15, 2)
  totalExplicitCosts Decimal @default(0) @db.Decimal(15, 2)

  // Implicit Costs
  rateDeviationImpact Decimal @default(0) @db.Decimal(15, 2)
  timingImpact        Decimal @default(0) @db.Decimal(15, 2)
  totalImplicitCosts  Decimal @default(0) @db.Decimal(15, 2)

  // Total
  totalFXCosts          Decimal @default(0) @db.Decimal(15, 2)
  costAsPercentOfVolume Decimal @default(0) @db.Decimal(5, 4)

  // P&L Impact
  revenueImpact Decimal @default(0) @db.Decimal(15, 2)
  costImpact    Decimal @default(0) @db.Decimal(15, 2)
  cashImpact    Decimal @default(0) @db.Decimal(15, 2)
  netPnLImpact  Decimal @default(0) @db.Decimal(15, 2)

  // Comparison
  priorPeriodCosts     Decimal? @db.Decimal(15, 2)
  changeVsPrior        Decimal? @db.Decimal(15, 2)
  changePercentVsPrior Decimal? @db.Decimal(5, 2)

  // Meta
  calculationMethod String   @default("actual")
  referenceRateUsed String?
  lastCalculated    DateTime @default(now())

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, period])
  @@index([organizationId])
}

// FX Risk Indicator
model FXRiskIndicator {
  id String @id @default(cuid())

  type        String // concentration, volatility, mismatch, unhedged, provider, timing
  title       String
  description String @db.Text

  // Risk Assessment
  riskLevel String  @default("low") // low, moderate, elevated, high, critical
  metric    Decimal @db.Decimal(15, 4)
  threshold Decimal @db.Decimal(15, 4)
  breached  Boolean @default(false)

  // Context
  currency       String?
  recommendation String? @db.Text

  // Status
  isActive     Boolean  @default(true)
  lastAssessed DateTime @default(now())

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, isActive])
  @@index([organizationId, riskLevel])
  @@index([organizationId, type])
}

// FX Audit Log
model FXAuditLog {
  id String @id @default(cuid())

  action   String // view, refresh, filter, export, rate_update, conversion_create, etc.
  category String // rate, conversion, exposure, scenario, access

  // Details
  details  String  @db.Text
  oldValue String?
  newValue String?

  // User
  userId    String?
  userName  String?
  ipAddress String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  timestamp DateTime @default(now())

  @@index([organizationId, timestamp])
  @@index([organizationId, category])
  @@index([organizationId, action])
}

// =============================================================================
// INVESTOR MODULE - Additional models for Dashboard & Reporting
// =============================================================================

// Point-in-time financial snapshot for board reporting
model InvestorSnapshot {
  id String @id @default(cuid())

  // Period
  snapshotDate DateTime
  periodType   String   @default("monthly") // daily, weekly, monthly, quarterly, yearly
  periodLabel  String // e.g., "2025-01", "Q1 2025"

  // Revenue Metrics
  revenueMTD Decimal @default(0) @db.Decimal(15, 2)
  revenueQTD Decimal @default(0) @db.Decimal(15, 2)
  revenueYTD Decimal @default(0) @db.Decimal(15, 2)
  revenueTTM Decimal @default(0) @db.Decimal(15, 2)

  // Cost Metrics
  totalCosts    Decimal @default(0) @db.Decimal(15, 2)
  fixedCosts    Decimal @default(0) @db.Decimal(15, 2)
  variableCosts Decimal @default(0) @db.Decimal(15, 2)

  // Margin Metrics
  grossMargin            Decimal @default(0) @db.Decimal(15, 2)
  grossMarginPercent     Decimal @default(0) @db.Decimal(5, 2)
  operatingMargin        Decimal @default(0) @db.Decimal(15, 2)
  operatingMarginPercent Decimal @default(0) @db.Decimal(5, 2)
  ebitda                 Decimal @default(0) @db.Decimal(15, 2)
  ebitdaMarginPercent    Decimal @default(0) @db.Decimal(5, 2)
  netMargin              Decimal @default(0) @db.Decimal(15, 2)
  netMarginPercent       Decimal @default(0) @db.Decimal(5, 2)

  // Cash Position
  cashAndEquivalents Decimal @default(0) @db.Decimal(15, 2)
  restrictedCash     Decimal @default(0) @db.Decimal(15, 2)
  totalCash          Decimal @default(0) @db.Decimal(15, 2)

  // Liabilities
  shortTermLiabilities Decimal @default(0) @db.Decimal(15, 2)
  longTermLiabilities  Decimal @default(0) @db.Decimal(15, 2)
  totalLiabilities     Decimal @default(0) @db.Decimal(15, 2)

  // Working Capital
  currentAssets      Decimal @default(0) @db.Decimal(15, 2)
  currentLiabilities Decimal @default(0) @db.Decimal(15, 2)
  netWorkingCapital  Decimal @default(0) @db.Decimal(15, 2)

  // Efficiency
  employeeCount      Int      @default(0)
  revenuePerEmployee Decimal? @db.Decimal(15, 2)
  costPerEmployee    Decimal? @db.Decimal(15, 2)

  // Unit Economics (stored as JSON for flexibility)
  unitEconomics Json? // { cac, ltv, ltvToCacRatio, paybackPeriodMonths }

  // Ratios
  currentRatio Decimal? @db.Decimal(8, 4)
  quickRatio   Decimal? @db.Decimal(8, 4)

  // Burn Metrics
  monthlyBurn      Decimal @default(0) @db.Decimal(15, 2)
  burnAvg3Month    Decimal @default(0) @db.Decimal(15, 2)
  burnAvg6Month    Decimal @default(0) @db.Decimal(15, 2)
  burnTrend        String  @default("flat") // up, down, flat
  burnTrendPercent Decimal @default(0) @db.Decimal(5, 2)

  // Runway
  runwayMonths  Decimal?  @db.Decimal(5, 2)
  runwayEndDate DateTime?

  // Risk Assessment
  overallRiskLevel String @default("moderate") // low, moderate, elevated, high, critical
  liquidityRisk    String @default("low")

  // Data Quality
  dataQuality      String  @default("complete") // complete, partial, limited
  dataCompleteness Decimal @default(100) @db.Decimal(5, 2)

  // Currency
  currency String @default("EUR")

  // Computed at
  computedAt DateTime @default(now())
  computedBy String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([organizationId, snapshotDate, periodType])
  @@index([organizationId, snapshotDate])
  @@index([organizationId, periodType])
}

// Board Report / Summary
model BoardReport {
  id String @id @default(cuid())

  // Report Info
  title         String
  periodCovered String // e.g., "January 2025", "Q1 2025"
  asOfDate      DateTime

  // Health Assessment
  financialHealthStatus String  @default("stable") // healthy, stable, cautionary, concerning, critical
  liquidityStatus       String?
  sustainabilityOutlook String? @db.Text

  // Key Highlights (JSON array)
  keyHighlights Json @default("[]") // string[]

  // Material Changes (JSON array)
  materialChanges Json @default("[]") // MaterialChange[]

  // Risk Factors (JSON array)
  riskFactors Json @default("[]") // string[]

  // Data Limitations (JSON array)
  dataLimitations Json @default("[]") // string[]

  // Concentration Risks (JSON array)
  concentrationRisks Json @default("[]") // ConcentrationRisk[]

  // Linked Snapshot
  snapshotId String?

  // Approval
  status      String    @default("draft") // draft, pending_review, approved, published
  approvedBy  String?
  approvedAt  DateTime?
  publishedAt DateTime?

  // Distribution
  distributedTo Json? // Array of investor IDs
  distributedAt DateTime?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, asOfDate])
  @@index([organizationId, status])
}

// Runway Projection scenarios
model RunwayProjection {
  id String @id @default(cuid())

  // Projection Info
  name           String
  scenarioType   String   @default("base") // conservative, base, aggressive, custom
  projectionDate DateTime @default(now())

  // Current Position
  currentCash Decimal @db.Decimal(15, 2)
  currency    String  @default("EUR")

  // Assumptions (JSON)
  assumptions Json @default("[]") // string[]

  // Burn Rate
  monthlyBurnRate Decimal @db.Decimal(15, 2)

  // Runway
  runwayMonths  Decimal  @db.Decimal(5, 2)
  runwayEndDate DateTime

  // Confidence
  confidenceLevel Decimal @default(70) @db.Decimal(5, 2) // 0-100

  // Projection Basis
  projectionBasis String @default("historical") // historical, scenario-based, forecast-augmented

  // Time Horizon
  timeHorizon String @default("12_months") // 6_months, 12_months, 18_months, 24_months

  // Warnings (JSON)
  warnings Json? // string[]

  // Data Inputs Description
  dataInputs Json @default("[]") // string[]

  // Status
  isActive Boolean @default(true)

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, isActive])
  @@index([organizationId, scenarioType])
}

// Access audit log for investor dashboard
model InvestorAccessLog {
  id String @id @default(cuid())

  // User
  userId   String
  userName String
  userRole String // investor, board_member, executive, admin

  // Action
  action  String // view_dashboard, view_section, export_report, download_summary
  section String // overview, revenue, costs, burn, runway, risk, board_summary

  // Details
  details   String?
  ipAddress String?
  sessionId String?
  userAgent String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  timestamp DateTime @default(now())

  @@index([organizationId, timestamp])
  @@index([organizationId, userId])
  @@index([organizationId, action])
}

// Enhance existing Investor model with additional fields
// (These would be added to the existing Investor model)
// Add these fields to existing Investor:
//   tier String @default("standard") // founding, lead, strategic, standard
//   accessLevel String @default("basic") // full, basic, limited
//   dashboardAccess Boolean @default(true)
//   lastDashboardView DateTime?
// =============================================================================
// LIQUIDITY MODULE - Comprehensive Liquidity Analysis
// =============================================================================

// Individual cashflow items
model CashflowItem {
  id String @id @default(cuid())

  // Type & Category
  type     String // inflow, outflow
  category String // receivables, contractual_income, one_off_inflow, intercompany_in, other_inflow, payables, payroll, taxes, debt_service, operating_expenses, one_off_outflow, intercompany_out, other_outflow

  // Details
  description  String
  amount       Decimal  @db.Decimal(15, 2)
  currency     String   @default("EUR")
  expectedDate DateTime

  // Confidence
  confidence String @default("expected") // confirmed, expected, estimated

  // Source Traceability
  sourceType      String // invoice, contract, schedule, estimate, manual
  sourceReference String?
  sourceDocument  String?

  // Entity & Counterparty
  counterparty String?
  entityId     String?
  entityName   String?

  // Recurrence
  isRecurring       Boolean @default(false)
  recurrencePattern String? // daily, weekly, monthly, quarterly

  // Status
  status String @default("pending") // pending, realized, cancelled

  // Meta
  notes String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  @@index([organizationId, expectedDate])
  @@index([organizationId, type])
  @@index([organizationId, confidence])
  @@index([organizationId, category])
}

// Liquidity-specific scenarios
model LiquidityScenario {
  id String @id @default(cuid())

  // Scenario Info
  type        String // base, conservative, stress, custom
  name        String
  description String? @db.Text

  // Assumptions (JSON)
  assumptions Json // { inflowDelayDays, inflowReductionPercent, outflowAccelerationDays, outflowIncreasePercent, confirmedOnly, excludeEstimated, customAdjustments }

  // Time Parameters
  horizonDays Int      @default(90)
  timeBucket  String   @default("weekly") // daily, weekly, monthly
  startDate   DateTime @default(now())

  // Starting Position
  startingCashBalance Decimal @db.Decimal(15, 2)
  minimumBuffer       Decimal @default(0) @db.Decimal(15, 2)
  currency            String  @default("EUR")

  // Calculated Results (JSON - timeline data)
  timeline Json? // Full timeline with periods

  // Summary Metrics
  totalInflows      Decimal?  @db.Decimal(15, 2)
  totalOutflows     Decimal?  @db.Decimal(15, 2)
  netChange         Decimal?  @db.Decimal(15, 2)
  endingBalance     Decimal?  @db.Decimal(15, 2)
  lowestBalance     Decimal?  @db.Decimal(15, 2)
  lowestBalanceDate DateTime?
  daysWithGap       Int?
  totalGapAmount    Decimal?  @db.Decimal(15, 2)

  // Confidence Breakdown
  confirmedCashflows Decimal? @db.Decimal(15, 2)
  expectedCashflows  Decimal? @db.Decimal(15, 2)
  estimatedCashflows Decimal? @db.Decimal(15, 2)
  dataCompleteness   Decimal? @db.Decimal(5, 2) // 0-100

  // Variance vs Base
  varianceEndingBalance Decimal? @db.Decimal(15, 2)
  varianceLowestBalance Decimal? @db.Decimal(15, 2)
  additionalGapDays     Int?

  // Meta
  isActive       Boolean @default(true)
  isHypothetical Boolean @default(true) // Always true for scenarios

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  @@index([organizationId, type])
  @@index([organizationId, isActive])
}

// Identified liquidity gaps
model LiquidityGap {
  id String @id @default(cuid())

  // Period
  startDate    DateTime
  endDate      DateTime
  durationDays Int

  // Gap Details
  peakDeficit      Decimal @db.Decimal(15, 2)
  averageDeficit   Decimal @db.Decimal(15, 2)
  totalDeficitDays Decimal @db.Decimal(15, 2) // deficit * days
  currency         String  @default("EUR")

  // Causes (JSON array)
  causes Json // [{ description, impact, type }]

  // Affected Periods
  affectedPeriods Json // string[]

  // Severity
  severity String @default("moderate") // low, moderate, elevated, high, critical

  // Status
  status String @default("projected") // projected, confirmed, mitigated, resolved

  // Mitigation
  mitigationPlan String?
  mitigatedAt    DateTime?
  mitigatedBy    String?

  // Linked Scenario
  scenarioId String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, status])
  @@index([organizationId, startDate])
  @@index([organizationId, severity])
}

// Risk signals for liquidity
model LiquidityRiskSignal {
  id String @id @default(cuid())

  // Signal Type
  type        String // volatility, concentration, buffer, timing, dependency
  title       String
  description String @db.Text

  // Risk Level
  riskLevel String @default("moderate") // low, moderate, elevated, high, critical

  // Metrics
  metric    Decimal @db.Decimal(15, 4)
  threshold Decimal @db.Decimal(15, 4)
  breached  Boolean @default(false)

  // Context
  affectedPeriod String?
  relatedItems   Json? // string[]

  // Status
  status String @default("active") // active, acknowledged, resolved, dismissed

  // Resolution
  resolvedAt  DateTime?
  resolvedBy  String?
  dismissedAt DateTime?
  dismissedBy String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  detectedAt DateTime @default(now())

  @@index([organizationId, status])
  @@index([organizationId, riskLevel])
  @@index([organizationId, type])
}

// Audit log for liquidity dashboard
model LiquidityAuditLog {
  id String @id @default(cuid())

  // Action
  action  String // view, refresh, scenario_created, scenario_viewed, export, assumption_changed
  details String

  // User
  userId   String?
  userName String?
  userRole String?

  // Context
  scenarioId     String?
  dataReferenced Json? // string[]

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  timestamp DateTime @default(now())

  @@index([organizationId, timestamp])
  @@index([organizationId, action])
}

// Enhance existing LiquidityPosition
model LiquidityPosition {
  id String @id @default(cuid())

  // Position Date
  positionDate DateTime
  periodType   String   @default("daily") // daily, weekly, monthly

  // Cash Positions
  totalCash      Decimal @db.Decimal(15, 2)
  operatingCash  Decimal @db.Decimal(15, 2)
  reserveCash    Decimal @db.Decimal(15, 2)
  restrictedCash Decimal @default(0) @db.Decimal(15, 2)

  // Available Liquidity
  availableCredit Decimal @default(0) @db.Decimal(15, 2)
  totalLiquidity  Decimal @db.Decimal(15, 2)

  // Minimum Buffer
  minimumBuffer Decimal @default(0) @db.Decimal(15, 2)

  // Flows
  expectedInflows  Decimal @default(0) @db.Decimal(15, 2)
  expectedOutflows Decimal @default(0) @db.Decimal(15, 2)
  netCashFlow      Decimal @default(0) @db.Decimal(15, 2)

  // Confidence Breakdown
  confirmedInflows  Decimal @default(0) @db.Decimal(15, 2)
  expectedInflows2  Decimal @default(0) @db.Decimal(15, 2) // renamed to avoid conflict
  estimatedInflows  Decimal @default(0) @db.Decimal(15, 2)
  confirmedOutflows Decimal @default(0) @db.Decimal(15, 2)
  expectedOutflows2 Decimal @default(0) @db.Decimal(15, 2)
  estimatedOutflows Decimal @default(0) @db.Decimal(15, 2)

  // Projections
  projectedEndingCash Decimal? @db.Decimal(15, 2)
  runwayDays          Int?
  runwayMonths        Decimal? @db.Decimal(5, 2)

  // Metrics
  currentRatio Decimal? @db.Decimal(8, 4)
  quickRatio   Decimal? @db.Decimal(8, 4)
  cashBurnRate Decimal? @db.Decimal(15, 2)

  // Risk Metrics
  bufferDays         Int?
  concentrationIndex Decimal? @db.Decimal(5, 4)
  volatilityIndex    Decimal? @db.Decimal(5, 4)

  // Status
  status    String   @default("normal") // normal, watch, warning, critical
  riskLevel String   @default("low") // low, moderate, elevated, high, critical
  riskScore Decimal? @db.Decimal(5, 2) // 0-100

  // Data Quality
  dataCompleteness Decimal @default(100) @db.Decimal(5, 2)
  knownBlindSpots  Json? // string[]

  // Breakdown by account (JSON for flexibility)
  accountBreakdown Json?
  currency         String @default("EUR")

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([organizationId, positionDate, periodType])
  @@index([organizationId, positionDate])
  @@index([organizationId, status])
  @@index([organizationId, riskLevel])
}
