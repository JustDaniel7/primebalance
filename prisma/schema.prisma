// prisma/schema.prisma
// CHANGE: Extended with all business models, organization-scoped

// NEW (Prisma 7)
generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// NEXTAUTH MODELS (existing, modified)
// =============================================================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  role          String    @default("member") // owner, admin, member

  // Relations
  accounts          Account[]
  sessions          Session[]
  organizationId    String?
  organization      Organization?     @relation(fields: [organizationId], references: [id])
  orders            Order[]
  settings          UserSettings?
  wallets           Wallet[]
  chatMessages      ChatMessage[]
  aiSuggestions     AISuggestion[]
  savedReports      SavedReport[]
  corporateEntities CorporateEntity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// =============================================================================
// ORGANIZATION
// =============================================================================

model Organization {
  id              String  @id @default(cuid())
  name            String
  slug            String  @unique
  country         String  @default("CH")
  industry        String?
  fiscalYearEnd   String  @default("12-31") // MM-DD
  defaultCurrency String  @default("USD")
  taxId           String?

  // Relations
  users             User[]
  transactions      Transaction[]
  financialAccounts FinancialAccount[]
  receipts          Receipt[]
  chatChannels      ChatChannel[]
  orders            Order[]
  archiveItems      ArchiveItem[]
  liabilities       Liability[]
  inventoryItems    InventoryItem[]
  receivables       Receivable[]

  treasuryAccounts     TreasuryAccount[]
  capitalBuckets       CapitalBucket[]
  creditFacilities     CreditFacility[]
  treasuryDecisions    TreasuryDecision[]
  treasuryScenarios    TreasuryScenario[]
  nettingOpportunities NettingOpportunity[]

  assets         Asset[]
  assetDisposals AssetDisposal[]
  capExBudgets   CapExBudget[]

  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  Invoice              Invoice[]
  Project              Project[]
  CostCenter           CostCenter[]
  timeEntries          TimeEntry[]
  internalChargebacks  InternalChargeback[]
  accountingPeriods    AccountingPeriod[]
  periodAdjustments    PeriodAdjustment[]
  customers            Customer[]
  customerPayments     CustomerPayment[]
  customerCreditEvents CustomerCreditEvent[]
}

// =============================================================================
// FINANCIAL ACCOUNTS (Chart of Accounts)
// =============================================================================

model FinancialAccount {
  id            String  @id @default(cuid())
  name          String
  accountNumber String
  type          String // asset, liability, equity, revenue, expense, bank, crypto
  balance       Float   @default(0)
  currency      String  @default("USD")
  isActive      Boolean @default(true)
  description   String?

  // Hierarchy
  parentId String?
  parent   FinancialAccount?  @relation("AccountHierarchy", fields: [parentId], references: [id])
  children FinancialAccount[] @relation("AccountHierarchy")

  // Organization scope
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, accountNumber])
}

// =============================================================================
// TRANSACTIONS
// =============================================================================

model Transaction {
  id          String   @id @default(cuid())
  date        DateTime
  description String
  amount      Float
  currency    String   @default("USD")
  type        String // income, expense, transfer
  category    String?
  status      String   @default("pending") // pending, completed, cancelled
  tags        String[] // PostgreSQL array

  // Blockchain
  tokenized Boolean @default(false)
  txHash    String?

  // Relations
  accountId      String
  account        FinancialAccount @relation(fields: [accountId], references: [id])
  organizationId String
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  receipts       Receipt[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, date])
  @@index([organizationId, type])
  @@index([organizationId, status])
}

// =============================================================================
// RECEIPTS
// =============================================================================

model Receipt {
  id       String @id @default(cuid())
  fileName String
  fileUrl  String
  fileType String // pdf, image, etc.
  fileSize Int

  // OCR/AI extracted data
  vendor        String?
  amount        Float?
  date          DateTime?
  extractedText String?   @db.Text
  confidence    Float? // AI confidence score

  // Relations
  transactionId  String?
  transaction    Transaction? @relation(fields: [transactionId], references: [id])
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
}

// =============================================================================
// TEAM CHAT
// =============================================================================

model ChatChannel {
  id          String  @id @default(cuid())
  name        String
  description String?
  type        String  @default("public") // public, private, direct

  // Organization scope
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  messages ChatMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, name])
}

model ChatMessage {
  id      String @id @default(cuid())
  content String @db.Text

  // Relations
  channelId String
  channel   ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([channelId, createdAt])
}

// =============================================================================
// USER SETTINGS
// =============================================================================

model UserSettings {
  id String @id @default(cuid())

  // Preferences
  language   String @default("en")
  timezone   String @default("Europe/Zurich")
  currency   String @default("USD")
  dateFormat String @default("DD.MM.YYYY")
  theme      String @default("dark")

  // Notifications
  emailNotifications        Boolean @default(true)
  pushNotifications         Boolean @default(true)
  transactionNotifications  Boolean @default(true)
  reportNotifications       Boolean @default(true)
  aiSuggestionNotifications Boolean @default(true)

  // Relations
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =============================================================================
// CRYPTO WALLETS
// =============================================================================

model Wallet {
  id       String  @id @default(cuid())
  name     String
  address  String
  network  String // ethereum, solana, bitcoin
  provider String? // metamask, phantom, etc.
  isActive Boolean @default(true)

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, address])
}

// =============================================================================
// AI SUGGESTIONS
// =============================================================================

model AISuggestion {
  id          String  @id @default(cuid())
  type        String // tax_optimization, categorization, anomaly, insight
  title       String
  description String  @db.Text
  impact      String?
  priority    String  @default("medium") // low, medium, high
  status      String  @default("pending") // pending, accepted, dismissed
  metadata    Json? // Additional context

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status])
}

// =============================================================================
// SAVED REPORTS
// =============================================================================

model SavedReport {
  id            String    @id @default(cuid())
  name          String
  type          String // PROFIT_LOSS, BALANCE_SHEET, CASH_FLOW, TAX_SUMMARY, EXPENSE_REPORT, INCOME_REPORT
  parameters    Json?
  isScheduled   Boolean   @default(false)
  scheduleFreq  String? // daily, weekly, monthly
  lastGenerated DateTime?

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// =============================================================================
// CORPORATE ENTITIES
// =============================================================================

model CorporateEntity {
  id                String    @id @default(cuid())
  name              String
  type              String // corporation, llc, partnership, sole_proprietorship
  jurisdiction      String
  taxId             String?
  incorporationDate DateTime?
  ownershipPercent  Decimal?  @db.Decimal(5, 2)
  revenue           Decimal?  @db.Decimal(15, 2)
  expenses          Decimal?  @db.Decimal(15, 2)
  taxLiability      Decimal?  @db.Decimal(15, 2)
  effectiveTaxRate  Decimal?  @db.Decimal(5, 2)
  isActive          Boolean   @default(true)

  // Hierarchy
  parentId String?
  parent   CorporateEntity?  @relation("EntityHierarchy", fields: [parentId], references: [id])
  children CorporateEntity[] @relation("EntityHierarchy")

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// =============================================================================
// INVOICES
// =============================================================================

model Invoice {
  id            String @id @default(cuid())
  invoiceNumber String
  status        String @default("draft") // draft, sent, paid, overdue, cancelled

  // Parties (stored as JSON for flexibility)
  sender    Json // InvoiceParty
  recipient Json // InvoiceParty

  // Dates
  invoiceDate        DateTime
  dueDate            DateTime
  serviceDate        DateTime?
  servicePeriodStart DateTime?
  servicePeriodEnd   DateTime?

  // Items & Totals
  items     Json // InvoiceItem[]
  currency  String  @default("EUR")
  subtotal  Decimal @db.Decimal(15, 2)
  taxAmount Decimal @db.Decimal(15, 2)
  total     Decimal @db.Decimal(15, 2)

  // Tax
  applyTax        Boolean @default(true)
  taxRate         Decimal @db.Decimal(5, 2)
  taxExemptReason String? // small_business, reverse_charge, export, other
  taxExemptNote   String?

  // Payment
  payment Json // InvoicePayment

  // Meta
  notes         String? @db.Text
  internalNotes String? @db.Text
  language      String  @default("en")

  // Timestamps
  sentAt DateTime?
  paidAt DateTime?

  // Recurring
  isRecurring       Boolean   @default(false)
  recurringInterval String? // weekly, monthly, quarterly, yearly
  nextRecurringDate DateTime?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Link to order if created from order
  orderId String?
  order   Order?  @relation(fields: [orderId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, invoiceNumber])
  @@index([organizationId, status])
  @@index([organizationId, dueDate])
}

// =============================================================================
// ORDERS
// =============================================================================

model Order {
  id          String @id @default(cuid())
  orderNumber String
  status      String @default("draft") // draft, confirmed, in_progress, partially_completed, completed, cancelled

  // Customer
  customerId      String?
  customerName    String
  customerEmail   String?
  customerAddress Json? // Address object

  // Dates
  orderDate            DateTime
  expectedDeliveryDate DateTime?
  completedDate        DateTime?

  // Items
  items Json // OrderItem[]

  // Totals
  currency       String  @default("EUR")
  subtotal       Decimal @db.Decimal(15, 2)
  taxAmount      Decimal @db.Decimal(15, 2)
  discountAmount Decimal @default(0) @db.Decimal(15, 2)
  total          Decimal @db.Decimal(15, 2)

  // Tax
  taxRate Decimal @default(0) @db.Decimal(5, 2)

  // Fulfillment tracking
  fulfilledQuantity  Int     @default(0)
  totalQuantity      Int     @default(0)
  fulfillmentPercent Decimal @default(0) @db.Decimal(5, 2)

  // Invoicing tracking
  invoicedAmount Decimal @default(0) @db.Decimal(15, 2)
  paidAmount     Decimal @default(0) @db.Decimal(15, 2)

  // Meta
  notes         String?  @db.Text
  internalNotes String?  @db.Text
  tags          String[]
  priority      String   @default("normal") // low, normal, high, urgent

  // Recurring
  isRecurring       Boolean @default(false)
  recurringInterval String? // weekly, monthly, quarterly, yearly

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Invoices created from this order
  invoices Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User?    @relation(fields: [userId], references: [id])
  userId    String?

  @@unique([organizationId, orderNumber])
  @@index([organizationId, status])
  @@index([organizationId, orderDate])
  @@index([organizationId, customerId])
}

// =============================================================================
// ARCHIVE
// =============================================================================

model ArchiveItem {
  id String @id @default(cuid())

  // Category & Type
  category String // bookings, invoices, bank, services, documents, contracts
  status   String @default("archived") // archived, restored, deleted

  // Original reference
  originalId   String
  originalType String // transaction, invoice, order, contract, document, receipt

  // Content
  title       String
  description String?  @db.Text
  amount      Decimal? @db.Decimal(15, 2)
  currency    String   @default("EUR")

  // Counterparty
  counterparty String?

  // Dates
  itemDate   DateTime // Original item date
  archivedAt DateTime  @default(now())
  restoredAt DateTime?

  // Period tracking
  fiscalYear   Int?
  fiscalPeriod String? // Q1, Q2, Q3, Q4, or month

  // Meta
  tags        String[]
  attachments Json? // Array of attachment references
  metadata    Json? // Additional flexible data from original

  // Audit
  archivedBy    String?
  restoredBy    String?
  archiveReason String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, category])
  @@index([organizationId, fiscalYear])
  @@index([organizationId, status])
  @@index([organizationId, archivedAt])
}

// =============================================================================
// LIABILITIES
// =============================================================================

model Liability {
  id String @id @default(cuid())

  // Type & Status
  type   String // loan, credit_line, overdraft, supplier_credit, deferred_payment, lease, guarantee, other
  status String @default("active") // active, paid_off, defaulted, restructured, cancelled

  // Basic Info
  name        String
  description String? @db.Text
  reference   String? // External reference number

  // Counterparty
  counterpartyId   String?
  counterpartyName String
  counterpartyType String? // bank, supplier, investor, government, other

  // Amounts
  currency          String  @default("EUR")
  principalAmount   Decimal @db.Decimal(15, 2)
  outstandingAmount Decimal @db.Decimal(15, 2)
  paidAmount        Decimal @default(0) @db.Decimal(15, 2)

  // Credit facilities
  creditLimit     Decimal? @db.Decimal(15, 2)
  availableCredit Decimal? @db.Decimal(15, 2)
  utilizationRate Decimal? @db.Decimal(5, 2)

  // Interest
  interestRate    Decimal? @db.Decimal(5, 4)
  interestType    String? // fixed, variable, zero
  interestAccrued Decimal  @default(0) @db.Decimal(15, 2)

  // Dates
  startDate       DateTime
  maturityDate    DateTime?
  nextPaymentDate DateTime?
  lastPaymentDate DateTime?

  // Payment Schedule
  paymentFrequency String? // monthly, quarterly, annually, bullet, custom
  paymentAmount    Decimal? @db.Decimal(15, 2)
  paymentSchedule  Json? // Array of scheduled payments

  // Collateral & Security
  isSecured             Boolean  @default(false)
  collateralDescription String?
  collateralValue       Decimal? @db.Decimal(15, 2)

  // Covenants & Conditions
  covenants Json? // Array of covenant objects

  // Risk & Alerts
  riskLevel      String   @default("low") // low, medium, high, critical
  alertThreshold Decimal? @db.Decimal(5, 2) // % of limit for alerts

  // Meta
  tags        String[]
  notes       String?  @db.Text
  attachments Json?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Payment history
  payments LiabilityPayment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, type])
  @@index([organizationId, status])
  @@index([organizationId, maturityDate])
  @@index([organizationId, counterpartyId])
}

model LiabilityPayment {
  id String @id @default(cuid())

  // Payment details
  amount          Decimal @db.Decimal(15, 2)
  principalAmount Decimal @db.Decimal(15, 2)
  interestAmount  Decimal @default(0) @db.Decimal(15, 2)
  feesAmount      Decimal @default(0) @db.Decimal(15, 2)

  currency    String    @default("EUR")
  paymentDate DateTime
  dueDate     DateTime?

  // Status
  status String @default("completed") // scheduled, completed, missed, partial

  // Reference
  reference     String?
  transactionId String? // Link to Transaction if applicable

  // Meta
  notes String?

  // Relations
  liabilityId String
  liability   Liability @relation(fields: [liabilityId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([liabilityId, paymentDate])
}

// =============================================================================
// INVENTORY
// =============================================================================

model InventoryItem {
  id String @id @default(cuid())

  // Type & Status
  type   String // raw_material, work_in_progress, finished_goods, merchandise, consumables, packaging, spare_parts, other
  status String @default("active") // active, discontinued, out_of_stock, on_hold

  // Identification
  sku         String
  name        String
  description String? @db.Text
  barcode     String?

  // Category
  category    String?
  subcategory String?

  // Quantities
  quantityOnHand    Decimal @default(0) @db.Decimal(15, 4)
  quantityReserved  Decimal @default(0) @db.Decimal(15, 4)
  quantityAvailable Decimal @default(0) @db.Decimal(15, 4)
  quantityOnOrder   Decimal @default(0) @db.Decimal(15, 4)

  // Units
  unitOfMeasure String @default("pcs") // pcs, kg, m, l, etc.

  // Thresholds
  minimumStock    Decimal  @default(0) @db.Decimal(15, 4)
  maximumStock    Decimal? @db.Decimal(15, 4)
  reorderPoint    Decimal  @default(0) @db.Decimal(15, 4)
  reorderQuantity Decimal? @db.Decimal(15, 4)

  // Valuation
  currency         String   @default("EUR")
  unitCost         Decimal  @default(0) @db.Decimal(15, 4)
  averageCost      Decimal  @default(0) @db.Decimal(15, 4)
  lastPurchaseCost Decimal? @db.Decimal(15, 4)
  sellingPrice     Decimal? @db.Decimal(15, 4)
  totalValue       Decimal  @default(0) @db.Decimal(15, 2)

  // Costing method
  costingMethod String @default("average") // fifo, lifo, average, specific

  // Location
  warehouseId   String?
  warehouseName String?
  location      String? // Bin/shelf location
  zone          String?

  // Ownership
  ownershipType String  @default("owned") // owned, consignment, third_party
  supplierId    String?
  supplierName  String?

  // Tracking
  isSerialTracked Boolean @default(false)
  isBatchTracked  Boolean @default(false)
  isExpiryTracked Boolean @default(false)

  // Lead times
  leadTimeDays Int?

  // Dimensions (for shipping)
  weight        Decimal? @db.Decimal(10, 4)
  weightUnit    String? // kg, lb
  length        Decimal? @db.Decimal(10, 4)
  width         Decimal? @db.Decimal(10, 4)
  height        Decimal? @db.Decimal(10, 4)
  dimensionUnit String? // cm, in

  // Meta
  tags     String[]
  notes    String?  @db.Text
  imageUrl String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Movements
  movements InventoryMovement[]
  batches   InventoryBatch[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, sku])
  @@index([organizationId, type])
  @@index([organizationId, status])
  @@index([organizationId, category])
  @@index([organizationId, warehouseId])
}

model InventoryMovement {
  id String @id @default(cuid())

  // Movement type
  type String // receipt, issue, transfer, adjustment, return, scrap, count

  // Quantities
  quantity         Decimal @db.Decimal(15, 4)
  previousQuantity Decimal @db.Decimal(15, 4)
  newQuantity      Decimal @db.Decimal(15, 4)

  // Valuation
  unitCost  Decimal? @db.Decimal(15, 4)
  totalCost Decimal? @db.Decimal(15, 2)

  // Reference
  referenceType   String? // purchase_order, sales_order, transfer_order, adjustment
  referenceId     String?
  referenceNumber String?

  // Location
  fromWarehouseId String?
  fromLocation    String?
  toWarehouseId   String?
  toLocation      String?

  // Batch/Serial
  batchId      String?
  batch        InventoryBatch? @relation(fields: [batchId], references: [id])
  serialNumber String?

  // Meta
  reason      String?
  notes       String?
  performedBy String?

  // Dates
  movementDate DateTime @default(now())

  // Relations
  inventoryItemId String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([inventoryItemId, movementDate])
  @@index([inventoryItemId, type])
}

model InventoryBatch {
  id String @id @default(cuid())

  // Batch info
  batchNumber String
  lotNumber   String?

  // Quantities
  initialQuantity  Decimal @db.Decimal(15, 4)
  currentQuantity  Decimal @db.Decimal(15, 4)
  reservedQuantity Decimal @default(0) @db.Decimal(15, 4)

  // Valuation
  unitCost Decimal @db.Decimal(15, 4)

  // Dates
  manufacturingDate DateTime?
  expiryDate        DateTime?
  receivedDate      DateTime  @default(now())

  // Status
  status String @default("available") // available, quarantine, expired, consumed

  // Supplier
  supplierId       String?
  supplierBatchRef String?

  // Quality
  qualityStatus String? // passed, failed, pending
  qualityNotes  String?

  // Location
  warehouseId String?
  location    String?

  // Relations
  inventoryItemId String
  inventoryItem   InventoryItem       @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  movements       InventoryMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([inventoryItemId, batchNumber])
  @@index([inventoryItemId, status])
  @@index([inventoryItemId, expiryDate])
}

// =============================================================================
// RECEIVABLES
// =============================================================================

model Receivable {
  id String @id @default(cuid())

  // Origin
  originType        String // invoice, order, contract, manual
  originReferenceId String?

  // Parties
  creditorEntityId String? // Our entity
  debtorId         String?
  debtorName       String
  debtorEmail      String?
  debtorPhone      String?
  debtorAddress    Json?

  // Amounts
  currency          String  @default("EUR")
  originalAmount    Decimal @db.Decimal(15, 2)
  outstandingAmount Decimal @db.Decimal(15, 2)
  paidAmount        Decimal @default(0) @db.Decimal(15, 2)
  disputedAmount    Decimal @default(0) @db.Decimal(15, 2)
  writtenOffAmount  Decimal @default(0) @db.Decimal(15, 2)

  // Dates
  issueDate           DateTime
  dueDate             DateTime
  expectedPaymentDate DateTime?
  lastActivityDate    DateTime?

  // Status & Risk
  status    String @default("open") // open, due, overdue, partially_paid, paid, disputed, in_collection, written_off, settled_via_offset
  riskLevel String @default("low") // low, medium, high, critical

  // Aging (calculated)
  daysOutstanding Int    @default(0)
  agingBucket     String @default("current") // current, 1-30, 31-60, 61-90, 90+

  // Dispute
  isDisputed        Boolean   @default(false)
  disputeReason     String?   @db.Text
  disputeOpenedAt   DateTime?
  disputeResolvedAt DateTime?

  // Collection
  collectionStage     String? // reminder_1, reminder_2, final_notice, external_collection
  collectionStartedAt DateTime?
  collectionAgency    String?

  // Automation
  autoRemindersEnabled Boolean   @default(true)
  nextReminderDate     DateTime?
  reminderCount        Int       @default(0)

  // Reference
  reference     String?
  description   String?  @db.Text
  notes         String?  @db.Text
  internalNotes String?  @db.Text
  tags          String[]

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Payment applications
  paymentApplications ReceivablePayment[]

  // Activity history
  events ReceivableEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, status])
  @@index([organizationId, dueDate])
  @@index([organizationId, debtorId])
  @@index([organizationId, agingBucket])
  @@index([organizationId, riskLevel])
}

model ReceivablePayment {
  id String @id @default(cuid())

  // Payment details
  amount    Decimal  @db.Decimal(15, 2)
  currency  String   @default("EUR")
  appliedAt DateTime @default(now())

  // Type
  type String // payment, credit_note, offset, write_off

  // Reference
  reference     String?
  transactionId String? // Link to Transaction

  // Meta
  notes     String?
  appliedBy String?

  // Relations
  receivableId String
  receivable   Receivable @relation(fields: [receivableId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([receivableId, appliedAt])
}

model ReceivableEvent {
  id String @id @default(cuid())

  // Event type
  type String // receivable_created, payment_applied, partial_payment_applied, credit_note_applied, offset_applied, dispute_opened, dispute_resolved, due_date_changed, collection_action_started, reminder_sent, write_off_applied, status_changed

  // Details
  description   String
  previousValue String?
  newValue      String?
  amount        Decimal? @db.Decimal(15, 2)

  // Meta
  performedBy String?
  notes       String?
  metadata    Json?

  // Relations
  receivableId String
  receivable   Receivable @relation(fields: [receivableId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([receivableId, createdAt])
}

// =============================================================================
// TREASURY
// =============================================================================

model TreasuryAccount {
  id String @id @default(cuid())

  // Account Info
  name          String
  accountNumber String?
  type          String // operating, reserve, restricted, investment, escrow

  // Bank details
  bankName String?
  bankCode String? // BIC/SWIFT
  iban     String?

  // Classification
  cashClassification String @default("unrestricted") // unrestricted, restricted, committed, reserved

  // Balances
  currency         String  @default("EUR")
  currentBalance   Decimal @default(0) @db.Decimal(15, 2)
  availableBalance Decimal @default(0) @db.Decimal(15, 2)
  pendingInflows   Decimal @default(0) @db.Decimal(15, 2)
  pendingOutflows  Decimal @default(0) @db.Decimal(15, 2)

  // Limits
  minimumBalance Decimal? @db.Decimal(15, 2)
  targetBalance  Decimal? @db.Decimal(15, 2)

  // Status
  status        String  @default("active") // active, inactive, frozen, closing
  isMainAccount Boolean @default(false)

  // Sweeping/Pooling
  participatesInPooling Boolean @default(false)
  poolingRole           String? // master, participant
  masterAccountId       String?

  // Meta
  entityId String? // Corporate entity if multi-entity
  notes    String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Transactions
  cashMovements TreasuryCashMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, type])
  @@index([organizationId, status])
  @@index([organizationId, cashClassification])
}

model CapitalBucket {
  id String @id @default(cuid())

  // Bucket info
  name        String
  type        String // operating, payroll, tax_reserve, debt_service, capex, emergency, growth, other
  description String?

  // Amounts
  currency      String  @default("EUR")
  targetAmount  Decimal @db.Decimal(15, 2)
  currentAmount Decimal @default(0) @db.Decimal(15, 2)
  minimumAmount Decimal @default(0) @db.Decimal(15, 2)

  // Status
  fundingStatus  String  @default("underfunded") // underfunded, funded, overfunded
  fundingPercent Decimal @default(0) @db.Decimal(5, 2)

  // Priority
  priority   Int     @default(5) // 1-10, lower = higher priority
  isRequired Boolean @default(false)

  // Funding rules
  autoFund               Boolean @default(false)
  fundingSourceAccountId String?

  // Time horizon
  timeHorizon String? // immediate, short_term, medium_term, long_term
  targetDate  DateTime?

  // Meta
  notes String?
  tags  String[]

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, type])
  @@index([organizationId, fundingStatus])
}

model CreditFacility {
  id String @id @default(cuid())

  // Facility info
  name   String
  type   String // revolving, term, overdraft, letter_of_credit, guarantee, factoring
  status String @default("active") // active, frozen, expired, cancelled

  // Lender
  lenderName String
  lenderId   String?

  // Amounts
  currency         String  @default("EUR")
  facilityLimit    Decimal @db.Decimal(15, 2)
  drawnAmount      Decimal @default(0) @db.Decimal(15, 2)
  availableAmount  Decimal @db.Decimal(15, 2)
  pendingDrawdowns Decimal @default(0) @db.Decimal(15, 2)

  // Utilization
  utilizationRate  Decimal  @default(0) @db.Decimal(5, 2)
  utilizationAlert Decimal? @db.Decimal(5, 2) // Alert threshold %

  // Interest
  interestRate Decimal? @db.Decimal(5, 4)
  interestType String? // fixed, variable, prime_plus
  spreadBps    Int? // Basis points over base rate

  // Fees
  commitmentFeeBps Int?
  arrangementFee   Decimal? @db.Decimal(15, 2)

  // Dates
  startDate      DateTime
  maturityDate   DateTime
  nextReviewDate DateTime?

  // Covenants
  covenants      Json? // Array of covenant objects
  covenantStatus String @default("compliant") // compliant, warning, breach

  // Security
  isSecured           Boolean @default(false)
  securityDescription String?

  // Meta
  reference String?
  notes     String? @db.Text
  documents Json?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Drawdowns
  drawdowns FacilityDrawdown[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, type])
  @@index([organizationId, status])
  @@index([organizationId, maturityDate])
}

model FacilityDrawdown {
  id String @id @default(cuid())

  // Drawdown details
  amount       Decimal  @db.Decimal(15, 2)
  currency     String   @default("EUR")
  drawdownDate DateTime

  // Repayment
  repaidAmount      Decimal @default(0) @db.Decimal(15, 2)
  outstandingAmount Decimal @db.Decimal(15, 2)

  // Status
  status String @default("active") // pending, active, repaid

  // Interest
  interestRate    Decimal? @db.Decimal(5, 4)
  accruedInterest Decimal  @default(0) @db.Decimal(15, 2)

  // Dates
  maturityDate DateTime?

  // Reference
  reference String?
  purpose   String?
  notes     String?

  // Relations
  facilityId String
  facility   CreditFacility @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([facilityId, status])
}

model TreasuryDecision {
  id String @id @default(cuid())

  // Decision info
  type        String // rebalance, drawdown, repayment, investment, transfer, fx_hedge, reserve_allocation
  title       String
  description String? @db.Text

  // Status
  status   String @default("pending") // pending, approved, rejected, executed, cancelled, expired
  priority String @default("normal") // low, normal, high, urgent

  // Amounts
  currency String  @default("EUR")
  amount   Decimal @db.Decimal(15, 2)

  // Impact
  riskDelta Json? // Risk impact assessment

  // Approval
  requiresApproval  Boolean   @default(true)
  approvalThreshold Decimal?  @db.Decimal(15, 2)
  approvedBy        String?
  approvedAt        DateTime?
  rejectedBy        String?
  rejectedAt        DateTime?
  rejectionReason   String?

  // Execution
  executionMode  String    @default("manual") // manual, scheduled, auto
  scheduledDate  DateTime?
  executedAt     DateTime?
  executedBy     String?
  executionNotes String?

  // Expiry
  expiresAt DateTime?

  // Linked entities
  sourceAccountId String?
  targetAccountId String?
  facilityId      String?
  bucketId        String?

  // Alternatives
  alternatives Json? // Alternative options considered

  // Meta
  notes    String? @db.Text
  metadata Json?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, status])
  @@index([organizationId, type])
  @@index([organizationId, priority])
}

model TreasuryScenario {
  id String @id @default(cuid())

  // Scenario info
  name        String
  type        String // baseline, best_case, worst_case, stress_test, custom
  description String? @db.Text

  // Status
  isActive   Boolean @default(true)
  isBaseline Boolean @default(false)

  // Assumptions
  assumptions Json // Key assumptions

  // Time horizon
  horizonDays Int      @default(90)
  startDate   DateTime @default(now())
  endDate     DateTime

  // Results
  results            Json? // Calculated results
  cashFlowProjection Json? // Day-by-day projection

  // Key metrics
  minimumCashDate   DateTime?
  minimumCashAmount Decimal?  @db.Decimal(15, 2)
  endingCashAmount  Decimal?  @db.Decimal(15, 2)

  // Risk
  probabilityWeight Decimal? @db.Decimal(5, 2) // For weighted scenarios
  riskScore         Decimal? @db.Decimal(5, 2)

  // Meta
  createdBy String?
  notes     String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, type])
  @@index([organizationId, isActive])
}

model TreasuryCashMovement {
  id String @id @default(cuid())

  // Movement info
  type     String // inflow, outflow, transfer_in, transfer_out, interest, fee
  category String? // operating, financing, investing

  // Amounts
  amount   Decimal @db.Decimal(15, 2)
  currency String  @default("EUR")

  // Balances
  balanceBefore Decimal @db.Decimal(15, 2)
  balanceAfter  Decimal @db.Decimal(15, 2)

  // Dates
  movementDate DateTime  @default(now())
  valueDate    DateTime?

  // Reference
  description  String
  reference    String?
  counterparty String?

  // Status
  status String @default("completed") // pending, completed, failed, reversed

  // Linked entities
  transactionId String?
  decisionId    String?

  // Relations
  accountId String
  account   TreasuryAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([accountId, movementDate])
  @@index([accountId, type])
}

model NettingOpportunity {
  id String @id @default(cuid())

  // Parties
  entityAId   String
  entityAName String
  entityBId   String
  entityBName String

  // Amounts
  currency     String  @default("EUR")
  amountAToB   Decimal @db.Decimal(15, 2)
  amountBToA   Decimal @db.Decimal(15, 2)
  netAmount    Decimal @db.Decimal(15, 2)
  netDirection String // a_to_b, b_to_a

  // Savings
  grossAmount    Decimal @db.Decimal(15, 2)
  savingsAmount  Decimal @db.Decimal(15, 2)
  savingsPercent Decimal @db.Decimal(5, 2)

  // Status
  status String @default("identified") // identified, approved, executed, expired

  // Execution
  executedAt DateTime?
  executedBy String?

  // Validity
  validUntil DateTime

  // Meta
  notes String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, status])
}

// =============================================================================
// ASSETS
// =============================================================================

model Asset {
  id String @id @default(cuid())

  // Identification
  assetNumber String
  name        String
  description String? @db.Text

  // Classification
  category    String // property_plant_equipment, intangible, financial, right_of_use, investment_property, biological, other
  subcategory String?
  assetClass  String? // buildings, machinery, vehicles, furniture, software, patents, etc.

  // Status
  status String @default("active") // draft, active, fully_depreciated, impaired, disposed, written_off

  // Acquisition
  acquisitionDate DateTime
  acquisitionType String   @default("purchase") // purchase, lease, construction, donation, transfer, merger
  acquisitionCost Decimal  @db.Decimal(15, 2)
  currency        String   @default("EUR")

  // Vendor/Source
  vendorId         String?
  vendorName       String?
  purchaseOrderRef String?
  invoiceRef       String?

  // Current Values
  currentBookValue Decimal  @db.Decimal(15, 2)
  fairValue        Decimal? @db.Decimal(15, 2)
  residualValue    Decimal  @default(0) @db.Decimal(15, 2)

  // Depreciation
  isDepreciable      Boolean  @default(true)
  depreciationMethod String   @default("straight_line") // straight_line, declining_balance, units_of_production, sum_of_years
  usefulLifeMonths   Int?
  usefulLifeUnits    Int? // For units of production
  depreciationRate   Decimal? @db.Decimal(5, 2) // For declining balance %

  // Accumulated values
  accumulatedDepreciation Decimal @default(0) @db.Decimal(15, 2)
  accumulatedImpairment   Decimal @default(0) @db.Decimal(15, 2)

  // Depreciation tracking
  depreciationStartDate DateTime?
  lastDepreciationDate  DateTime?
  nextDepreciationDate  DateTime?
  monthlyDepreciation   Decimal?  @db.Decimal(15, 2)

  // Location & Responsibility
  locationId         String?
  locationName       String?
  locationAddress    String?
  costCenterId       String?
  costCenterName     String?
  responsibleParty   String?
  responsiblePartyId String?

  // Entity ownership
  entityId   String?
  entityName String?

  // Physical attributes
  serialNumber String?
  modelNumber  String?
  manufacturer String?
  barcode      String?

  // Quantity (for group assets)
  quantity      Int    @default(1)
  unitOfMeasure String @default("pcs")

  // Insurance
  isInsured       Boolean   @default(false)
  insurancePolicy String?
  insuredValue    Decimal?  @db.Decimal(15, 2)
  insuranceExpiry DateTime?

  // Warranty
  warrantyExpiry DateTime?
  warrantyTerms  String?

  // Maintenance
  requiresMaintenance Boolean   @default(false)
  maintenanceSchedule String? // monthly, quarterly, annually
  lastMaintenanceDate DateTime?
  nextMaintenanceDate DateTime?

  // Disposal planning
  plannedDisposalDate DateTime?
  disposalMethod      String? // sale, scrap, donation, trade_in

  // Revaluation
  lastRevaluationDate DateTime?
  revaluationSurplus  Decimal   @default(0) @db.Decimal(15, 2)

  // Component accounting
  isComponent   Boolean @default(false)
  parentAssetId String?
  parentAsset   Asset?  @relation("AssetComponents", fields: [parentAssetId], references: [id])
  components    Asset[] @relation("AssetComponents")

  // Meta
  tags         String[]
  notes        String?  @db.Text
  attachments  Json? // Document references
  customFields Json? // Flexible additional fields

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Related records
  depreciationEntries AssetDepreciation[]
  events              AssetEvent[]
  transfers           AssetTransfer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, assetNumber])
  @@index([organizationId, status])
  @@index([organizationId, category])
  @@index([organizationId, entityId])
  @@index([organizationId, costCenterId])
  @@index([organizationId, locationId])
}

model AssetDepreciation {
  id String @id @default(cuid())

  // Period
  periodStart  DateTime
  periodEnd    DateTime
  fiscalYear   Int
  fiscalPeriod String? // M01-M12 or Q1-Q4

  // Amounts
  depreciationAmount      Decimal @db.Decimal(15, 2)
  accumulatedDepreciation Decimal @db.Decimal(15, 2)
  openingBookValue        Decimal @db.Decimal(15, 2)
  closingBookValue        Decimal @db.Decimal(15, 2)

  // Method used
  method String
  rate   Decimal? @db.Decimal(5, 2)

  // Status
  status String @default("calculated") // calculated, posted, reversed

  // Ledger reference
  journalEntryId String?
  postedAt       DateTime?
  postedBy       String?

  // Book type (for multi-book)
  bookType String @default("statutory") // statutory, tax, management, ifrs

  // Meta
  notes String?

  // Relations
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([assetId, periodStart])
  @@index([assetId, bookType])
  @@index([assetId, status])
}

model AssetEvent {
  id String @id @default(cuid())

  // Event type
  type String // acquisition, depreciation, impairment, revaluation, transfer, disposal, maintenance, insurance_update, write_off, component_added, component_removed

  // Details
  description String

  // Financial impact
  amount        Decimal? @db.Decimal(15, 2)
  previousValue Decimal? @db.Decimal(15, 2)
  newValue      Decimal? @db.Decimal(15, 2)

  // Date
  eventDate     DateTime  @default(now())
  effectiveDate DateTime?

  // Reference
  referenceType String? // journal_entry, invoice, transfer_order, disposal_order
  referenceId   String?

  // Approval
  requiresApproval Boolean   @default(false)
  approvedBy       String?
  approvedAt       DateTime?

  // Meta
  performedBy String?
  notes       String?
  metadata    Json?

  // Relations
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([assetId, eventDate])
  @@index([assetId, type])
}

model AssetTransfer {
  id String @id @default(cuid())

  // Transfer details
  transferDate  DateTime
  effectiveDate DateTime
  transferType  String // location, cost_center, entity, responsibility

  // From
  fromEntityId         String?
  fromEntityName       String?
  fromCostCenterId     String?
  fromCostCenterName   String?
  fromLocationId       String?
  fromLocationName     String?
  fromResponsibleParty String?

  // To
  toEntityId         String?
  toEntityName       String?
  toCostCenterId     String?
  toCostCenterName   String?
  toLocationId       String?
  toLocationName     String?
  toResponsibleParty String?

  // Values at transfer
  bookValueAtTransfer      Decimal @db.Decimal(15, 2)
  accumulatedDepAtTransfer Decimal @db.Decimal(15, 2)

  // Status
  status String @default("completed") // pending, approved, completed, cancelled

  // Approval
  requestedBy String?
  requestedAt DateTime  @default(now())
  approvedBy  String?
  approvedAt  DateTime?

  // Reason
  reason String?
  notes  String?

  // Relations
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([assetId, transferDate])
}

model AssetDisposal {
  id String @id @default(cuid())

  // Disposal info
  disposalDate DateTime
  disposalType String // sale, scrap, donation, theft, destruction, trade_in, write_off, other

  // Values
  carryingAmount          Decimal @db.Decimal(15, 2)
  accumulatedDepreciation Decimal @db.Decimal(15, 2)

  // Sale details
  salePrice      Decimal? @db.Decimal(15, 2)
  saleCurrency   String   @default("EUR")
  buyerName      String?
  buyerReference String?
  invoiceId      String?

  // Gain/Loss
  gainOrLoss Decimal @db.Decimal(15, 2)
  isGain     Boolean @default(false)

  // Costs
  disposalCosts Decimal @default(0) @db.Decimal(15, 2)

  // Tax
  taxAmount    Decimal? @db.Decimal(15, 2)
  taxTreatment String?

  // Status
  status String @default("completed") // pending, approved, completed, reversed

  // Approval
  reason     String
  approvedBy String?
  approvedAt DateTime?

  // Ledger
  journalEntryId String?

  // Meta
  notes       String? @db.Text
  attachments Json?

  // Relations
  assetId        String       @unique
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, disposalDate])
  @@index([organizationId, disposalType])
}

model CapExBudget {
  id String @id @default(cuid())

  // Budget info
  name        String
  fiscalYear  String
  description String?

  // Scope
  entityId     String?
  entityName   String?
  projectId    String?
  projectName  String?
  costCenterId String?

  // Amounts
  currency        String  @default("EUR")
  budgetAmount    Decimal @db.Decimal(15, 2)
  committedAmount Decimal @default(0) @db.Decimal(15, 2)
  spentAmount     Decimal @default(0) @db.Decimal(15, 2)
  remainingAmount Decimal @db.Decimal(15, 2)

  // Status
  status             String  @default("active") // draft, active, closed, overspent
  utilizationPercent Decimal @default(0) @db.Decimal(5, 2)

  // Approval
  approvedBy String?
  approvedAt DateTime?

  // Meta
  notes String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Items
  items CapExItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, fiscalYear])
  @@index([organizationId, status])
}

model CapExItem {
  id String @id @default(cuid())

  // Item info
  description String
  category    String?

  // Amounts
  estimatedAmount Decimal  @db.Decimal(15, 2)
  actualAmount    Decimal? @db.Decimal(15, 2)
  variance        Decimal? @db.Decimal(15, 2)

  // Status
  status String @default("planned") // planned, approved, committed, spent, cancelled

  // Classification
  classification       String  @default("capex") // capex, opex, borderline
  classificationReason String?

  // Linked asset
  assetId String?

  // Approval
  approvedBy String?
  approvedAt DateTime?

  // Timing
  plannedDate DateTime?
  actualDate  DateTime?

  // Meta
  notes String?

  // Relations
  budgetId String
  budget   CapExBudget @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([budgetId, status])
}

// =============================================================================
// PROJECTS & COST CENTERS
// =============================================================================
// ADD THIS TO: prisma/schema.prisma (append before closing)
// THEN RUN: npx prisma migrate dev --name add_projects_module

model CostCenter {
  id String @id @default(cuid())

  // Identification
  code        String
  name        String
  description String? @db.Text

  // Hierarchy
  parentId String?
  parent   CostCenter?  @relation("CostCenterHierarchy", fields: [parentId], references: [id])
  children CostCenter[] @relation("CostCenterHierarchy")
  level    Int          @default(0)
  path     String? // e.g., "CC001/CC001-A/CC001-A-1"

  // Manager
  managerId   String?
  managerName String?

  // Budget
  annualBudget      Decimal @default(0) @db.Decimal(15, 2)
  budgetSpent       Decimal @default(0) @db.Decimal(15, 2)
  budgetRemaining   Decimal @default(0) @db.Decimal(15, 2)
  budgetUtilization Decimal @default(0) @db.Decimal(5, 2)
  currency          String  @default("EUR")

  // Allocation
  allocationMethod String  @default("direct") // direct, percentage, hours, headcount, revenue, custom
  allocationBasis  String?

  // Status
  isActive      Boolean   @default(true)
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  // Meta
  tags String[]

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Related
  projects        Project[]
  timeEntries     TimeEntry[]
  chargebacksFrom InternalChargeback[] @relation("ChargebackFrom")
  chargebacksTo   InternalChargeback[] @relation("ChargebackTo")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, code])
  @@index([organizationId, isActive])
  @@index([organizationId, parentId])
}

model Project {
  id String @id @default(cuid())

  // Identification
  code        String
  name        String
  description String? @db.Text

  // Classification
  type     String @default("internal") // internal, client, rd, capex, opex, maintenance
  status   String @default("planning") // planning, active, on_hold, completed, cancelled, archived
  priority String @default("medium") // low, medium, high, critical

  // Ownership
  ownerId        String?
  ownerName      String?
  costCenterId   String?
  costCenter     CostCenter? @relation(fields: [costCenterId], references: [id])
  costCenterCode String?
  departmentId   String?
  clientId       String?
  clientName     String?

  // Timeline
  plannedStartDate DateTime
  plannedEndDate   DateTime
  actualStartDate  DateTime?
  actualEndDate    DateTime?

  // Budget & Financials
  budgetType        String  @default("fixed") // fixed, time_materials, retainer, milestone
  budgetAmount      Decimal @default(0) @db.Decimal(15, 2)
  budgetSpent       Decimal @default(0) @db.Decimal(15, 2)
  budgetRemaining   Decimal @default(0) @db.Decimal(15, 2)
  budgetVariance    Decimal @default(0) @db.Decimal(15, 2)
  budgetUtilization Decimal @default(0) @db.Decimal(5, 2)
  currency          String  @default("EUR")

  // Revenue (for client projects)
  contractValue   Decimal? @db.Decimal(15, 2)
  billedAmount    Decimal  @default(0) @db.Decimal(15, 2)
  collectedAmount Decimal  @default(0) @db.Decimal(15, 2)
  unbilledAmount  Decimal  @default(0) @db.Decimal(15, 2)

  // Profitability
  totalRevenue Decimal @default(0) @db.Decimal(15, 2)
  totalCosts   Decimal @default(0) @db.Decimal(15, 2)
  grossProfit  Decimal @default(0) @db.Decimal(15, 2)
  grossMargin  Decimal @default(0) @db.Decimal(5, 2)
  netProfit    Decimal @default(0) @db.Decimal(15, 2)
  netMargin    Decimal @default(0) @db.Decimal(5, 2)

  // Resources
  allocatedHours Decimal  @default(0) @db.Decimal(10, 2)
  actualHours    Decimal  @default(0) @db.Decimal(10, 2)
  remainingHours Decimal  @default(0) @db.Decimal(10, 2)
  hourlyRate     Decimal? @db.Decimal(10, 2)

  // Progress
  percentComplete     Decimal @default(0) @db.Decimal(5, 2)
  milestoneCount      Int     @default(0)
  milestonesCompleted Int     @default(0)

  // Billing
  isBillable    Boolean  @default(false)
  billingRate   Decimal? @db.Decimal(10, 2)
  billingMethod String? // hourly, fixed, milestone, retainer

  // Meta
  tags String[]

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Related
  milestones  ProjectMilestone[]
  timeEntries TimeEntry[]
  chargebacks InternalChargeback[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, code])
  @@index([organizationId, status])
  @@index([organizationId, type])
  @@index([organizationId, costCenterId])
}

model ProjectMilestone {
  id String @id @default(cuid())

  // Details
  name        String
  description String? @db.Text

  // Timeline
  plannedDate DateTime
  actualDate  DateTime?

  // Status
  status          String  @default("pending") // pending, in_progress, completed, delayed, cancelled
  percentComplete Decimal @default(0) @db.Decimal(5, 2)

  // Billing
  isBillable    Boolean   @default(false)
  billingAmount Decimal?  @db.Decimal(15, 2)
  billedAt      DateTime?

  // Dependencies
  dependsOn String[] // milestone IDs

  // Relations
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId, status])
  @@index([projectId, plannedDate])
}

model TimeEntry {
  id String @id @default(cuid())

  // User
  userId   String
  userName String?

  // Project/Task
  projectId    String
  project      Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectCode  String?
  taskId       String?
  taskName     String?
  costCenterId String?
  costCenter   CostCenter? @relation(fields: [costCenterId], references: [id])

  // Time
  date      DateTime
  hours     Decimal  @db.Decimal(5, 2)
  startTime String?
  endTime   String?

  // Description
  description String
  category    String?

  // Billing
  isBillable     Boolean  @default(false)
  hourlyRate     Decimal? @db.Decimal(10, 2)
  billableAmount Decimal? @db.Decimal(15, 2)

  // Cost
  costRate   Decimal? @db.Decimal(10, 2)
  costAmount Decimal? @db.Decimal(15, 2)

  // Status
  status          String    @default("draft") // draft, submitted, approved, rejected, billed
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, userId])
  @@index([organizationId, projectId])
  @@index([organizationId, date])
  @@index([organizationId, status])
}

model InternalChargeback {
  id               String @id @default(cuid())
  chargebackNumber String

  // From/To Cost Centers
  fromCostCenterId   String
  fromCostCenter     CostCenter @relation("ChargebackFrom", fields: [fromCostCenterId], references: [id])
  fromCostCenterCode String?
  toCostCenterId     String
  toCostCenter       CostCenter @relation("ChargebackTo", fields: [toCostCenterId], references: [id])
  toCostCenterCode   String?

  // Project (optional)
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id])
  projectCode String?

  // Details
  date        DateTime
  description String
  category    String

  // Amount
  amount   Decimal @db.Decimal(15, 2)
  currency String  @default("EUR")

  // Basis
  allocationMethod String   @default("direct") // direct, percentage, hours, headcount, revenue, custom
  allocationBasis  String?
  quantity         Decimal? @db.Decimal(15, 4)
  unitRate         Decimal? @db.Decimal(15, 4)

  // Period
  periodStart DateTime
  periodEnd   DateTime

  // Status
  status          String    @default("pending") // pending, approved, rejected, billed, paid
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?

  // References
  invoiceId      String?
  journalEntryId String?

  // Meta
  notes     String? @db.Text
  createdBy String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, chargebackNumber])
  @@index([organizationId, status])
  @@index([organizationId, fromCostCenterId])
  @@index([organizationId, toCostCenterId])
  @@index([organizationId, date])
}

// =============================================================================
// PERIOD CLOSE MODULE
// =============================================================================
// ADD TO: prisma/schema.prisma (append at end)
// ADD TO Organization model relations:
//   accountingPeriods    AccountingPeriod[]
//   periodAdjustments    PeriodAdjustment[]
// THEN RUN: npx prisma migrate dev --name add_period_close_module

model AccountingPeriod {
  id   String @id @default(cuid())
  name String
  code String // e.g., "2024-01", "2024-Q1", "2024"

  // Type & Dates
  type          String   @default("monthly") // monthly, quarterly, yearly, custom
  startDate     DateTime
  endDate       DateTime
  fiscalYear    Int
  fiscalQuarter Int?
  fiscalMonth   Int?

  // Status
  status       String    @default("open") // open, closing, closed, locked, reopened
  closedAt     DateTime?
  closedBy     String?
  reopenedAt   DateTime?
  reopenedBy   String?
  reopenReason String?   @db.Text

  // Checklist Progress
  checklistTotal     Int     @default(0)
  checklistCompleted Int     @default(0)
  checklistProgress  Decimal @default(0) @db.Decimal(5, 2)

  // Flags
  hasUnreconciledItems     Boolean @default(false)
  hasPendingTransactions   Boolean @default(false)
  hasMissingDocuments      Boolean @default(false)
  hasUnapprovedAdjustments Boolean @default(false)

  // Financials (snapshot at close)
  totalRevenue     Decimal? @db.Decimal(15, 2)
  totalExpenses    Decimal? @db.Decimal(15, 2)
  netIncome        Decimal? @db.Decimal(15, 2)
  totalAssets      Decimal? @db.Decimal(15, 2)
  totalLiabilities Decimal? @db.Decimal(15, 2)

  // Meta
  notes String? @db.Text

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  checklistItems CloseChecklistItem[]
  missingItems   PeriodMissingItem[]
  adjustments    PeriodAdjustment[]
  auditEntries   PeriodAuditEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, code])
  @@index([organizationId, status])
  @@index([organizationId, fiscalYear])
}

model CloseChecklistItem {
  id       String           @id @default(cuid())
  periodId String
  period   AccountingPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  // Item Details
  name        String
  description String? @db.Text
  category    String // reconciliation, review, adjustment, approval, documentation, system
  orderIndex  Int     @default(0)

  // Status
  status      String    @default("pending") // pending, in_progress, completed, skipped, blocked
  completedAt DateTime?
  completedBy String?

  // Requirements
  isRequired Boolean  @default(true)
  isCritical Boolean  @default(false)
  dependsOn  String[] // other checklist item IDs

  // Automation
  isAutomated     Boolean   @default(false)
  automationRule  String?
  lastAutoCheck   DateTime?
  autoCheckResult String? // pass, fail, warning

  // Evidence
  attachments String[]
  notes       String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([periodId, status])
  @@index([periodId, category])
}

model PeriodMissingItem {
  id       String           @id @default(cuid())
  periodId String
  period   AccountingPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  // Item Type
  type     String // document, reconciliation, approval, transaction, entry
  severity String @default("medium") // low, medium, high, critical

  // Details
  title             String
  description       String  @db.Text
  reference         String?
  relatedEntityType String?
  relatedEntityId   String?

  // Assignment
  assignedTo     String?
  assignedToName String?
  dueDate        DateTime?

  // Resolution
  status       String    @default("open") // open, in_progress, resolved, waived
  resolvedAt   DateTime?
  resolvedBy   String?
  resolution   String?   @db.Text
  waivedReason String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([periodId, status])
  @@index([periodId, severity])
}

model PeriodAdjustment {
  id               String           @id @default(cuid())
  adjustmentNumber String
  periodId         String
  period           AccountingPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  // Type
  type   String @default("accrual") // accrual, deferral, reclassification, correction, reversal, provision
  status String @default("draft") // draft, pending_approval, approved, posted, rejected

  // Details
  description String
  reason      String @db.Text

  // Amounts
  debitAccountId    String?
  debitAccountName  String?
  creditAccountId   String?
  creditAccountName String?
  amount            Decimal @db.Decimal(15, 2)
  currency          String  @default("EUR")

  // Effective Date
  effectiveDate DateTime

  // Reversal (for accruals)
  isReversing          Boolean   @default(false)
  reversalDate         DateTime?
  reversalPeriodId     String?
  originalAdjustmentId String?

  // Approval
  requestedBy     String?
  requestedByName String?
  approvedBy      String?
  approvedByName  String?
  approvedAt      DateTime?
  rejectedBy      String?
  rejectionReason String?   @db.Text

  // Posting
  postedAt       DateTime?
  journalEntryId String?

  // Documentation
  supportingDocuments String[]
  notes               String?  @db.Text

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, adjustmentNumber])
  @@index([periodId, status])
  @@index([periodId, type])
  @@index([organizationId, status])
}

model PeriodAuditEntry {
  id       String           @id @default(cuid())
  periodId String
  period   AccountingPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  // Action
  action      String // created, opened, checklist_updated, adjustment_posted, closing_started, closed, reopened, locked
  description String

  // User
  userId   String
  userName String?

  // Details
  previousStatus String?
  newStatus      String?
  metadata       Json?

  // IP/Session
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([periodId, createdAt])
  @@index([periodId, action])
}

// =============================================================================
// CUSTOMERS MODULE
// =============================================================================
// ADD TO: prisma/schema.prisma (append at end)
// ADD TO Organization model relations:
//   customers            Customer[]
//   customerPayments     CustomerPayment[]
//   customerCreditEvents CustomerCreditEvent[]
// THEN RUN: npx prisma migrate dev --name add_customers_module

model Customer {
  id             String @id @default(cuid())
  customerNumber String

  // Basic Info
  name     String
  type     String  @default("business") // individual, business, enterprise, government
  status   String  @default("active") // active, inactive, prospect, churned, suspended
  industry String?

  // Contact
  email   String?
  phone   String?
  website String?
  address Json? // { street, city, state, postalCode, country }

  // Tax & Legal
  taxId          String?
  vatNumber      String?
  legalName      String?
  classification String? // For tax purposes

  // Credit Management
  creditLimit     Decimal @default(0) @db.Decimal(15, 2)
  creditUsed      Decimal @default(0) @db.Decimal(15, 2)
  creditAvailable Decimal @default(0) @db.Decimal(15, 2)
  creditStatus    String  @default("good") // good, warning, hold, blocked
  paymentTerms    String  @default("Net 30")

  // Payment Behavior
  paymentBehavior      String   @default("good") // excellent, good, fair, poor, delinquent
  averageDaysToPayment Int?
  onTimePaymentRate    Decimal? @db.Decimal(5, 2)

  // Risk Assessment
  riskLevel String @default("low") // low, medium, high, critical
  riskScore Int    @default(0)

  // Financial Summary
  totalRevenue       Decimal @default(0) @db.Decimal(15, 2)
  totalOrders        Int     @default(0)
  averageOrderValue  Decimal @default(0) @db.Decimal(15, 2)
  outstandingBalance Decimal @default(0) @db.Decimal(15, 2)
  overdueAmount      Decimal @default(0) @db.Decimal(15, 2)
  currency           String  @default("EUR")

  // Relationship
  customerSince      DateTime  @default(now())
  lastOrderDate      DateTime?
  lastPaymentDate    DateTime?
  lastContactDate    DateTime?
  accountManagerId   String?
  accountManagerName String?

  // Preferences
  preferredPaymentMethod String?
  preferredLanguage      String  @default("en")
  invoiceDelivery        String  @default("email") // email, mail, portal

  // Meta
  tags  String[]
  notes String?  @db.Text

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  contacts       CustomerContact[]
  payments       CustomerPayment[]
  creditEvents   CustomerCreditEvent[]
  revenueRecords CustomerRevenue[]
  riskIndicators CustomerRiskIndicator[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, customerNumber])
  @@index([organizationId, status])
  @@index([organizationId, type])
  @@index([organizationId, riskLevel])
  @@index([organizationId, creditStatus])
}

model CustomerContact {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Contact Info
  name  String
  title String?
  email String
  phone String?

  // Role
  isPrimary Boolean @default(false)
  role      String  @default("general") // billing, technical, executive, purchasing, general

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
}

model CustomerPayment {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Reference
  invoiceId     String?
  invoiceNumber String?

  // Amount
  amount   Decimal @db.Decimal(15, 2)
  currency String  @default("EUR")

  // Dates
  invoiceDate DateTime
  dueDate     DateTime
  paymentDate DateTime?

  // Status
  status        String @default("pending") // pending, paid, partial, overdue, written_off
  daysToPayment Int?
  daysOverdue   Int?

  // Payment Details
  paymentMethod   String?
  referenceNumber String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([customerId, status])
  @@index([organizationId, status])
}

model CustomerCreditEvent {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Event Type
  type String // limit_increase, limit_decrease, status_change, review, terms_change

  // Details
  previousValue String?
  newValue      String
  reason        String

  // User
  changedBy     String?
  changedByName String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([customerId, createdAt])
}

model CustomerRevenue {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Period
  period     String // e.g., "2024-01", "2024-Q1"
  periodType String // monthly, quarterly, yearly

  // Amounts
  revenue Decimal  @db.Decimal(15, 2)
  cost    Decimal? @db.Decimal(15, 2)
  profit  Decimal? @db.Decimal(15, 2)
  margin  Decimal? @db.Decimal(5, 2)

  // Orders
  orderCount        Int
  averageOrderValue Decimal @db.Decimal(15, 2)

  createdAt DateTime @default(now())

  @@unique([customerId, period, periodType])
  @@index([customerId, periodType])
}

model CustomerRiskIndicator {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Indicator
  category    String // payment, credit, activity, financial, external
  indicator   String
  description String

  // Severity
  severity String @default("medium") // low, medium, high, critical
  score    Int    @default(0)

  // Status
  status     String    @default("active") // active, resolved, monitoring
  detectedAt DateTime  @default(now())
  resolvedAt DateTime?

  // Actions
  recommendedAction String?
  actionTaken       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId, status])
  @@index([customerId, severity])
}
